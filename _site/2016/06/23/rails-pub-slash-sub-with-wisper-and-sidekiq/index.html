
<!doctype html>
<!-- START OF _layouts/default.html -->
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible" >
		<meta content="width=device-width,initial-scale=1" name="viewport">
		<meta content="Andrew Hao's thoughts on software engineering, team leadership & product design." name="description">
		<meta content="The Sweet Spot" name="author">

		<title>Evented Rails: Decoupling domains in Rails with Wisper pub/sub events &mdash; The Sweet Spot</title>

		<!-- Styles -->
		<link href="/stylesheets/main.css" rel="stylesheet">

		<!-- Google webfonts -->
    <link href="https://fonts.googleapis.com/css?family=Cousine|Suez+One|Yellowtail|Space+Mono|Alike+Angular" rel="stylesheet">

		<!-- jQuery and plugins -->
		<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
		<script src="/js/jquery.zclip.min.js"></script>

		<!-- Syntax highlighter -->
		<link href="/stylesheets/prettify-hemisu.css" type="text/css" rel="stylesheet" />
    <script type="text/javascript" src="/js/prettify.js"></script>

    <link href="" rel="alternate" title="The Sweet Spot" type="application/atom+xml">
    


  </head>

	<body onload="prettyPrint()">
		<div class="wrap">

			<header>
        <a href="/"><div class="title">The Sweet Spot</div></a>
				<div class="subtitle">On software, engineering leadership, and anything shiny.</div>

				<div class="navi">
					<ul>
						<li><a href="/">Articles</a></li>
						<li><a href="/talks">Talks</a></li>
						<li><a href="/notes">Conference Notes</a></li>
						<li><a href="https://www.github.com/andrewhao">Github</a></li>
						<li><a href="https://twitter.com/andrewhao">Twitter</a></li>
					</ul>
				</div> <!-- // .navi -->
			</header>

				<!-- START OF _layouts/post.html -->

<!-- START OF _includes/article.html -->
<article>
	<header>
		<h1><a href="/2016/06/23/rails-pub-slash-sub-with-wisper-and-sidekiq/">Evented Rails: Decoupling domains in Rails with Wisper pub/sub events</a></h1>
		<time>23 June 2016</time>
	</header>
		<div class="content">
			<p>One common pattern in Domain-Driven Design is the use of publish/subscribe messaging to communicate between domains. When <a href="http://martinfowler.com/eaaDev/DomainEvent.html">Domain Events</a> are created from within a domain, other domains are able to subscribe to these events and take action within their own domains, respectively.</p>

<p>This is not a common pattern in Rails, particularly because of Ruby’s lack of language support for functional programming paradigms that exist in other languages. However, with a nifty framework and the help of Sidekiq, we can get just a little bit closer.</p>

<h3 id="what-is-a-domain-event">What is a Domain Event?</h3>

<p>A domain event is a recorded property in the system that tracks an action that the system performs, and the factors/properties that lead to its creation.</p>

<p>In the following examples, we are going to use the <a href="https://github.com/krisleech/wisper">Wisper</a> gem to implement domain events in our sample <a href="http://github.com/andrewhao/delorean">Delorean</a> app.</p>

<p>Imagine that we are writing an endpoint that our users will hit, indicating that they want to hail a time-traveling cab. Now the logic to hail a cab is rather complicated and lives in an entirely different area of the codebase, perhaps even in another application. How should we call the other code and ensure that our code is cleanly decoupled?</p>

<p>With our Domain-Driven powers, we’ve been smart enough to segregate our code into different subdomains and bounded contexts, denoted by these two Ruby modules <code class="highlighter-rouge">Ridesharing</code> and <code class="highlighter-rouge">DriverRouting</code>.</p>

<h2 id="example-1-in-process-pub-sub-event-modeling-with-a-service-object">Example 1: In-process pub-sub event modeling, with a service object.</h2>

<p>A simple way to use Wisper is to use it to implement your service objects with Wisper, calling the service from the controller.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="nn">Ridesharing</span>
  <span class="k">class</span> <span class="nc">RidesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
    <span class="k">def</span> <span class="nf">post</span>
      <span class="c1"># Hail a time-traveling Delorean:</span>
      <span class="n">command</span> <span class="o">=</span> <span class="no">HailDelorean</span><span class="p">.</span><span class="nf">new</span>
      <span class="n">command</span><span class="p">.</span><span class="nf">on</span><span class="p">(</span><span class="s1">'hailed'</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">driver</span><span class="o">|</span>
        <span class="n">render</span> <span class="ss">text: </span><span class="s2">"Hailed you a cab: </span><span class="si">#{</span><span class="n">driver</span><span class="si">}</span><span class="s2"> is arriving!"</span>
      <span class="p">}</span>
      <span class="p">.</span><span class="nf">on</span><span class="p">(</span><span class="s1">'could_not_hail'</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">render</span> <span class="ss">text: </span><span class="s2">"Sorry, no dice."</span>
      <span class="p">}</span>
      <span class="n">command</span><span class="p">.</span><span class="nf">hail!</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Note that the <code class="highlighter-rouge">HailDelorean</code> class has powers of event subscriptions now. Our calling code does not have to concern itself with the implementation details of the <code class="highlighter-rouge">HailDelorean</code> service - it merely needs to register handlers for the two possible outcomes, <code class="highlighter-rouge">hailed</code> and <code class="highlighter-rouge">could_not_hail</code>. Here’s how the service class is implemented:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="nn">Ridesharing</span>
  <span class="k">class</span> <span class="nc">HailDelorean</span>
    <span class="kp">include</span> <span class="no">Wisper</span><span class="o">::</span><span class="no">Publisher</span>

    <span class="k">def</span> <span class="nf">hail!</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
      <span class="c1"># broadcast() is a Wisper method to fire an event</span>
      <span class="n">driver</span> <span class="o">=</span> <span class="n">find_driver</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">driver</span>
        <span class="n">broadcast</span><span class="p">(</span><span class="s1">'hailed'</span><span class="p">,</span> <span class="n">driver</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="n">broadcast</span><span class="p">(</span><span class="s1">'could_not_hail'</span><span class="p">)</span>
      <span class="k">end</span>

    <span class="k">def</span> <span class="nf">find_driver</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
      <span class="c1"># Here lies slow, complex domain logic</span>
      <span class="no">DriverRouting</span><span class="o">::</span><span class="no">FindDriver</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="handling-side-effects-in-subscriber-classes">Handling side effects in subscriber classes</h3>

<p>Other side-effects can subscribe to the <code class="highlighter-rouge">HailDelorean</code> events. Let’s say we want to fire an event to Segment analytics tracking. I can create a plain Ruby object that simply needs to implement a method with the same name as the event.</p>

<p>Let’s implement <code class="highlighter-rouge">hailed</code> and <code class="highlighter-rouge">could_not_hail</code> methods on this subscriber class:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">TrackSegmentAnalytics</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">hailed</span><span class="p">(</span><span class="n">driver</span><span class="p">)</span>
    <span class="c1"># fire analytics event to Segment</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">could_not_hail</span>
    <span class="c1"># fire analytics event to Segment</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>And we hook it up by subscribing it to the command handler:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="nn">Ridesharing</span>
  <span class="k">class</span> <span class="nc">RidesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
    <span class="k">def</span> <span class="nf">post</span>
      <span class="c1"># snip</span>
      <span class="n">command</span> <span class="o">=</span> <span class="no">HailDelorean</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span>

      <span class="c1"># register the subscriber to the triggering action</span>
      <span class="n">command</span><span class="p">.</span><span class="nf">subscribe</span><span class="p">(</span><span class="no">TrackSegmentAnalytics</span><span class="p">)</span>
      <span class="c1"># snip</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>OK, that was a little awkward, doing all that wiring up in the controller. What if we did the wiring globally, within an app initializer?</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># config/initializers/domain_event_subscriptions.rb</span>
<span class="no">Wisper</span><span class="p">.</span><span class="nf">subscribe</span><span class="p">(</span><span class="no">TrackSegmentAnalytics</span><span class="p">,</span> <span class="ss">scope: </span><span class="s2">"HailDelorean"</span><span class="p">)</span>

<span class="c1"># alternate form:</span>
<span class="no">HailDelorean</span><span class="p">.</span><span class="nf">subscribe</span><span class="p">(</span><span class="no">TrackSegmentAnalytics</span><span class="p">)</span>
</code></pre></div></div>

<p>This registers a global subscriber for all future instances of <code class="highlighter-rouge">HailDelorean</code>.</p>

<h2 id="example-2-asynchronous-events-with-subscription-handlers-and-sidekiq">Example 2: Asynchronous events with subscription handlers and Sidekiq</h2>

<p>Here’s the real power of Wisper - we can decouple our application domain responsibilities by modeling effects as subscription objects and do them out-of-band of the primary web request thread.</p>

<p>Note that with the <a href="https://github.com/krisleech/wisper-sidekiq"><code class="highlighter-rouge">wisper-sidekiq</code></a> gem, all subscriptions given with an <code class="highlighter-rouge">async: true</code> option flag will automatically execute in an external thread as a Sidekiq job. Let’s take advantage of that now.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="nn">Ridesharing</span>
  <span class="k">class</span> <span class="nc">RidesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
    <span class="k">def</span> <span class="nf">post</span>
      <span class="c1"># Hail a time-traveling Delorean:</span>
      <span class="no">HailDelorean</span><span class="p">.</span><span class="nf">hail</span><span class="p">(</span><span class="n">current_user</span><span class="p">.</span><span class="nf">id</span><span class="p">)</span>
      <span class="n">render</span> <span class="ss">text: </span><span class="s1">'Hailing a cab, please wait for a response...'</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="nc">HailDelorean</span>
    <span class="kp">include</span> <span class="no">Wisper</span><span class="o">::</span><span class="no">Broadcaster</span>

    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">hail</span><span class="p">(</span><span class="n">passenger_id</span><span class="p">)</span>
      <span class="n">broadcast</span><span class="p">(</span><span class="ss">:hail</span><span class="p">,</span> <span class="n">passenger_id</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">module</span> <span class="nn">DriverRouting</span>
  <span class="c1"># Note that this class is both a subscriber and a publisher</span>
  <span class="k">class</span> <span class="nc">FindDriver</span>
    <span class="kp">include</span> <span class="no">Wisper</span><span class="o">::</span><span class="no">Publisher</span>

    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">hail</span><span class="p">(</span><span class="n">passenger_id</span><span class="p">)</span>
      <span class="c1"># Do slow, complex hairy routefinding/optimization/messaging behind the scenes:</span>
      <span class="n">driver</span> <span class="o">=</span> <span class="n">find_driver_for</span><span class="p">(</span><span class="n">passenger_id</span><span class="p">)</span>

      <span class="k">if</span> <span class="n">driver</span>
        <span class="n">broadcast</span><span class="p">(</span><span class="s1">'driver_found'</span><span class="p">,</span> <span class="n">passenger_id</span><span class="p">,</span> <span class="n">driver</span><span class="p">.</span><span class="nf">id</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="n">broadcast</span><span class="p">(</span><span class="s1">'driver_not_found'</span><span class="p">,</span> <span class="n">passenger_id</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Finally, we add handlers (subscribers) to these domain objects:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="nn">Ridesharing</span>
  <span class="k">class</span> <span class="nc">NotifyPassengerWithDriverStatus</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">driver_found</span>
      <span class="c1"># send them a text message :)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">driver_not_found</span>
      <span class="c1"># send them a text message :(</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Now let’s link it together with subscriptions:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># config/initializers/domain_event_subscriptions.rb</span>
<span class="no">Ridesharing</span><span class="o">::</span><span class="no">HailDelorean</span><span class="p">.</span><span class="nf">subscribe</span><span class="p">(</span><span class="no">DriverRouting</span><span class="o">::</span><span class="no">FindDriver</span><span class="p">,</span> <span class="ss">async: </span><span class="kp">true</span><span class="p">)</span>
<span class="no">DriverRouting</span><span class="o">::</span><span class="no">FindDriver</span><span class="p">.</span><span class="nf">subscribe</span><span class="p">(</span><span class="no">Ridesharing</span><span class="o">::</span><span class="no">NotifyPassengerWithDriverStatus</span><span class="p">,</span> <span class="ss">async: </span><span class="kp">true</span><span class="p">)</span>
<span class="no">Wisper</span><span class="p">.</span><span class="nf">subscribe</span><span class="p">(</span><span class="no">AnalyticsListener</span><span class="p">,</span> <span class="ss">scope: </span><span class="s2">"Ridesharing::NotifyPassengerWithDriverStatus"</span><span class="p">,</span> <span class="s2">"DriverRouting::FindDriver"</span><span class="p">],</span> <span class="ss">async: </span><span class="kp">true</span><span class="p">)</span>
</code></pre></div></div>

<p>Now our messages between our domains are pulled out of the main request thread, and operate in an asynchronous fashion with Sidekiq as the runner.</p>

<p>Code in our domains are kept clean - note that there are no direct references to the other subdomains within each subdomain. Our app more cleanly segregates the responsibilities between each app, heavy workloads are naturally balanced as they move to worker threads.</p>

<h2 id="caveats-beware-of-overbuilding">Caveats: Beware of overbuilding</h2>

<p>If you are on a small app, you probably should go with approach #1. The weight of indirection can be a cognitive load on development, unless you truly need to build async code in #2. The overhead and conceptual complexities of the approach can only be justified with large codebases, or in apps where a domain-centric view (and segregation) of code is present.</p>

<h2 id="caveats-event-subscriptions-can-be-a-tangled-mess">Caveats: Event subscriptions can be a tangled mess</h2>

<p>Note that the act of wiring can quickly fan out into a spidery mess of handlers - you could even further decouple your handlers by modeling a global event bus as a publisher, and having each domain tap into the bus’ events and figure out how to handle each event on its own.</p>

<h2 id="caveats-transactional-consistency">Caveats: transactional consistency!</h2>

<p>If you implement this asynchronously, you’ll have to think about how to deal with transactional consistency. Can you design your data models (and database schema) to support independent updates without any dependencies? How will you handle the case when one domain action fails and the other completes?</p>

<p>You may have to roll your own two-phase commit here, the specifics of which I won’t delve into. However, for most of our applications, we may want to skip the asynchronous and keep our events synchronous.</p>

			
			
		</div>
	<footer>
		<div class="article__categories">
  Tagged under
  
  
  <a class="article__category" href="/category/domain-driven-design">Domain-Driven Design</a>
  , 
  
  <a class="article__category" href="/category/ddd">DDD</a>
  , 
  
  <a class="article__category" href="/category/pub-sub">pub/sub</a>
  , 
  
  <a class="article__category" href="/category/wisper">Wisper</a>
  
  
</div>

	
	
	</footer>
	
</article>
<!-- END OF _includes/article.html -->


  <section class="comments">
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>


<!-- END OF _/layouts/post.html -->


			<footer>
				Copyright &copy; 2018

	The Sweet Spot


				

<script type="text/javascript">
      var disqus_shortname = 'g9labs';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://localhost:4000/2016/06/23/rails-pub-slash-sub-with-wisper-and-sidekiq/';
        var disqus_url = 'http://localhost:4000/2016/06/23/rails-pub-slash-sub-with-wisper-and-sidekiq/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>











			</footer>

		</div> <!-- // .wrap -->
  </body>

	<script>
		$(document).ready(function() {
			// Make images center
			$('p:has(img)').css('text-align', 'center');

			// Add the image's title attribute as a caption
			$('p:has(img)').append(function () {
				return '<div class="caption">' + ($('img', this).attr('title') || "") + '</div>';
			});

			// Prettify code
			$('code').addClass('prettyprint');
			$('pre code').addClass('linenums');

			// Copy to clipboard with button
			$('pre:has(code)').prepend(function(){
				return '<div class="clip-btn">copy to clipboard</div>';
      });

			$('.clip-btn').zclip({
				path:'/js/ZeroClipboard.swf',
				copy: $(this).next('code').text(),
				afterCopy: function(){
					$(this).replaceWith('<div class="clip-btn">copied!');
					}
			});
		});
	</script>
</html>
<!-- END OF _layouts/default.html -->
