
<!doctype html>
<!-- START OF _layouts/default.html -->
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible" >
		<meta content="width=device-width,initial-scale=1" name="viewport">
		<meta content="Andrew Hao's thoughts on software engineering, team leadership & product design." name="description">
		<meta content="The Sweet Spot" name="author">

		<title>Running Mocha tests with ES6/AMD modules &mdash; The Sweet Spot</title>

		<!-- Styles -->
		<link href="/stylesheets/main.css" rel="stylesheet">

		<!-- Google webfonts -->
    <link href="https://fonts.googleapis.com/css?family=Cousine|Suez+One|Yellowtail|Space+Mono|Alike+Angular" rel="stylesheet">

		<!-- jQuery and plugins -->
		<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
		<script src="/js/jquery.zclip.min.js"></script>

		<!-- Syntax highlighter -->
		<link href="/stylesheets/prettify-hemisu.css" type="text/css" rel="stylesheet" />
    <script type="text/javascript" src="/js/prettify.js"></script>

    <link href="" rel="alternate" title="The Sweet Spot" type="application/atom+xml">
    


  </head>

	<body onload="prettyPrint()">
		<div class="wrap">

			<header>
        <a href="/"><div class="title">The Sweet Spot</div></a>
				<div class="subtitle">On software, engineering leadership, and anything shiny.</div>

				<div class="navi">
					<ul>
						<li><a href="/">Articles</a></li>
						<li><a href="/talks">Talks</a></li>
						<li><a href="/notes">Conference Notes</a></li>
						<li><a href="https://www.github.com/andrewhao">Github</a></li>
						<li><a href="https://twitter.com/andrewhao">Twitter</a></li>
					</ul>
				</div> <!-- // .navi -->
			</header>

				<!-- START OF _layouts/post.html -->

<!-- START OF _includes/article.html -->
<article>
	<header>
		<h1><a href="/2014/06/06/running-mocha-tests-with-es6-amd-modules/">Running Mocha tests with ES6/AMD modules</a></h1>
		<time>06 June 2014</time>
	</header>
		<div class="content">
			<p>In one of my personal projects (<a href="https://github.com/andrewhao/chordmeister">Chordmeister</a>), I’ve been trying to
upgrade the code to be written in <a href="http://wiki.ecmascript.org/doku.php?id=harmony:modules#export_declarations">ES6 modules</a> and transpile down to AMD modules with Square’s <a href="https://github.com/square/es6-module-transpiler">very excellent es6-module-transpiler project</a>.</p>

<p>Since I’ve already <a href="https://github.com/andrewhao/hendrix">updated</a> an Ember app of mine to try ES6, I figured it was high time to do it on another project.</p>

<h2 id="sorry-coffeescript-but-im-moving-on">Sorry Coffeescript, but I’m moving on.</h2>

<p>First problem: Coffeescript seems indecisive with respect to ES6
support. In order to support <code class="highlighter-rouge">import</code> or <code class="highlighter-rouge">export</code> keywords, I had to
wrap the statements in backticks, making the code look like this:</p>

<div class="language-coffeescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">`</span><span class="nx">import</span> <span class="nx">ClassifiedLine</span> <span class="nx">from</span> <span class="s">"chordmeister/classified_line"</span><span class="o">`</span>
<span class="k">class</span> <span class="nx">Parser</span>
  <span class="c1"># Implementation</span>

<span class="o">`</span><span class="nx">export</span> <span class="nx">default</span> <span class="nx">Parser</span><span class="o">`</span>
</code></pre></div></div>

<p>Except this wasn’t being picked up by es6-module-transpiler, since
Coffeescript wraps the entire declaration in a closure: I was
finding myself having problems compiling from Coffeescript -&gt; ES5 JS -&gt; ES6 JS.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">define</span><span class="p">(</span><span class="s2">"chordmeister/parser"</span><span class="p">,</span>
  <span class="p">[],</span>
  <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="s2">"use strict"</span><span class="p">;</span>
    <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="c1">// Oops, I wasn't transpiled!</span>
      <span class="k">import</span> <span class="nx">ClassifiedLine</span> <span class="k">from</span> <span class="s1">'chordmeister/classified_line'</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">Parser</span><span class="p">;</span>
      <span class="nx">Parser</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// Implementation</span>
      <span class="p">}</span>
      <span class="p">)();</span>
      <span class="c1">// Oops, I wasn't transpiled!</span>
      <span class="k">export</span> <span class="k">default</span> <span class="nx">Parser</span><span class="p">;</span>
      <span class="p">})()</span>
  <span class="p">});</span>

</code></pre></div></div>

<p>So the first call: ditch Coffeescript. Write this in pure ES6.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">ClassifiedLine</span> <span class="k">from</span> <span class="s1">'chordmeister/classified_line'</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">Parser</span><span class="p">;</span>

<span class="nx">Parser</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// implementation</span>
<span class="p">})();</span>

<span class="k">export</span> <span class="k">default</span> <span class="nx">Parser</span><span class="p">;</span>
</code></pre></div></div>

<p>Which transpiled nicely to:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">define</span><span class="p">(</span><span class="s2">"chordmeister/parser"</span><span class="p">,</span> 
  <span class="p">[</span><span class="s2">"chordmeister/classified_line"</span><span class="p">,</span><span class="s2">"exports"</span><span class="p">],</span>
  <span class="kd">function</span><span class="p">(</span><span class="nx">__dependency1__</span><span class="p">,</span> <span class="nx">__exports__</span><span class="p">)</span> <span class="p">{</span>
    <span class="s2">"use strict"</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">ClassifiedLine</span> <span class="o">=</span> <span class="nx">__dependency1__</span><span class="p">[</span><span class="s2">"default"</span><span class="p">];</span>
    <span class="kd">var</span> <span class="nx">Parser</span><span class="p">;</span>
    <span class="nx">Parser</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="c1">// Implementation</span>
    <span class="p">})();</span>
    <span class="nx">__exports__</span><span class="p">[</span><span class="s2">"default"</span><span class="p">]</span> <span class="o">=</span> <span class="nx">Parser</span><span class="p">;</span>
    <span class="p">});</span>
</code></pre></div></div>

<h2 id="next-up-adding-amd-support-in-mocha">Next up: adding AMD support in Mocha</h2>

<p>Okay, so we need to set up a few things to get Mocha playing well with RequireJS, the AMD loader.</p>

<p>Our plan of attach will be to leverage the generated AMD modules and load our tests up with them. We have the benefit of being able to specifically inject dependencies into our test suite.</p>

<p>The tricky parts will be:</p>

<h3 id="set-up-the-mocha-indexhtml-runner">Set up the Mocha index.html runner</h3>

<p>Install <code class="highlighter-rouge">mocha</code>, <code class="highlighter-rouge">require.js</code>, and <code class="highlighter-rouge">chai</code> via <code class="highlighter-rouge">bower</code>, then plug them into the harness:</p>

<p>``` html test/index.html
&lt;!doctype html&gt;</p>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <title>Mocha Spec Runner</title>
    <link rel="stylesheet" href="../bower_components/mocha/mocha.css" />
</head>
<body>
    <div id="mocha"></div>
    <script src="../bower_components/mocha/mocha.js"></script>
    <script src="../bower_components/chai/chai.js"></script>
    <script data-main="test_helper" src="../bower_components/requirejs/require.js"></script>

</body>
</html>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
Note the references to `data-main="test_helper"`, which is require.js's way of determining its entry point after it loads.

### Set up a test runner.

``` javascript test/test_runner.js
// Configure and set up the tests.
require.config({
  baseUrl: "../build/"
})

// Load up the files to run against
var specs = [
  'chordmeister/chord_spec.js',
  'chordmeister/song_spec.js',
  'chordmeister/parser_spec.js',
  'chordmeister/classified_line_spec.js',
];

// Start up the specs.
require(specs, function(require) {
  mocha.setup('bdd');
  expect = chai.expect;
  // Why? Some async loading condition? Is there a callback I should be hooking into?
  setTimeout(function() {
    mocha.run();
  }, 100);
});
</code></pre></div></div>

<p>You’ll notice that I was having synchonicity issues between spec suite load and <code class="highlighter-rouge">mocha.run()</code>. Throwing everything back a few hundred ms seemed to have done the fix.</p>

<h2 id="amd-gotchas">AMD gotchas</h2>

<p>Pay attention to the <code class="highlighter-rouge">default</code> parameter that the module exports with. This is important to remember since native ES6 will allow you to directly import it with its native syntax:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">Parser</span> <span class="k">from</span> <span class="s2">"chordmeister/parser"</span>
</code></pre></div></div>

<p>But if you’re using RequireJS/AMD modules, you’ll need to explicitly call out the <code class="highlighter-rouge">default</code> namespace from the required module, so like so:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">require</span><span class="p">([</span><span class="s2">"chordmeister/parser"</span><span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">parser</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">Parser</span> <span class="o">=</span> <span class="nx">parser</span><span class="p">.</span><span class="k">default</span><span class="p">;</span>
  <span class="k">new</span> <span class="nx">Parser</span><span class="p">()</span> <span class="c1">// and do stuff.</span>
<span class="p">});</span>
</code></pre></div></div>

<p>Let me know if you have any questions!</p>

			
			
		</div>
	<footer>
		<div class="article__categories">
  Tagged under
  
  
  <a class="article__category" href="/category/tdd">TDD</a>
  , 
  
  <a class="article__category" href="/category/amd">AMD</a>
  , 
  
  <a class="article__category" href="/category/requirejs">requirejs</a>
  , 
  
  <a class="article__category" href="/category/mocha">mocha</a>
  , 
  
  <a class="article__category" href="/category/node">node</a>
  , 
  
  <a class="article__category" href="/category/testing">testing</a>
  
  
</div>

	
	
	</footer>
	
</article>
<!-- END OF _includes/article.html -->


  <section class="comments">
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>


<!-- END OF _/layouts/post.html -->


			<footer>
				Copyright &copy; 2018

	The Sweet Spot


				

<script type="text/javascript">
      var disqus_shortname = 'g9labs';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://localhost:4000/2014/06/06/running-mocha-tests-with-es6-amd-modules/';
        var disqus_url = 'http://localhost:4000/2014/06/06/running-mocha-tests-with-es6-amd-modules/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>











			</footer>

		</div> <!-- // .wrap -->
  </body>

	<script>
		$(document).ready(function() {
			// Make images center
			$('p:has(img)').css('text-align', 'center');

			// Add the image's title attribute as a caption
			$('p:has(img)').append(function () {
				return '<div class="caption">' + ($('img', this).attr('title') || "") + '</div>';
			});

			// Prettify code
			$('code').addClass('prettyprint');
			$('pre code').addClass('linenums');

			// Copy to clipboard with button
			$('pre:has(code)').prepend(function(){
				return '<div class="clip-btn">copy to clipboard</div>';
      });

			$('.clip-btn').zclip({
				path:'/js/ZeroClipboard.swf',
				copy: $(this).next('code').text(),
				afterCopy: function(){
					$(this).replaceWith('<div class="clip-btn">copied!');
					}
			});
		});
	</script>
</html>
<!-- END OF _layouts/default.html -->
