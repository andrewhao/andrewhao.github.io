<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="3.8.3">Jekyll</generator><link href="http://localhost:4000/feed.xml" rel="self" type="application/atom+xml" /><link href="http://localhost:4000/" rel="alternate" type="text/html" /><updated>2018-09-01T20:12:39-07:00</updated><id>http://localhost:4000/</id><title type="html">The Sweet Spot</title><subtitle>Andrew Hao's thoughts on software engineering, team leadership &amp; product design.</subtitle><entry><title type="html">Tensorflow for Tears: Part 2</title><link href="http://localhost:4000/2018/08/27/tensorflow-for-tears-part-2/" rel="alternate" type="text/html" title="Tensorflow for Tears: Part 2" /><published>2018-08-27T20:44:34-07:00</published><updated>2018-08-27T20:44:34-07:00</updated><id>http://localhost:4000/2018/08/27/tensorflow-for-tears-part-2</id><content type="html" xml:base="http://localhost:4000/2018/08/27/tensorflow-for-tears-part-2/">&lt;p&gt;The &lt;a href=&quot;/2018/03/21/tensorflow-for-tears-part-1/&quot;&gt;last time we met&lt;/a&gt;, we had a lively discussion about the ins and outs and joys and terrors of parenting. I talked about how I started building a Raspberry Pi project with a USB mic and wrote a simple parsing script that measured the mean amplitude of recordings of the current state of the nursery. And when that guy wailed, he really WAILED.&lt;/p&gt;

&lt;p&gt;Well that naive approach got us so far, but the system would still trip up due to random loud noises in the house. Music, or doors closing or opening, or loud conversation would all cause the system to think the kid was crying but no - it was just ambient noise.&lt;/p&gt;

&lt;h3 id=&quot;getting-started-with-tensorflow&quot;&gt;Getting started with TensorFlow&lt;/h3&gt;

&lt;p&gt;Let’s start our dive into machine learning!&lt;/p&gt;

&lt;p&gt;I had already gotten pretty far with &lt;a href=&quot;https://www.udacity.com/course/intro-to-machine-learning--ud120&quot;&gt;Udacity’s Machine Learning&lt;/a&gt; course and had vague recollections of AI theory floating around from the cobwebs of undergrad CS courses past. So I had &lt;em&gt;some&lt;/em&gt; background in AI and machine learning. But training neural networks was a completely new thing to me.&lt;/p&gt;

&lt;p&gt;Luckily, I came across the &lt;a href=&quot;https://www.tensorflow.org/tutorials/sequences/audio_recognition&quot;&gt;Simple Audio Recognition Tutorial&lt;/a&gt; example right there on the TF homepage. This was exactly what I was looking for. The objective was: given a training set of audio clips of crying babies and “empty rooms”, classify an audio clip as one or the other.&lt;/p&gt;

&lt;h3 id=&quot;first-getting-the-dataset&quot;&gt;First: getting the dataset&lt;/h3&gt;

&lt;p&gt;I had oversimplified in my mind what made a great training data set. After all, I figured that I just had to record my kid crying a bunch, then get a few minutes of quiet room sounds, and then we were good, right?&lt;/p&gt;

&lt;p&gt;Wrong.&lt;/p&gt;

&lt;p&gt;Training data must be exactly matched. Sample rates must be consistent, and audio samples must either be highly randomized or at least normalized to the same rates. To wit, here’s how I gathered my sample data:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;I set up the Raspberry Pi to continuously record 30-second samples at 22.05kHz through the onboard microphone.&lt;/li&gt;
  &lt;li&gt;When my son started a crying episode, I’d make note of the start time and end times, and then go back and gather those clips of the cries and dump them in the &lt;code class=&quot;highlighter-rouge&quot;&gt;crying&lt;/code&gt; folder.&lt;/li&gt;
  &lt;li&gt;Once I had collected enough of those (maybe 30 minutes total), I then gathered a bunch of the “other” clips of quiet sleep in his nursery and threw these in the &lt;code class=&quot;highlighter-rouge&quot;&gt;silence&lt;/code&gt; folder.&lt;/li&gt;
  &lt;li&gt;Once I had moved these samples off the Raspberry Pi and onto my laptop, I then sliced these recordings into 5-second clips using &lt;code class=&quot;highlighter-rouge&quot;&gt;sox&lt;/code&gt;. I also applied a few amplification filters to overcome the weak pickup on the mic.&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;$ sox FILENAME FILENAME_OUTPUT trim 0 5 vol 45 dB rate 22050&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;I then placed each of these trained samples in the folders corresponding to their label: &lt;code class=&quot;highlighter-rouge&quot;&gt;crying&lt;/code&gt; and &lt;code class=&quot;highlighter-rouge&quot;&gt;silence&lt;/code&gt;.&lt;/p&gt;

&lt;h3 id=&quot;second-training-the-network&quot;&gt;Second: training the network&lt;/h3&gt;

&lt;p&gt;I modified the &lt;code class=&quot;highlighter-rouge&quot;&gt;train.py&lt;/code&gt; script nearly verbatim from TF docs. We’ll dissect it here, beginning with the command to begin training:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;    &lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;python app/train.py &lt;span class=&quot;nt&quot;&gt;--data_url&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--data_dir&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;./data &lt;span class=&quot;nt&quot;&gt;--wanted_words&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;silence,crying &lt;span class=&quot;nt&quot;&gt;--sample_rate&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;22050 &lt;span class=&quot;nt&quot;&gt;--clip_duration_ms&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;5000 &lt;span class=&quot;nt&quot;&gt;--how_many_training_steps&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1000,200 &lt;span class=&quot;nt&quot;&gt;--learning_rate&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;0.001,0.0001 &lt;span class=&quot;nt&quot;&gt;--train_dir&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;./training
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;--wanted_words=silence,crying&lt;/code&gt;: This specifies which labels should be considered for training purposes.&lt;/li&gt;
  &lt;li&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;--sample_rate&lt;/code&gt;: The sample rate of the audio files provided&lt;/li&gt;
  &lt;li&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;--clip_duration_ms&lt;/code&gt;: Duration of each training clip in milliseconds&lt;/li&gt;
  &lt;li&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;--how_many_training_steps&lt;/code&gt;: This is a comma-separated list of n numbers that specify the number of steps per phase.&lt;/li&gt;
  &lt;li&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;--learning_rate&lt;/code&gt;: This is the rate at which the system can adjust its current learnings to match its new inputs. A higher learning rate means the faster the system can change to learn new inputs. A lower number ensures the stability of a system’s learning. We specify a higher training rate for the first phase and lower the training rate in the latter phase as our precision increases.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Let’s run the script!&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;python app/train.py &lt;span class=&quot;nt&quot;&gt;--data_url&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--data_dir&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;./data &lt;span class=&quot;nt&quot;&gt;--wanted_words&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;silence,crying &lt;span class=&quot;nt&quot;&gt;--sample_rate&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;22050 &lt;span class=&quot;nt&quot;&gt;--clip_duration_ms&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;5000 &lt;span class=&quot;nt&quot;&gt;--how_many_training_steps&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;1000,200 &lt;span class=&quot;nt&quot;&gt;--train_dir&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;./training
2018-08-27 22:15:33.195894: I tensorflow/core/platform/cpu_feature_guard.cc:140] Your CPU supports instructions that this TensorFlow binary was not compiled to use: AVX2 FMA
Tensor&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;Placeholder:0&quot;&lt;/span&gt;, &lt;span class=&quot;nv&quot;&gt;shape&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=()&lt;/span&gt;, &lt;span class=&quot;nv&quot;&gt;dtype&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;string&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
INFO:tensorflow:Training from step: 1
INFO:tensorflow:Step &lt;span class=&quot;c&quot;&gt;#1: rate 0.001000, accuracy 26.0%, cross entropy 2.674081&lt;/span&gt;
INFO:tensorflow:Step &lt;span class=&quot;c&quot;&gt;#2: rate 0.001000, accuracy 23.0%, cross entropy 1.593786&lt;/span&gt;
INFO:tensorflow:Step &lt;span class=&quot;c&quot;&gt;#3: rate 0.001000, accuracy 64.0%, cross entropy 1.067298&lt;/span&gt;
INFO:tensorflow:Step &lt;span class=&quot;c&quot;&gt;#4: rate 0.001000, accuracy 73.0%, cross entropy 0.843605&lt;/span&gt;
...
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;third-parsing-the-results&quot;&gt;Third: parsing the results&lt;/h3&gt;

&lt;p&gt;The output in each step reveals the current state of the neural network as trained. &lt;em&gt;Accuracy&lt;/em&gt; reflects the correctness of the model as the validation set is tested against the network (during each step of training, samples in the validation set are run against the model and checked if they line up with their specified labels).&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://www.tensorflow.org/api_docs/python/tf/losses/softmax_cross_entropy&quot;&gt;&lt;em&gt;Cross entropy&lt;/em&gt;&lt;/a&gt; is, as I understand it, the &lt;a href=&quot;https://deepnotes.io/softmax-crossentropy&quot;&gt;squared error factor&lt;/a&gt; in the result network from the actual results (lower is better).&lt;/p&gt;

&lt;p&gt;This would proceed for several hours for 1200 total steps. On a 2013-era Macbook Pro, this took approximately 6 hours. I had 350 clips of crying and 500 clips of silence. (Too much or not enough? This tired parent says “too much”.)&lt;/p&gt;

&lt;p&gt;One more thing - every few hundred steps during training, we would get this sort of output:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;INFO:tensorflow:Confusion Matrix:
 [[ 9  0  0  0]
 [ 0  0  0  0]
 [ 0  0 55  0]
 [ 0  0  1 30]]
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;What’s a &lt;a href=&quot;https://www.tensorflow.org/api_docs/python/tf/confusion_matrix&quot;&gt;confusion matrix&lt;/a&gt;? It’s, according to &lt;a href=&quot;https://www.dataschool.io/simple-guide-to-confusion-matrix-terminology/&quot;&gt;this helpful article&lt;/a&gt;, another way to visualize the accuracy of a machine learning model.&lt;/p&gt;

&lt;p&gt;Here’s how to read this confusion matrix. Given the following labels:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;# conv_labels.txt
_silence_
_unknown_
silence
crying
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;em&gt;(Where did these come from? More on that later…)&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;Imagine these labels go left-to-right, and top-to-bottom. The x-axis represents the labels that have been predicted (i.e. that have been verified) to be a certain label. So the first column represents the percentages of samples that have been predicted to be &lt;code class=&quot;highlighter-rouge&quot;&gt;_silence_&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;The labels that go top-to-bottom are the actual results from the trained model. So in this case, if we take the top-left number &lt;code class=&quot;highlighter-rouge&quot;&gt;9&lt;/code&gt;, that means that in 9 runs of the model where the prediction was &lt;code class=&quot;highlighter-rouge&quot;&gt;_silence_&lt;/code&gt;, the actual result was &lt;code class=&quot;highlighter-rouge&quot;&gt;_silence_&lt;/code&gt;. Moving one cell down, that represents the # of samples where the predicted result was &lt;code class=&quot;highlighter-rouge&quot;&gt;_silence_&lt;/code&gt;, but the actual result was &lt;code class=&quot;highlighter-rouge&quot;&gt;_unknown_&lt;/code&gt;. Fortunately for our model, there are &lt;code class=&quot;highlighter-rouge&quot;&gt;0&lt;/code&gt; results in this cell. So on and so forth. So the ideal confusion matrix is a matrix that has a “diagonal line” running from top-left to bottom-right, and &lt;code class=&quot;highlighter-rouge&quot;&gt;0&lt;/code&gt;s everywhere else, because all predictions would equal actuals.&lt;/p&gt;

&lt;p&gt;tl;dr: Confusion matrices are a way to visualize and report the accuracy of a machine learning model. You want a clear and convincing diagonal line in the matrix.&lt;/p&gt;

&lt;p&gt;Oh, and here are the results from the training data. I’m using &lt;code class=&quot;highlighter-rouge&quot;&gt;tensorboard&lt;/code&gt; to visualize the training steps:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/tensorflow-for-tears/tensorboard-accuracy.png&quot; alt=&quot;Accuracy data&quot; /&gt;
&lt;em&gt;Accuracy modeling. Note how quickly the model jumps to be fairly accurate.&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/tensorflow-for-tears/tensorboard-cross-entropy.png&quot; alt=&quot;Cross entropy data&quot; /&gt;
&lt;em&gt;Note how quickly cross entropy dives.&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;We can use these graphs to tune our models if we really cared. In this case, I say it’s good enough (accuracy is up to 99% by the end).&lt;/p&gt;

&lt;h3 id=&quot;fourth-saving-and-exporting-the-model&quot;&gt;Fourth: Saving and exporting the model&lt;/h3&gt;

&lt;p&gt;OK, but enough already. We have a trained model and, like &lt;a href=&quot;https://en.wikipedia.org/wiki/Chekhov%27s_gun&quot;&gt;Chekhov’s Gun&lt;/a&gt;, that means we’ve gotta use it!&lt;/p&gt;

&lt;p&gt;Where’s that model? Oh, it needs a few more steps before it can emerge. At this point, TensorFlow has developed a neural network, but the neuron graph (is that the right term?) is not yet in a usable state to be used by applications. To that point, we need to dump the model into a binary format that can be used by TensorFlow applications in the future.&lt;/p&gt;

&lt;p&gt;Once again, I claim no smarts in all this, but instead point to the TensorFlow script to do this in &lt;code class=&quot;highlighter-rouge&quot;&gt;app/freeze.py&lt;/code&gt;:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;$ python app/freeze.py --start_checkpoint=./training/conv.ckpt-1200 --output_file=./graph.pb --clip_duration_ms=5000 --sample_rate=22050 --wanted_words=silence,crying --data_dir=./data
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;What did we specify here?&lt;/p&gt;

&lt;p&gt;We said we wanted the model at &lt;code class=&quot;highlighter-rouge&quot;&gt;--start_checkpoint&lt;/code&gt; of 1200, saving the &lt;code class=&quot;highlighter-rouge&quot;&gt;--output_file&lt;/code&gt; to &lt;code class=&quot;highlighter-rouge&quot;&gt;graph.pb&lt;/code&gt;, and mentioning that the sample rate of each audio sample should be &lt;code class=&quot;highlighter-rouge&quot;&gt;22050 hz&lt;/code&gt; and &lt;code class=&quot;highlighter-rouge&quot;&gt;5&lt;/code&gt; seconds long. We then specified that the labels we wanted to classify are &lt;code class=&quot;highlighter-rouge&quot;&gt;silence&lt;/code&gt; and &lt;code class=&quot;highlighter-rouge&quot;&gt;crying&lt;/code&gt;. Finally, the data set from the prior run can be found in &lt;code class=&quot;highlighter-rouge&quot;&gt;./data&lt;/code&gt; dir.&lt;/p&gt;

&lt;p&gt;When we run this script, we get a &lt;code class=&quot;highlighter-rouge&quot;&gt;graph.pb&lt;/code&gt; protobuf binary file that we can then ship to various TensorFlow programs.&lt;/p&gt;

&lt;h3 id=&quot;fifth-using-the-model&quot;&gt;Fifth: Using the model&lt;/h3&gt;

&lt;p&gt;Now here’s the fun part!&lt;/p&gt;

&lt;p&gt;Onboard a Raspberry Pi, we are now going to play back current samples in the nursery:&lt;/p&gt;

&lt;p&gt;Every 1 minute (with cron), we record audio samples from the system mic in the baby’s nursery. We then massage, crop and downsample it into a WAV file. We then point a script at this WAV file and run the TF graph on it. Running the graph will return a list of labels and their probabilities. We choose the first label with the highest probability, and ship it off to a timeseries API, in this case powered by Keen.io.&lt;/p&gt;

&lt;p&gt;Voila:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/tensorflow-for-tears/miserymeter.png&quot; alt=&quot;I present: the Misery Meter&quot; /&gt;
&lt;em&gt;A fun graph displaying the timeseries data for this little dude’s episodes. On the top was the original RMS volume graph, and the bottom is the result of the trained TF model. Note how much easier to read and understand the latter graph is.&lt;/em&gt;&lt;/p&gt;

&lt;h4 id=&quot;show-me-the-code&quot;&gt;Show me the code!&lt;/h4&gt;

&lt;p&gt;Much of this code has been adapted from &lt;a href=&quot;https://www.tensorflow.org/tutorials/sequences/audio_recognition&quot;&gt;Google’s TensorFlow Audio Recognition tutorial&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;My scripts have been collected on this GitHub repository: &lt;a href=&quot;https://github.com/andrewhao/babblefish&quot;&gt;https://github.com/andrewhao/babblefish&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;And my repository with audio sampling and archiving: &lt;a href=&quot;https://github.com/andrewhao/miserymeter&quot;&gt;https://github.com/andrewhao/miserymeter&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h2&gt;

&lt;p&gt;Wow, that was a quick dive through TensorFlow. Note that I didn’t get too deep into the theory of convolutional neural networks, which may be a topic of discussion for another time. Instead, we talked a little bit about the mechanics of building and training a TF model with audio data and a finite set of classes. It was fairly straightforward to get this script then loaded up on a Raspberry Pi and have a dashboard that could finally quantify the pain and suffering of baby… and parent.&lt;/p&gt;

&lt;h3 id=&quot;epilogue&quot;&gt;Epilogue&lt;/h3&gt;

&lt;p&gt;The months that went into developing this app were fully and knowingly an escape from the very real stressors of parent life. I want to acknowledge the love, the grit and the patience of my wife in this very trying time. There is so much more to say about babies other than their crying and fussing - life these days is filled with laughter and giggles and joy, too - but these are words that I’ll save for another blog entry on a different blog for another time.&lt;/p&gt;</content><author><name></name></author><summary type="html">The last time we met, we had a lively discussion about the ins and outs and joys and terrors of parenting. I talked about how I started building a Raspberry Pi project with a USB mic and wrote a simple parsing script that measured the mean amplitude of recordings of the current state of the nursery. And when that guy wailed, he really WAILED.</summary></entry><entry><title type="html">TensorFlow For Tears: Part 1</title><link href="http://localhost:4000/2018/03/21/tensorflow-for-tears-part-1/" rel="alternate" type="text/html" title="TensorFlow For Tears: Part 1" /><published>2018-03-21T18:56:34-07:00</published><updated>2018-03-21T18:56:34-07:00</updated><id>http://localhost:4000/2018/03/21/tensorflow-for-tears-part-1</id><content type="html" xml:base="http://localhost:4000/2018/03/21/tensorflow-for-tears-part-1/">&lt;h3 id=&quot;an-introduction-to-every-parents-trial-and-travails&quot;&gt;An introduction to every parent’s trial and travails&lt;/h3&gt;

&lt;p&gt;When our son was born early last year, I admit I wasn’t ready for it. Fatherhood was not the kind of thing I was ready for (and who really can ever be ready for parenthood, anyways?).&lt;/p&gt;

&lt;p&gt;It so turns out that the vast majority of the first year of parenting is simply enduring the gut-wrenching cries of your little one. And cry they do - crying when they are too tired, screaming when they are too energetic, crying when they are gassy, screaming when they are bored, and crying when they just pooped.&lt;/p&gt;

&lt;p&gt;The trials that Annie and I went through with our little guy was particularly difficult on us (you can ask me in person if we ever get to chat). The little guy was a prolific screamer and absolutely. hated. sleep.&lt;/p&gt;

&lt;p&gt;What’s a geeky dad to do? Quantify household suffering by leveraging machine learning, of course.&lt;/p&gt;

&lt;p&gt;I set out to build a system that would in the end determine how well our little guy slept through (or didn’t sleep through) the night. I started by building a system that naively parsed audio samples from his nursery, and then trained a TensorFlow model to do more accurate detection of his cries. Here’s how it worked:&lt;/p&gt;

&lt;h3 id=&quot;act-1-the-misery-meter&quot;&gt;Act 1: The Misery Meter&lt;/h3&gt;

&lt;p&gt;In version 1 of the system, I bought &lt;a href=&quot;https://www.amazon.com/Kinobo-Microphone-Desktop-Recognition-Software/dp/B00IR8R7WQ&quot;&gt;a cheap USB microphone&lt;/a&gt; and hooked it up to a Raspberry Pi 3.&lt;/p&gt;

&lt;p&gt;In it, I loaded up a script to record a 30-second audio sample, using the &lt;code class=&quot;highlighter-rouge&quot;&gt;arecord&lt;/code&gt; UNIX command line tool:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;#!/usr/bin/env bash&lt;/span&gt;

&lt;span class=&quot;nb&quot;&gt;set&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-euxo&lt;/span&gt; pipefail

&lt;span class=&quot;nv&quot;&gt;DIR&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;$(&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;cd&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;$(&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;dirname&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;BASH_SOURCE&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[0]&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;pwd&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;RECORDING_FILE&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;DIR&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;/recordings/sample.wav&quot;&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;DATE&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;date&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;+%Y-%m-%d %H:%M:%S&quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;UPLOAD_RECORDING_FILENAME&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;$(&lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;printf&lt;/span&gt; %q &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;DATE&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;.wav&quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;)&lt;/span&gt;
arecord &lt;span class=&quot;nt&quot;&gt;--device&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;hw:1,0 &lt;span class=&quot;nt&quot;&gt;--format&lt;/span&gt; S16_LE &lt;span class=&quot;nt&quot;&gt;--rate&lt;/span&gt; 48000 &lt;span class=&quot;nt&quot;&gt;-c1&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-d&lt;/span&gt; 30 &lt;span class=&quot;nt&quot;&gt;--quiet&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;RECORDING_FILE&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;…then I ran the &lt;code class=&quot;highlighter-rouge&quot;&gt;sox&lt;/code&gt; command-line tool to grab some simple loudness statistics out from it:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sox -V3 ${RECORDING_FILE} -n stats 2&amp;gt;&amp;amp;1 | grep dB
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In case you’re curious, here’s the full output from &lt;code class=&quot;highlighter-rouge&quot;&gt;sox -V3 FILE -n stats&lt;/code&gt;. Pretty nifty:&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;➜ sox -V3 sample.wav -n stats
# ... Truncated for brevity ...

sox INFO sox: effects chain: input        48000Hz  1 channels
sox INFO sox: effects chain: stats        48000Hz  1 channels
sox INFO sox: effects chain: output       48000Hz  1 channels
DC offset   0.000017
Min level  -0.141083
Max level   0.135651
Pk lev dB     -17.01
RMS lev dB    -29.32
RMS Pk dB     -27.37
RMS Tr dB     -30.83
Crest factor    4.12
Flat factor     0.00
Pk count           2
Bit-depth      14/16
Num samples     480k
Length s      10.000
Scale max   1.000000
Window s       0.050
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Here, we’re really only interested in &lt;code class=&quot;highlighter-rouge&quot;&gt;RMS dB&lt;/code&gt;, which is the relative loudness levels within this 30-second sample. I chose to push these three stats up to a web service which I use to aggregate and graph these metrics. &lt;code class=&quot;highlighter-rouge&quot;&gt;RMS lev&lt;/code&gt; is the average, &lt;code class=&quot;highlighter-rouge&quot;&gt;RMS Pk&lt;/code&gt; is the peak, and &lt;code class=&quot;highlighter-rouge&quot;&gt;RMS Tr&lt;/code&gt; is the trough (the floor).&lt;/p&gt;

&lt;p&gt;I’m not showing the entirety of the script, but the last thing it does is parse and push the results of the analysis of this audio sample to a Web-based metrics aggregation service! In case you were wondering, I have an API service sitting between the Raspberry Pi and a time-series API supplied by &lt;a href=&quot;https://www.keen.io&quot;&gt;Keen.io&lt;/a&gt;. But the main point is that now I can load up a cute JS widget that graphs these data points!&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/images/tensorflow-for-tears/audio-graph.png&quot; alt=&quot;Audio crying graph&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Now, how does one read this graph?&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;We can follow the peaks of the audio signal and assume that any noise over a certain dB threshold is the little dude’s screaming.&lt;/li&gt;
  &lt;li&gt;We can follow the troughs of the graph and assume that if the trough jumps, then man there is some serious crying going on, since the audio floor of the soundscape has been bumped up!&lt;/li&gt;
  &lt;li&gt;Or we can follow the average RMS reading and assume some combination of the two?&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;The truth of the matter, none of the readings from the Misery Meter (so I called it) were particularly reliable indicators of “the little buddy is crying his little head off”. Sometimes, his crying was at the same volume level as other ambient noises in the house (say, when he’s playing in the other room and someone shuts a door). So it turns out that using volume as a proxy for crying is insufficient to give us reliable results.&lt;/p&gt;

&lt;h3 id=&quot;act-2-enter-tensorflow-next&quot;&gt;Act 2: Enter TensorFlow… next!&lt;/h3&gt;

&lt;p&gt;In my next post, I’ll discuss how I modified this script to use TensorFlow to train a model that could then be used to enhance the accuracy of little dude’s crying. Stick around, it’ll be fun!&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;/2018/08/27/tensorflow-for-tears-part-2/&quot;&gt;Read on for the next post!&lt;/a&gt;&lt;/p&gt;</content><author><name></name></author><summary type="html">An introduction to every parent’s trial and travails</summary></entry><entry><title type="html">Elixir and Elm things I’ve written about elsewhere</title><link href="http://localhost:4000/2018/03/13/elixir-and-elm-things-ive-written-elsewhere/" rel="alternate" type="text/html" title="Elixir and Elm things I've written about elsewhere" /><published>2018-03-13T20:52:23-07:00</published><updated>2018-03-13T20:52:23-07:00</updated><id>http://localhost:4000/2018/03/13/elixir-and-elm-things-ive-written-elsewhere</id><content type="html" xml:base="http://localhost:4000/2018/03/13/elixir-and-elm-things-ive-written-elsewhere/">&lt;p&gt;While it’s been pretty quiet around these parts, I’ve kept the technical blogging up over on &lt;a href=&quot;https://blog.carbonfive.com&quot;&gt;my employer’s blog&lt;/a&gt;. I’ve got quite a few posts around Elixir:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://blog.carbonfive.com/2018/03/19/lightweight-dependency-injection-in-elixir-without-the-tears/&quot;&gt;Lightweight dependency injection in Elixir (without the tears)&lt;/a&gt;: What are some ways we can use the language features of Elixir to apply small-scale dependency injection patterns, without a ton of ceremony?&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://blog.carbonfive.com/2018/01/16/functional-mocks-with-mox-in-elixir/&quot;&gt;Functional Mocks with Mox in Elixir&lt;/a&gt;: This post discusses a mocking library in Elixir called &lt;a href=&quot;https://github.com/plataformatec/mox&quot;&gt;mox&lt;/a&gt; that adheres to the Elixir Way(tm) of mocking (that is, the usage of fakes or doubles).&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://blog.carbonfive.com/2018/01/30/comparing-dynamic-supervision-strategies-in-elixir-1-5-and-1-6/&quot;&gt;Comparing Dynamic Supervision Strategies in Elixir 1.5 and 1.6&lt;/a&gt;: In this blog post, I discuss the benefits of the new &lt;code class=&quot;highlighter-rouge&quot;&gt;DynamicSupervisor&lt;/code&gt; module in Elixir 1.6 and how it makes the supervision of a dynamically-scaled supervision tree easier to set up.&lt;/p&gt;

&lt;p&gt;Finally, I wrote &lt;a href=&quot;https://blog.carbonfive.com/2017/10/25/taking-elm-for-a-test-drive/&quot;&gt;“Taking Elm for a Test Drive”&lt;/a&gt; about playing around with Elm, giving my take on the trajectory of the language.&lt;/p&gt;</content><author><name></name></author><summary type="html">While it’s been pretty quiet around these parts, I’ve kept the technical blogging up over on my employer’s blog. I’ve got quite a few posts around Elixir:</summary></entry><entry><title type="html">Wejoinin at Ten</title><link href="http://localhost:4000/2017/09/28/wejoinin-at-ten/" rel="alternate" type="text/html" title="Wejoinin at Ten" /><published>2017-09-28T19:57:43-07:00</published><updated>2017-09-28T19:57:43-07:00</updated><id>http://localhost:4000/2017/09/28/wejoinin-at-ten</id><content type="html" xml:base="http://localhost:4000/2017/09/28/wejoinin-at-ten/">&lt;p&gt;I posted an article on Medium titled &lt;a href=&quot;https://medium.com/wejoinin/wejoinin-at-ten-34efeaff6e03&quot;&gt;“Wejoinin at Ten”&lt;/a&gt; describing our experience developing Wejoinin over the past ten years as a long-running passion project - and talk about the directions we hope to be taking it in the next ten.&lt;/p&gt;

&lt;p&gt;Give it a read and let me know what you think!&lt;/p&gt;</content><author><name></name></author><summary type="html">I posted an article on Medium titled “Wejoinin at Ten” describing our experience developing Wejoinin over the past ten years as a long-running passion project - and talk about the directions we hope to be taking it in the next ten.</summary></entry><entry><title type="html">Pitfalls to avoid when moving to async systems</title><link href="http://localhost:4000/2017/07/19/pitfalls-to-avoid-when-moving-to-async-systems/" rel="alternate" type="text/html" title="Pitfalls to avoid when moving to async systems" /><published>2017-07-19T19:57:18-07:00</published><updated>2017-07-19T19:57:18-07:00</updated><id>http://localhost:4000/2017/07/19/pitfalls-to-avoid-when-moving-to-async-systems</id><content type="html" xml:base="http://localhost:4000/2017/07/19/pitfalls-to-avoid-when-moving-to-async-systems/">&lt;p&gt;I recently published a post on the &lt;a href=&quot;http://blog.carbonfive.com&quot;&gt;Carbon Five blog&lt;/a&gt; titled &lt;a href=&quot;http://blog.carbonfive.com/2017/07/18/evented-rails-decoupling-complex-domains-in-rails-with-domain-events/&quot;&gt;“Evented Rails: Decoupling complex domains in Rails with Domain Events”&lt;/a&gt; that takes some of my thoughts about moving a Rails app to use Domain Events - leveraging the power of Sidekiq (or your job runner of choice) to send async messages between different domains of your app.&lt;/p&gt;

&lt;p&gt;This approach always seems nice from the outset, but can hide some painful complexities if you go too far down the rabbit hole. Here is a repost of the latter half of that article, which is worth repeating:&lt;/p&gt;

&lt;h2 id=&quot;big-wins-of-the-async-model-speed--scalability&quot;&gt;Big win[s of the async model]: speed &amp;amp; scalability&lt;/h2&gt;

&lt;p&gt;By splitting out domain logic into cohesive units, we’ve just designed our systems to farm out their workloads to a greater scalable number of workers. Imagine if you had a web request thread that would take 500ms to return, but 150ms of that time was spent doing a round trip to a different service. By decoupling that work from the main request thread and moving it to a background job – we’ve just sped up the responsiveness of our system for our end user, and we know that studies have shown that page speed performance equals money.&lt;/p&gt;

&lt;p&gt;Additionally, making our application calls asynchronous allows us to scale the number of processing power we allocate to our system. We now have the ability to horizontally scale workers according to the type of job, or the domain they are working from. This may result in cost and efficiency savings as we match processing power to the workload at hand.&lt;/p&gt;

&lt;h2 id=&quot;big-challenge-dealing-with-asynchronous-data-flows&quot;&gt;Big challenge: dealing with asynchronous data flows&lt;/h2&gt;

&lt;p&gt;Once things go async, we now have a fundamentally different data design. For example, say you implemented an HTTP API endpoint that performed some action in the system synchronously. However, now you’ve farmed out the effects of the action to background processes through domain events. While this is great for response times, you’ve now no longer got the guarantees to the caller that the desired side effect has been performed once the server responds back.&lt;/p&gt;

&lt;h3 id=&quot;asynchronous-polling&quot;&gt;Asynchronous polling&lt;/h3&gt;

&lt;p&gt;An option is to implement the Polling pattern. The API can return a request identifier back to the caller on first call, with which which the caller can now query the API for the result status. If the result is not ready, the API service will return with a Nack message, or negative Ack, implying that the result data has not arrived yet. As soon as the results in the HTTP API are ready, the API will correctly return the result.&lt;/p&gt;

&lt;h3 id=&quot;pubsub-all-the-way-down&quot;&gt;Pub/Sub all the way down&lt;/h3&gt;

&lt;p&gt;Another option is to embrace the asynchronous nature of the system wholly and transition the APIs to event-driven, message-based systems instead. In this paradigm, we would introduce an external message broker such as RabbitMQ to facilitate messages within our systems. Instead of providing an HTTP endpoint to perform an action, the API service could subscribe to a domain event from the calling system, perform its side effect, then fire off its own domain event, to which the calling system would subscribe to. The advantage of this approach is that this scheme makes more efficient use of the network (reducing chattiness), but we trade off the advantages of using HTTP (the ubiquity of the protocol, performance enhancements like layered caching).&lt;/p&gt;

&lt;p&gt;Browser-based clients can also get in on the asynchronous fun with the use of WebSockets to subscribe to server events. Instead of having a browser call an HTTP API, the browser could simply fire a WebSocket event, to which the service would asynchronously process (potentially also proxying the message downstream to other APIs with messages) and then responding via a WebSocket message when the data is done processing.&lt;/p&gt;

&lt;h2 id=&quot;big-challenge-data-consistency&quot;&gt;Big challenge: data consistency&lt;/h2&gt;

&lt;p&gt;When we choose an asynchronous evented approach, we now have to consider how to model asynchronous transactions. Imagine that one domain process charges a user’s credit card with a third party payment processor and another domain process is responsible for updating it in your database. There are now two processes updating two data stores. A central tenet in distributed systems design is to anticipate and expect failure. Let’s imagine any of the following scenarios happens:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;An Amazon AWS partial outage takes down one of your services but not the other.&lt;/li&gt;
  &lt;li&gt;One of your services becomes backed up due to high traffic, and no longer can service new requests in a timely manner.&lt;/li&gt;
  &lt;li&gt;A new deployment has introduced a data bug in a downstream API that your teams are rushing to fix, but will requiring manual reconciling with the data in the upstream system.&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;How will you build your domain and data models to account for failures in each processing step? What would happen if you have one operation occur in one domain that depends on data that has not yet appeared in another part of the system? Can you design your data models (and database schema) to support independent updates without any dependencies? How will you handle the case when one domain action fails and the other completes?&lt;/p&gt;

&lt;h3 id=&quot;first-approach-avoid-it-by-choosing-noncritical-paths-to-decouple-first&quot;&gt;First approach: avoid it by choosing noncritical paths to decouple, first&lt;/h3&gt;

&lt;p&gt;If you are implementing an asynchronous, evented paradigm for the first time, I suggest you carefully begin decoupling boundaries with domain events only for events that lie outside the critical business domain path. Begin with some noncritical aspect of the system — for example, you may have a third party analytics tracking service that you must publish certain business events to. That would be a nice candidate to decouple from the main request process and move to an async path.&lt;/p&gt;

&lt;h3 id=&quot;second-approach-enforce-transactional-consistency-within-the-same-processdomain-boundary&quot;&gt;Second approach: enforce transactional consistency within the same process/domain boundary&lt;/h3&gt;

&lt;p&gt;Although we won’t discuss specifics in this article, if you must enforce transactional consistency in some part of your system (say, the charging of a credit card with the crediting of money to a user’s account) then I suggest that you perform those operations within the same bounded context and same process, leaning on transactional consistency guarantees provided by your database layer.&lt;/p&gt;

&lt;h3 id=&quot;third-approach-embrace-it-with-eventual-consistency&quot;&gt;Third approach: embrace it with eventual consistency&lt;/h3&gt;

&lt;p&gt;Alternatively, you may be able to lean on “eventual consistency” semantics with your data. Maybe it’s less important that your data squares away with itself immediately — maybe it’s more important that the data, at some guaranteed point in time — eventually lines up. It may be OK for some aspect of your data (e.g. notifications in a news feed) and may not be appropriate for other data (e.g. a bank account balance).&lt;/p&gt;

&lt;p&gt;You may need to fortify your system to ensure that data eventually becomes consistent. This may involve building out the following pieces of infrastructure.&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;Messages need to be durable — make sure your job enqueuing system does not drop messages, or at least has a failure mode to re-process them when (not if!) your system fails.&lt;/li&gt;
  &lt;li&gt;Your jobs should be designed to be idempotent, so they can be retried multiple times and result in the correct outcome.&lt;/li&gt;
  &lt;li&gt;You should easily be able to recover from bad data scenarios. Should a service go down, it should be able to replay messages, logs, or the consumer should have a queue of retry-able messages it can send.&lt;/li&gt;
  &lt;li&gt;Eventual consistency means that you may need an external process to verify consistency. You may be doing this sort of verification process in a data warehouse, or in a different software system that has a full view of all the data in your distributed system. Be sure that this sort of verification is able to reveal to you holes in the data, and provide actionable insights so you can fix them.&lt;/li&gt;
  &lt;li&gt;You will need to add monitoring and logging to measure the failure modes of the system. When errors spike, or messages fail to send (events fail to fire), you need to be alerted. Once alerted, your logging must be good enough to be able to trace the source and the data that each request is firing.&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;The scale of this subject is large and is under active research in the field of computer science. A good book to pick up that discusses this topic is &lt;a href=&quot;https://www.amazon.com/Service-Oriented-Design-Rails-Addison-Wesley-Professional/dp/0321659368&quot;&gt;Service-Oriented Design with Ruby on Rails&lt;/a&gt;. The popular &lt;a href=&quot;http://www.enterpriseintegrationpatterns.com/&quot;&gt;Enterprise Integration Patterns&lt;/a&gt; book also has a great topic on consistency (and is accompanied by a very helpful &lt;a href=&quot;http://www.enterpriseintegrationpatterns.com/patterns/conversation/EnsuringConsistencyIntro.html&quot;&gt;online guide&lt;/a&gt; as well).&lt;/p&gt;</content><author><name></name></author><summary type="html">I recently published a post on the Carbon Five blog titled “Evented Rails: Decoupling complex domains in Rails with Domain Events” that takes some of my thoughts about moving a Rails app to use Domain Events - leveraging the power of Sidekiq (or your job runner of choice) to send async messages between different domains of your app.</summary></entry><entry><title type="html">JHipster &amp;amp; Spring Boot for Rails developers</title><link href="http://localhost:4000/2016/10/14/jhipster-and-spring-boot-for-rails-developers/" rel="alternate" type="text/html" title="JHipster &amp;amp; Spring Boot for Rails developers" /><published>2016-10-14T14:24:39-07:00</published><updated>2016-10-14T14:24:39-07:00</updated><id>http://localhost:4000/2016/10/14/jhipster-and-spring-boot-for-rails-developers</id><content type="html" xml:base="http://localhost:4000/2016/10/14/jhipster-and-spring-boot-for-rails-developers/">&lt;p&gt;The first question you may be asking is - &lt;em&gt;why would I want to go from Rails to Java&lt;/em&gt;?&lt;/p&gt;

&lt;p&gt;Maybe you don’t have a choice. Maybe you started a new job. Maybe you heard Java was the new, old hotness. In any case, you’re a Ruby on Rails developer and you’re staring Java in the face.&lt;/p&gt;

&lt;h3 id=&quot;the-languages&quot;&gt;The languages&lt;/h3&gt;

&lt;p&gt;First off, Rails and Java share similar philosophies.&lt;/p&gt;

&lt;p&gt;You may argue that Java is the One True Language for old-fashioned Object-Oriented Programming. The existence of strong types lead to powerful expressions around OOP concepts like inheritance, polymorphism, and the like.&lt;/p&gt;

&lt;p&gt;Java and Ruby share similar philosophies - in that Everything Is An Object. In Ruby, the &lt;code class=&quot;highlighter-rouge&quot;&gt;nil&lt;/code&gt; value is modeled as a &lt;code class=&quot;highlighter-rouge&quot;&gt;NilClass&lt;/code&gt;. In Java, objects abound everywhere.&lt;/p&gt;

&lt;h3 id=&quot;the-frameworks&quot;&gt;The frameworks&lt;/h3&gt;

&lt;p&gt;I can’t speak from firsthand experience, but Java developers will tell you that developing Java apps in the early 2000s was like configuration soup. Everything was explicit and configured in XML.&lt;/p&gt;

&lt;p&gt;Spring Boot arguable moves the state of the art in Java frameworks more towards’ Rails’ philosophies - that convention trumps configuration. It accomplishes this through &lt;em&gt;annotations&lt;/em&gt; - more on this later.&lt;/p&gt;

&lt;p&gt;Rails was precisely so groundbreaking and exciting in 2005 because it was everything Java was not - terse, expressive, and unapologetically convention-driven. Where in Java, everything was explicitly traceable through system calls, Rails used magic methods of dynamically-defined methods, monkey-patching and big ol’ global God Objects to accomplish its magic.&lt;/p&gt;

&lt;h3 id=&quot;liquibase-vs-active-record&quot;&gt;Liquibase vs Active Record&lt;/h3&gt;

&lt;p&gt;In Active Record, database changes are called &lt;em&gt;migrations&lt;/em&gt;.&lt;/p&gt;

&lt;p&gt;Migrations are only run from migration files, and may optionally be generated from the CLI.&lt;/p&gt;

&lt;p&gt;In Liquibase, these are called &lt;em&gt;changesets&lt;/em&gt;, and the files are called &lt;em&gt;changelogs&lt;/em&gt;.&lt;/p&gt;

&lt;p&gt;These migrations are either generated from the Liquibase CLI, or there is a nifty tool that reads Hibernate persistence entities and generates a “diff” against a known database, writing the migration to a file.&lt;/p&gt;

&lt;p&gt;Rails checks in a &lt;code class=&quot;highlighter-rouge&quot;&gt;schema.rb&lt;/code&gt; file, encompassing the canonical definition of the DB schema. There is no such equivalent in Liquibase (* I may be wrong).&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;To be continued…&lt;/strong&gt;&lt;/p&gt;</content><author><name></name></author><summary type="html">The first question you may be asking is - why would I want to go from Rails to Java?</summary></entry><entry><title type="html">Rails, meet Phoenix: Migrating to Phoenix with Rails session sharing</title><link href="http://localhost:4000/2016/06/24/migrating-to-phoenix-with-rails-session-sharing/" rel="alternate" type="text/html" title="Rails, meet Phoenix: Migrating to Phoenix with Rails session sharing" /><published>2016-06-24T13:31:06-07:00</published><updated>2016-06-24T13:31:06-07:00</updated><id>http://localhost:4000/2016/06/24/migrating-to-phoenix-with-rails-session-sharing</id><content type="html" xml:base="http://localhost:4000/2016/06/24/migrating-to-phoenix-with-rails-session-sharing/">&lt;p&gt;You’ve resolved to build your company’s Next Big Thing in Phoenix and Elixir. That’s great! You’re facing a problem though - all user authentication and access concerns are performed on your Rails system, and the work to reimplement this in Phoenix is significant.&lt;/p&gt;

&lt;p&gt;Fortunately for you, there is a great Phoenix plug to share session data between Rails and Phoenix. If you pull this off, you’ll be able to build your new API on your Phoenix app, all while letting Rails handle user authentication and session management.&lt;/p&gt;

&lt;h3 id=&quot;before-we-begin&quot;&gt;Before we begin&lt;/h3&gt;
&lt;p&gt;In this scenario, you want to build out a new API in Phoenix that is consumed by your frontend single-page application, whose sessions are hosted on Rails. We’ll call the Rails app &lt;code class=&quot;highlighter-rouge&quot;&gt;rails_app&lt;/code&gt; and your new Phoenix app &lt;code class=&quot;highlighter-rouge&quot;&gt;phoenix_app&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Additionally, each app will use a different subdomain. The Rails app will be deployed at the &lt;code class=&quot;highlighter-rouge&quot;&gt;www.myapp.com&lt;/code&gt; subdomain. The Phoenix app will be deployed at the &lt;code class=&quot;highlighter-rouge&quot;&gt;api.myapp.com&lt;/code&gt; subdomain.&lt;/p&gt;

&lt;p&gt;We are going to take &lt;a href=&quot;https://github.com/cconstantin&quot;&gt;Chris Constantin&lt;/a&gt;’s excellent &lt;a href=&quot;https://github.com/cconstantin/plug_rails_cookie_session_store&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;PlugRailsCookieSessionStore&lt;/code&gt;&lt;/a&gt; plug and integrate it into our Phoenix project. Both apps will be configured with identical cookie domains, encryption salts, signing salts, and security tokens.&lt;/p&gt;

&lt;p&gt;In the examples that follow, I’ll be using the latest versions of each framework at the time of writing, Rails 4.2 and Phoenix 1.2.&lt;/p&gt;

&lt;h3 id=&quot;cookie-based-session-storage&quot;&gt;Cookie-based session storage&lt;/h3&gt;

&lt;p&gt;Our session data is stored on the client in a secure, encrypted, validated cookie. We won’t cover the basics of cookies here, but &lt;a href=&quot;http://www.justinweiss.com/articles/how-rails-sessions-work/&quot;&gt;you can read more about them here&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Our approach will only work if your current Rails system utilizes cookie-based sessions. We will not cover the use case with a database-backed session store in SQL, Redis, or Memcache.&lt;/p&gt;

&lt;h3 id=&quot;step-1-configure-rails-accordingly&quot;&gt;Step 1: Configure Rails accordingly&lt;/h3&gt;

&lt;h4 id=&quot;configure-the-cookie-store&quot;&gt;Configure the cookie store&lt;/h4&gt;

&lt;p&gt;Let’s set up your Rails app to use a JSON cookie storage format:&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;# config/initializer/session_store.rb&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;# Use cookie session storage in JSON format. Here, we scope the cookie to the root domain.&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;Rails&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;application&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;config&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;session_store&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:cookie_store&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;key: &lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'_rails_app_session'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;domain: &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;.&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;#{&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;ENV&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'DOMAIN'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;Rails&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;application&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;config&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;action_dispatch&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;cookies_serializer&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:json&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;# These salts are optional, but it doesn't hurt to explicitly configure them the same between the two apps.&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;Rails&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;application&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;config&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;action_dispatch&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;encrypted_cookie_salt&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;ENV&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'SESSION_ENCRYPTED_COOKIE_SALT'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;Rails&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;application&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;config&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;action_dispatch&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;encrypted_signed_cookie_salt&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;ENV&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'SESSION_ENCRYPTED_SIGNED_COOKIE_SALT'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Your app may not be configured with a &lt;code class=&quot;highlighter-rouge&quot;&gt;SESSION_ENCRYPTED_COOKIE_SALT&lt;/code&gt; and &lt;code class=&quot;highlighter-rouge&quot;&gt;SESSION_ENCRYPTED_SIGNED_COOKIE_SALT&lt;/code&gt;. You may generate a pair with any random values.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://nipperlabs.com/rails-secretkeybase&quot;&gt;Some speculate&lt;/a&gt; that Rails does not require the two salts by default because the &lt;code class=&quot;highlighter-rouge&quot;&gt;SECRET_KEY_BASE&lt;/code&gt; is sufficiently long enough to not require a salt. In our example, we choose to supply them anyways to be explicit.&lt;/p&gt;

&lt;p&gt;Another important value to note here is that we have chosen a key for our session cookie - &lt;code class=&quot;highlighter-rouge&quot;&gt;_rails_app_session&lt;/code&gt;. This value will be the shared cookie key for both apps.&lt;/p&gt;

&lt;h3 id=&quot;step-2-configure-the-plug-for-phoenix&quot;&gt;Step 2: Configure the plug for Phoenix&lt;/h3&gt;

&lt;p&gt;Turning our attention to our Phoenix app, in the &lt;code class=&quot;highlighter-rouge&quot;&gt;mix.exs&lt;/code&gt; file, add the library dependency:&lt;/p&gt;

&lt;div class=&quot;language-elixir highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;# mix.exs&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;defmodule&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;PhoenixApp&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;defp&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;deps&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# snip&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:plug_rails_cookie_session_store&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;sd&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;~&amp;gt; 0.1&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;},&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# snip&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Then run &lt;code class=&quot;highlighter-rouge&quot;&gt;mix deps.get&lt;/code&gt; to fetch the new library.&lt;/p&gt;

&lt;p&gt;Now in your &lt;code class=&quot;highlighter-rouge&quot;&gt;web/phoenix_app/endpoint.ex&lt;/code&gt; file, remove the configuration for the existing session store and add the configuration for the Rails session store.&lt;/p&gt;

&lt;div class=&quot;language-elixir highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;# lib/phoenix_app/endpoint.ex&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;defmodule&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;PhoenixApp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Endpoint&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;plug&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;Plug&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Session&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# Remove the original cookie store that comes with Phoenix, out of the box.&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# store: :cookie,&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# key: &quot;_phoenix_app_key&quot;,&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# signing_salt: &quot;M8emDP0h&quot;&lt;/span&gt;
    &lt;span class=&quot;ss&quot;&gt;store:&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;PlugRailsCookieSessionStore&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# Decide on a shared key for your cookie. Oftentimes, this should&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# mirror your Rails app session key&lt;/span&gt;
    &lt;span class=&quot;ss&quot;&gt;key:&lt;/span&gt; &lt;span class=&quot;sd&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;_rails_app_session&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;ss&quot;&gt;secure:&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;ss&quot;&gt;encrypt:&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# Specifies the matching rules on the hostname that this cookie will be valid for&lt;/span&gt;
    &lt;span class=&quot;ss&quot;&gt;domain:&lt;/span&gt; &lt;span class=&quot;sd&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;#{&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;System&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;get_env&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;sd&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;DOMAIN&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;ss&quot;&gt;signing_salt:&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;System&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;get_env&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;sd&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;SESSION_ENCRYPTED_SIGNED_COOKIE_SALT&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
    &lt;span class=&quot;ss&quot;&gt;encryption_salt:&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;System&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;get_env&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;sd&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;SESSION_ENCRYPTED_COOKIE_SALT&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;),&lt;/span&gt;
    &lt;span class=&quot;ss&quot;&gt;key_iterations:&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;ss&quot;&gt;key_length:&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;64&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;ss&quot;&gt;key_digest:&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:sha&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# Specify a JSON serializer to use on the session&lt;/span&gt;
    &lt;span class=&quot;ss&quot;&gt;serializer:&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;Poison&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We set a &lt;code class=&quot;highlighter-rouge&quot;&gt;DOMAIN&lt;/code&gt; environment variable with the value
&lt;code class=&quot;highlighter-rouge&quot;&gt;myapp.com&lt;/code&gt;. The goal is for these two apps to be able to be deployed at any subdomain that ends in &lt;code class=&quot;highlighter-rouge&quot;&gt;myapp.com&lt;/code&gt;, and still be able to share the cookie.&lt;/p&gt;

&lt;p&gt;The &lt;code class=&quot;highlighter-rouge&quot;&gt;secure&lt;/code&gt; flag configures the app to send a secure cookie, which only is served over SSL HTTPS connections. It is highly recommended for your site; if you haven’t upgraded to SSL, you should do so now!&lt;/p&gt;

&lt;p&gt;Our cookies are signed such that their origins are guaranteed to have been computed from our app(s). This is done for free with Rails (and Phoenix’s) session libraries. The signature is derived from the &lt;code class=&quot;highlighter-rouge&quot;&gt;secret_key_base&lt;/code&gt; and &lt;code class=&quot;highlighter-rouge&quot;&gt;signing_salt&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;The &lt;code class=&quot;highlighter-rouge&quot;&gt;encrypt&lt;/code&gt; flag encrypts the contents of the cookie’s value with an encryption key derived from &lt;code class=&quot;highlighter-rouge&quot;&gt;secret_key_base&lt;/code&gt; and &lt;code class=&quot;highlighter-rouge&quot;&gt;encryption_salt&lt;/code&gt;. This should always be set to &lt;code class=&quot;highlighter-rouge&quot;&gt;true&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;key_iterations&lt;/code&gt;, &lt;code class=&quot;highlighter-rouge&quot;&gt;key_length&lt;/code&gt; and &lt;code class=&quot;highlighter-rouge&quot;&gt;key_digest&lt;/code&gt; are configurations that dictate how the signing and encryption keys are derived. These are &lt;a href=&quot;https://github.com/rails/rails/blob/4-2-stable/railties/lib/rails/application.rb&quot;&gt;configured to match Rails’ defaults&lt;/a&gt; (see also: &lt;a href=&quot;https://github.com/rails/rails/blob/4-2-stable/activesupport/lib/active_support/key_generator.rb&quot;&gt;defaults&lt;/a&gt;). Unless your Rails app has custom configurations for these values, you should leave them be.&lt;/p&gt;

&lt;h3 id=&quot;step-3-configure-both-apps-to-read-from-the-new-environment-variables&quot;&gt;Step 3: Configure both apps to read from the new environment variables&lt;/h3&gt;

&lt;p&gt;Be sure your development and production versions of your app are configured with identical values for &lt;code class=&quot;highlighter-rouge&quot;&gt;DOMAIN&lt;/code&gt;, &lt;code class=&quot;highlighter-rouge&quot;&gt;SESSION_ENCRYPTED_COOKIE_SALT&lt;/code&gt; and &lt;code class=&quot;highlighter-rouge&quot;&gt;SESSION_ENCRYPTED_SIGNED_COOKIE_SALT&lt;/code&gt;. You’ll want to make sure your production apps store identical key-value pairs.&lt;/p&gt;

&lt;h3 id=&quot;step-4-change-phoenix-controllers-to-verify-sessions-based-on-session-data&quot;&gt;Step 4: Change Phoenix controllers to verify sessions based on session data.&lt;/h3&gt;

&lt;p&gt;Now when the Phoenix app receives incoming requests, it can simply look up user session data in the session cookie to determine whether the user is logged in, and who that user is.&lt;/p&gt;

&lt;p&gt;In this example, our Rails app implements user auth with Devise and Warden. We know that Warden stores the user ID and a segment of the password hash in the &lt;code class=&quot;highlighter-rouge&quot;&gt;warden.user.user.key&lt;/code&gt; session variable.&lt;/p&gt;

&lt;p&gt;Here’s what the raw session data looks like when the &lt;code class=&quot;highlighter-rouge&quot;&gt;PlugRailsCookieSessionStore&lt;/code&gt; extracts it from the cookie:&lt;/p&gt;

&lt;div class=&quot;language-elixir highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;p&quot;&gt;%{&lt;/span&gt;&lt;span class=&quot;sd&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;_csrf_token&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;sd&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;ELeSt4MBUINKi0STEBpslw3UevGZuVLUx5zGVP5NlQU=&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;sd&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;session_id&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;sd&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;17ec9b696fe76ba4a777d625e57f3521&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
  &lt;span class=&quot;sd&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;warden.user.user.key&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[[&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;sd&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;$2a$10$R/3NKl9KQViQxY8eoMCIp.&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;language-elixir highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;defmodule&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;PhoenixApp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;SomeApiResourceController&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
  &lt;span class=&quot;kn&quot;&gt;use&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;PhoenixApp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Web&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:controller&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;index&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;conn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_params&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:ok&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;user_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;load_user&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;conn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

    &lt;span class=&quot;n&quot;&gt;conn&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;|&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;assign&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:user_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;user_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;|&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;render&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;sd&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;index.html&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

  &lt;span class=&quot;n&quot;&gt;plug&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:verify_session&lt;/span&gt;

  &lt;span class=&quot;c1&quot;&gt;# If we've found a user, then allow the request to continue.&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;# Otherwise, halt the request and return a 401&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;defp&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;verify_session&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;conn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;load_user&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;conn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:ok&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;user_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;conn&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:error&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;conn&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;send_resp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;401&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;sd&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;Unauthorized&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;halt&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;defp&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;load_user&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;conn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# =&amp;gt; The Warden user storage scheme: [user_id, password_hash_truncated]&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# [[1], &quot;$2a$10$vnx35UTTJQURfqbM6srv3e&quot;]&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;warden_key&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;conn&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;get_session&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;sd&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;warden.user.user.key&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;warden_key&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;[[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;user_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:ok&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;user_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;_&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:error&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:not_found&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;A very naive plug implementation simply renders a 401 if the session key is not found in the session, otherwise it allows the request through.&lt;/p&gt;

&lt;h3 id=&quot;step-5-move-session-concerns-into-its-own-module&quot;&gt;Step 5: Move session concerns into its own module&lt;/h3&gt;

&lt;p&gt;Let’s move session concerns around session parsing out of the controller into its own &lt;code class=&quot;highlighter-rouge&quot;&gt;Session&lt;/code&gt; module. Additionally, we include two helpers, &lt;code class=&quot;highlighter-rouge&quot;&gt;current_user/1&lt;/code&gt; and &lt;code class=&quot;highlighter-rouge&quot;&gt;logged_in?/1&lt;/code&gt;.&lt;/p&gt;

&lt;div class=&quot;language-elixir highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;# web/models/session.ex&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;defmodule&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;PhoenixApp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Session&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
  &lt;span class=&quot;kn&quot;&gt;use&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;PhoenixApp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Web&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:controller&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;current_user&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;conn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# Our app's concept of a User is merely whatever is stored in the&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# Session key. In the future, we could then use this as the delegation&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# point to fetch more details about the user from a backend store.&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;load_user&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;conn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:ok&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;user_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;user_id&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:error&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:not_found&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;logged_in?&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;conn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;!!current_user&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;conn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;load_user&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;conn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# =&amp;gt; The Warden user storage scheme: [user_id, password_hash_truncated]&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# [[1], &quot;$2a$10$vnx35UTTJQURfqbM6srv3e&quot;]&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;warden_key&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;conn&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;get_session&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;sd&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;warden.user.user.key&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;warden_key&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;[[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;user_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:ok&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;user_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;_&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:error&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:not_found&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This leaves the controller looking skinnier, implementing only the Plug. Extracted methods are delegated to the new &lt;code class=&quot;highlighter-rouge&quot;&gt;Session&lt;/code&gt; module.&lt;/p&gt;

&lt;div class=&quot;language-elixir highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;defmodule&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;PhoenixApp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;SomeApiResourceController&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
  &lt;span class=&quot;kn&quot;&gt;use&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;PhoenixApp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Web&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:controller&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;alias&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;PhoenixApp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Session&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;index&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;conn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_params&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
    &lt;span class=&quot;no&quot;&gt;IO&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;inspect&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;conn&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;private&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;plug_session&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;user_id&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;Session&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;current_user&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;conn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

    &lt;span class=&quot;n&quot;&gt;conn&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;|&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;assign&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:user_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;user_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;o&quot;&gt;|&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;render&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;sd&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;index.html&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

  &lt;span class=&quot;n&quot;&gt;plug&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:verify_session&lt;/span&gt;

  &lt;span class=&quot;c1&quot;&gt;# Future refinements could extract this into its own Plug file.&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;defp&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;verify_session&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;conn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;Session&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;logged_in?&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;conn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
      &lt;span class=&quot;no&quot;&gt;false&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;conn&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;send_resp&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;401&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;sd&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;Unauthorized&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;halt&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;_&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;conn&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Finally, we implement some nice helpers for your APIs:&lt;/p&gt;

&lt;div class=&quot;language-elixir highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;# web/web.ex&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;view&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
  &lt;span class=&quot;kn&quot;&gt;quote&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# snip&lt;/span&gt;
    &lt;span class=&quot;kn&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;PhoenixApp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Session&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This gives you the ability to call &lt;code class=&quot;highlighter-rouge&quot;&gt;logged_in?(@conn)&lt;/code&gt; and &lt;code class=&quot;highlighter-rouge&quot;&gt;current_user(@conn)&lt;/code&gt; from within your views, should you desire to.&lt;/p&gt;

&lt;h3 id=&quot;step-6-fetching-additional-information-from-the-backend&quot;&gt;Step 6: Fetching additional information from the backend&lt;/h3&gt;

&lt;p&gt;Let’s enhance our &lt;code class=&quot;highlighter-rouge&quot;&gt;Session&lt;/code&gt; module with the capability to fetch additional information from another resource.&lt;/p&gt;

&lt;p&gt;In this case, we’ll model a call an external User API to fetch extended data about the User, potentially with some sensitive information (that’s why we didn’t want to serialize it into the session).&lt;/p&gt;

&lt;div class=&quot;language-elixir highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;# web/models/user.ex&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;defmodule&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;PhoenixApp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;User&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;# Gets some user identity information like email, avatar image.&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;# For this example, we'll use a random user generator.&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;#&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;# This example hits an API, but this could just as easily be something that hits&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;# the database, or Redis, or some cache.&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fetch&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;user_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;%{&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;body:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;body&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;HTTPotion&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;sd&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;https://randomuser.me/api?seed=&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;#{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;user_id&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;result&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;body&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&amp;gt;&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;Poison&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;decode!&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&amp;gt;&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;Map&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;get&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;sd&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;results&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;result&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Now our &lt;code class=&quot;highlighter-rouge&quot;&gt;Session&lt;/code&gt; can be extended to return the proper &lt;code class=&quot;highlighter-rouge&quot;&gt;User&lt;/code&gt;, which may provide more utility to us as we implement our Phoenix feature.&lt;/p&gt;

&lt;div class=&quot;language-elixir highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;defmodule&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;PhoenixApp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Session&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
  &lt;span class=&quot;kn&quot;&gt;use&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;PhoenixApp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Web&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:controller&lt;/span&gt;
  &lt;span class=&quot;n&quot;&gt;alias&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;PhoenixApp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;User&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;current_user&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;conn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;load_user&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;conn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do&lt;/span&gt;
      &lt;span class=&quot;c1&quot;&gt;# Changed current_user/1 to now return a User or a nil.&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:ok&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;user_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;user_id&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&amp;gt;&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;User&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;fetch&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:error&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;:not_found&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

  &lt;span class=&quot;c1&quot;&gt;# snip&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h4 id=&quot;heres-the-two-apps-in-action&quot;&gt;Here’s the two apps in action:&lt;/h4&gt;

&lt;p&gt;&lt;img src=&quot;http://i.imgur.com/Vu72x7C.gif&quot; alt=&quot;Flipping between the two apps, logged in and out.&quot; /&gt;&lt;/p&gt;

&lt;h3 id=&quot;heroku-deployment-gotchas&quot;&gt;Heroku deployment gotchas&lt;/h3&gt;

&lt;p&gt;If you are deploying this to Heroku with the popular &lt;a href=&quot;git@github.com:HashNuke/heroku-buildpack-elixir.git&quot;&gt;Heroku Elixir buildpack&lt;/a&gt;, please be aware that adding or changing environment variables that are required at build time require that the new environment variables outlined here are added to your &lt;code class=&quot;highlighter-rouge&quot;&gt;elixir_buildpack.config&lt;/code&gt; file in your repository.&lt;/p&gt;

&lt;div class=&quot;language-elixir highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;# elixir_buildpack.config&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;config_vars_to_export&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;SECRET_KEY_BASE&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;SESSION_ENCRYPTED_COOKIE_SALT&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;SESSION_ENCRYPTED_SIGNED_COOKIE_SALT&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;DOMAIN&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;caveats-and-considerations&quot;&gt;Caveats and considerations&lt;/h3&gt;

&lt;h4 id=&quot;csrf-incompatibilites&quot;&gt;CSRF incompatibilites&lt;/h4&gt;

&lt;p&gt;At the time of this writing, Phoenix and Rails overwrite each others’ session CSRF tokens with incompatible token schemes. This means that you are not able to make remote POST or PUT requests across the apps with CSRF protection turned on. Our current approach will work best with a read-only API, at the moment.&lt;/p&gt;

&lt;h4 id=&quot;be-judicious-about-what-you-store-in-a-cookie&quot;&gt;Be judicious about what you store in a cookie&lt;/h4&gt;

&lt;p&gt;Cookies themselves have their own strengths and drawbacks. We should note that you should be judicious about the amount of &lt;a href=&quot;http://guides.rubyonrails.org/security.html#replay-attacks-for-cookiestore-sessions&quot;&gt;data you store in a session&lt;/a&gt; (hint: only the bare minimum, and nothing sensitive).&lt;/p&gt;

&lt;p&gt;The OWASP guidelines also provide some &lt;a href=&quot;https://www.owasp.org/index.php/Session_Management_Cheat_Sheet&quot;&gt;general security practices around cookie session storage&lt;/a&gt;.&lt;/p&gt;

&lt;h4 id=&quot;moving-beyond-session-sharing&quot;&gt;Moving beyond session sharing&lt;/h4&gt;

&lt;p&gt;Even though this scheme may work in the short run, coupling our apps at this level in the long run will result in headaches as the apps are coupled to intricate session implementation details. If, in the long run, you wanted to continue scaling out your Phoenix app ecosystem, you may want to look into the following authentication patterns, both of which move your system toward a microservices architecture.&lt;/p&gt;

&lt;p&gt;1) Develop an &lt;a href=&quot;http://microservices.io/patterns/apigateway.html&quot;&gt;API gateway&lt;/a&gt; whose purpose is to be the browser’s buffer to your internal service architecture. This one gateway is responsible for identity access and control, decrypting session data and proxying requests to an umbrella of internal services (which may be Rails or Phoenix). Internal services may receive user identities in unencrypted form.&lt;/p&gt;

&lt;p&gt;2) Consider implementing a &lt;a href=&quot;https://jwt.io/&quot;&gt;JWT token implementation&lt;/a&gt; across your apps, in which &lt;a href=&quot;https://auth0.com/blog/2014/01/07/angularjs-authentication-with-cookies-vs-token/&quot;&gt;all session and authorization claims are stored in the token itself, and encrypted in the client and server.&lt;/a&gt;. This scheme may still rely on cookies (you may store the token in a cookie, or pass it around in an HTTP header). The benefits of this scheme is the ability for your app(s) to manage identity and authentication claims on their own without having to verify against a third party. Drawbacks of this scheme are &lt;a href=&quot;http://blog.prevoty.com/does-jwt-put-your-web-app-at-risk&quot;&gt;the difficulty around revoking or expiring sessions&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Each of these approaches is not without overhead and complexity; be sure to do your homework before your proceed.&lt;/p&gt;

&lt;h3 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h3&gt;

&lt;p&gt;That’s it! I hope I’ve illustrated a quick and easy way to get a working Phoenix app sharing sessions with Rails app(s), should you decide to prototype one in your existing system. I’ve also pushed up a &lt;a href=&quot;https://github.com/andrewhao/sample-rails-phoenix-shared-sessions/&quot;&gt;sample app if you want to cross-reference the code&lt;/a&gt;. Good luck!&lt;/p&gt;</content><author><name></name></author><summary type="html">You’ve resolved to build your company’s Next Big Thing in Phoenix and Elixir. That’s great! You’re facing a problem though - all user authentication and access concerns are performed on your Rails system, and the work to reimplement this in Phoenix is significant.</summary></entry><entry><title type="html">Evented Rails: Decoupling domains in Rails with Wisper pub/sub events</title><link href="http://localhost:4000/2016/06/23/rails-pub-slash-sub-with-wisper-and-sidekiq/" rel="alternate" type="text/html" title="Evented Rails: Decoupling domains in Rails with Wisper pub/sub events" /><published>2016-06-23T11:44:00-07:00</published><updated>2016-06-23T11:44:00-07:00</updated><id>http://localhost:4000/2016/06/23/rails-pub-slash-sub-with-wisper-and-sidekiq</id><content type="html" xml:base="http://localhost:4000/2016/06/23/rails-pub-slash-sub-with-wisper-and-sidekiq/">&lt;p&gt;One common pattern in Domain-Driven Design is the use of publish/subscribe messaging to communicate between domains. When &lt;a href=&quot;http://martinfowler.com/eaaDev/DomainEvent.html&quot;&gt;Domain Events&lt;/a&gt; are created from within a domain, other domains are able to subscribe to these events and take action within their own domains, respectively.&lt;/p&gt;

&lt;p&gt;This is not a common pattern in Rails, particularly because of Ruby’s lack of language support for functional programming paradigms that exist in other languages. However, with a nifty framework and the help of Sidekiq, we can get just a little bit closer.&lt;/p&gt;

&lt;h3 id=&quot;what-is-a-domain-event&quot;&gt;What is a Domain Event?&lt;/h3&gt;

&lt;p&gt;A domain event is a recorded property in the system that tracks an action that the system performs, and the factors/properties that lead to its creation.&lt;/p&gt;

&lt;p&gt;In the following examples, we are going to use the &lt;a href=&quot;https://github.com/krisleech/wisper&quot;&gt;Wisper&lt;/a&gt; gem to implement domain events in our sample &lt;a href=&quot;http://github.com/andrewhao/delorean&quot;&gt;Delorean&lt;/a&gt; app.&lt;/p&gt;

&lt;p&gt;Imagine that we are writing an endpoint that our users will hit, indicating that they want to hail a time-traveling cab. Now the logic to hail a cab is rather complicated and lives in an entirely different area of the codebase, perhaps even in another application. How should we call the other code and ensure that our code is cleanly decoupled?&lt;/p&gt;

&lt;p&gt;With our Domain-Driven powers, we’ve been smart enough to segregate our code into different subdomains and bounded contexts, denoted by these two Ruby modules &lt;code class=&quot;highlighter-rouge&quot;&gt;Ridesharing&lt;/code&gt; and &lt;code class=&quot;highlighter-rouge&quot;&gt;DriverRouting&lt;/code&gt;.&lt;/p&gt;

&lt;h2 id=&quot;example-1-in-process-pub-sub-event-modeling-with-a-service-object&quot;&gt;Example 1: In-process pub-sub event modeling, with a service object.&lt;/h2&gt;

&lt;p&gt;A simple way to use Wisper is to use it to implement your service objects with Wisper, calling the service from the controller.&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;module&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;Ridesharing&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;RidesController&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;ApplicationController&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;post&lt;/span&gt;
      &lt;span class=&quot;c1&quot;&gt;# Hail a time-traveling Delorean:&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;command&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;HailDelorean&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;new&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;command&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;on&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'hailed'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;driver&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;|&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;render&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;text: &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;Hailed you a cab: &lt;/span&gt;&lt;span class=&quot;si&quot;&gt;#{&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;driver&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt; is arriving!&quot;&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;on&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'could_not_hail'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;render&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;text: &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;Sorry, no dice.&quot;&lt;/span&gt;
      &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;command&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;hail!&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;current_user&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Note that the &lt;code class=&quot;highlighter-rouge&quot;&gt;HailDelorean&lt;/code&gt; class has powers of event subscriptions now. Our calling code does not have to concern itself with the implementation details of the &lt;code class=&quot;highlighter-rouge&quot;&gt;HailDelorean&lt;/code&gt; service - it merely needs to register handlers for the two possible outcomes, &lt;code class=&quot;highlighter-rouge&quot;&gt;hailed&lt;/code&gt; and &lt;code class=&quot;highlighter-rouge&quot;&gt;could_not_hail&lt;/code&gt;. Here’s how the service class is implemented:&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;module&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;Ridesharing&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;HailDelorean&lt;/span&gt;
    &lt;span class=&quot;kp&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;Wisper&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Publisher&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;hail!&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;user&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;c1&quot;&gt;# broadcast() is a Wisper method to fire an event&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;driver&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;find_driver&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;user&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;driver&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;broadcast&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'hailed'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;driver&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;broadcast&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'could_not_hail'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;find_driver&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;user&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;c1&quot;&gt;# Here lies slow, complex domain logic&lt;/span&gt;
      &lt;span class=&quot;no&quot;&gt;DriverRouting&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;FindDriver&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;new&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;user&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;handling-side-effects-in-subscriber-classes&quot;&gt;Handling side effects in subscriber classes&lt;/h3&gt;

&lt;p&gt;Other side-effects can subscribe to the &lt;code class=&quot;highlighter-rouge&quot;&gt;HailDelorean&lt;/code&gt; events. Let’s say we want to fire an event to Segment analytics tracking. I can create a plain Ruby object that simply needs to implement a method with the same name as the event.&lt;/p&gt;

&lt;p&gt;Let’s implement &lt;code class=&quot;highlighter-rouge&quot;&gt;hailed&lt;/code&gt; and &lt;code class=&quot;highlighter-rouge&quot;&gt;could_not_hail&lt;/code&gt; methods on this subscriber class:&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;TrackSegmentAnalytics&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;hailed&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;driver&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# fire analytics event to Segment&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;could_not_hail&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# fire analytics event to Segment&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And we hook it up by subscribing it to the command handler:&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;module&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;Ridesharing&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;RidesController&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;ApplicationController&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;post&lt;/span&gt;
      &lt;span class=&quot;c1&quot;&gt;# snip&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;command&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;HailDelorean&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;new&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;current_user&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

      &lt;span class=&quot;c1&quot;&gt;# register the subscriber to the triggering action&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;command&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;subscribe&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;TrackSegmentAnalytics&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;c1&quot;&gt;# snip&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;OK, that was a little awkward, doing all that wiring up in the controller. What if we did the wiring globally, within an app initializer?&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;# config/initializers/domain_event_subscriptions.rb&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;Wisper&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;subscribe&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;TrackSegmentAnalytics&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;scope: &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;HailDelorean&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;# alternate form:&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;HailDelorean&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;subscribe&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;TrackSegmentAnalytics&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This registers a global subscriber for all future instances of &lt;code class=&quot;highlighter-rouge&quot;&gt;HailDelorean&lt;/code&gt;.&lt;/p&gt;

&lt;h2 id=&quot;example-2-asynchronous-events-with-subscription-handlers-and-sidekiq&quot;&gt;Example 2: Asynchronous events with subscription handlers and Sidekiq&lt;/h2&gt;

&lt;p&gt;Here’s the real power of Wisper - we can decouple our application domain responsibilities by modeling effects as subscription objects and do them out-of-band of the primary web request thread.&lt;/p&gt;

&lt;p&gt;Note that with the &lt;a href=&quot;https://github.com/krisleech/wisper-sidekiq&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;wisper-sidekiq&lt;/code&gt;&lt;/a&gt; gem, all subscriptions given with an &lt;code class=&quot;highlighter-rouge&quot;&gt;async: true&lt;/code&gt; option flag will automatically execute in an external thread as a Sidekiq job. Let’s take advantage of that now.&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;module&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;Ridesharing&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;RidesController&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;ApplicationController&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;post&lt;/span&gt;
      &lt;span class=&quot;c1&quot;&gt;# Hail a time-traveling Delorean:&lt;/span&gt;
      &lt;span class=&quot;no&quot;&gt;HailDelorean&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;hail&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;current_user&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;render&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;text: &lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'Hailing a cab, please wait for a response...'&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;HailDelorean&lt;/span&gt;
    &lt;span class=&quot;kp&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;Wisper&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Broadcaster&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;hail&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;passenger_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;broadcast&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:hail&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;passenger_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;module&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;DriverRouting&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;# Note that this class is both a subscriber and a publisher&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;FindDriver&lt;/span&gt;
    &lt;span class=&quot;kp&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;Wisper&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Publisher&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;hail&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;passenger_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;c1&quot;&gt;# Do slow, complex hairy routefinding/optimization/messaging behind the scenes:&lt;/span&gt;
      &lt;span class=&quot;n&quot;&gt;driver&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;find_driver_for&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;passenger_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

      &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;driver&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;broadcast&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'driver_found'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;passenger_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;driver&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;broadcast&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'driver_not_found'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;passenger_id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Finally, we add handlers (subscribers) to these domain objects:&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;module&lt;/span&gt; &lt;span class=&quot;nn&quot;&gt;Ridesharing&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;NotifyPassengerWithDriverStatus&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;driver_found&lt;/span&gt;
      &lt;span class=&quot;c1&quot;&gt;# send them a text message :)&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;self&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;driver_not_found&lt;/span&gt;
      &lt;span class=&quot;c1&quot;&gt;# send them a text message :(&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Now let’s link it together with subscriptions:&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c1&quot;&gt;# config/initializers/domain_event_subscriptions.rb&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;Ridesharing&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;HailDelorean&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;subscribe&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;DriverRouting&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;FindDriver&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;async: &lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;DriverRouting&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;FindDriver&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;subscribe&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;Ridesharing&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;NotifyPassengerWithDriverStatus&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;async: &lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;no&quot;&gt;Wisper&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;subscribe&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;AnalyticsListener&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;scope: &lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;Ridesharing::NotifyPassengerWithDriverStatus&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;DriverRouting::FindDriver&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;],&lt;/span&gt; &lt;span class=&quot;ss&quot;&gt;async: &lt;/span&gt;&lt;span class=&quot;kp&quot;&gt;true&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Now our messages between our domains are pulled out of the main request thread, and operate in an asynchronous fashion with Sidekiq as the runner.&lt;/p&gt;

&lt;p&gt;Code in our domains are kept clean - note that there are no direct references to the other subdomains within each subdomain. Our app more cleanly segregates the responsibilities between each app, heavy workloads are naturally balanced as they move to worker threads.&lt;/p&gt;

&lt;h2 id=&quot;caveats-beware-of-overbuilding&quot;&gt;Caveats: Beware of overbuilding&lt;/h2&gt;

&lt;p&gt;If you are on a small app, you probably should go with approach #1. The weight of indirection can be a cognitive load on development, unless you truly need to build async code in #2. The overhead and conceptual complexities of the approach can only be justified with large codebases, or in apps where a domain-centric view (and segregation) of code is present.&lt;/p&gt;

&lt;h2 id=&quot;caveats-event-subscriptions-can-be-a-tangled-mess&quot;&gt;Caveats: Event subscriptions can be a tangled mess&lt;/h2&gt;

&lt;p&gt;Note that the act of wiring can quickly fan out into a spidery mess of handlers - you could even further decouple your handlers by modeling a global event bus as a publisher, and having each domain tap into the bus’ events and figure out how to handle each event on its own.&lt;/p&gt;

&lt;h2 id=&quot;caveats-transactional-consistency&quot;&gt;Caveats: transactional consistency!&lt;/h2&gt;

&lt;p&gt;If you implement this asynchronously, you’ll have to think about how to deal with transactional consistency. Can you design your data models (and database schema) to support independent updates without any dependencies? How will you handle the case when one domain action fails and the other completes?&lt;/p&gt;

&lt;p&gt;You may have to roll your own two-phase commit here, the specifics of which I won’t delve into. However, for most of our applications, we may want to skip the asynchronous and keep our events synchronous.&lt;/p&gt;</content><author><name></name></author><summary type="html">One common pattern in Domain-Driven Design is the use of publish/subscribe messaging to communicate between domains. When Domain Events are created from within a domain, other domains are able to subscribe to these events and take action within their own domains, respectively.</summary></entry><entry><title type="html">Domain-Driven Design &amp;amp; The Joy of Naming</title><link href="http://localhost:4000/2016/04/18/the-joy-of-naming-with-the-powers-of-domain-driven-design/" rel="alternate" type="text/html" title="Domain-Driven Design &amp; The Joy of Naming" /><published>2016-04-18T17:14:00-07:00</published><updated>2016-04-18T17:14:00-07:00</updated><id>http://localhost:4000/2016/04/18/the-joy-of-naming-with-the-powers-of-domain-driven-design</id><content type="html" xml:base="http://localhost:4000/2016/04/18/the-joy-of-naming-with-the-powers-of-domain-driven-design/">&lt;p&gt;I want to discuss a topic near and dear to my heart, and what I believe is at the crux of effective software design. It’s not a new functional language, it’s not a fancy new framework, a how-to guide to do microservices, nor a quantum leap in the field of machine learning.&lt;/p&gt;

&lt;p&gt;It’s much simpler.&lt;/p&gt;

&lt;p&gt;It’s about names.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;http://3.bp.blogspot.com/_rL73HKlqbH0/TKhVHMbs2oI/AAAAAAAABEc/DiPbblM0R44/s1600/sistine-chapel-michelangelo-paintings-6.jpg&quot; alt=&quot;In the beginning...&quot; /&gt;&lt;/p&gt;

&lt;p&gt;&lt;em&gt;Names define us&lt;/em&gt;. They define concepts. They imbue a concept with shared understanding. They’re language concepts, but more than that, they’re units of meaning.&lt;/p&gt;

&lt;p&gt;Software development is a fundamentally human endeavour. No amount of technical computing breakthroughs will change the fact that software development is still the arduous task of getting a team together full of humans from a kaleidescope of different cultural, linguistic backgrounds - then throwing them together to build an arbitrarily complex product in a rapidly-shifting competitive landscape.&lt;/p&gt;

&lt;p&gt;Not only that, the thing to build is chock-full of systems that interact with other systems of unbounded complexity. Additionally, once your software system is out in the wild, you need to make sure that it was the right thing to build. Is the product you built correctly tuned to your market? Is it generating sufficient revenue?&lt;/p&gt;

&lt;p&gt;The landscape is littered with software projects that began ambitiously, but got lost in a towering mess of fragile code. It’s no wonder that developing reliable, successful software is more art than science.&lt;/p&gt;

&lt;h3 id=&quot;crossing-our-linguistic-wires&quot;&gt;Crossing our linguistic wires&lt;/h3&gt;

&lt;p&gt;Let’s rewind back to a scene from a typical day in the life of your software development team. Think back to the last time you discussed a story with your product owner, how did it unfold?&lt;/p&gt;

&lt;p&gt;Let’s imagine a scene at Delorean, the Uber for time travel, where you work. Your team is responsible for writing software systems that calculate the payment processing for your users who are hailing rides from your company’s time-traveling ridesharing service.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;PO: Our next big project is to update our driver app to show rider locations on the timeline map.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;
  &lt;p&gt;You: And when do these riders show up on the timeline map?&lt;/p&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;
  &lt;p&gt;PO: When the driver turns on the app and signals that she’s driving.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;
  &lt;p&gt;You: OK, so that means when the app boots up and the DriverStatus service receives a POST we’ll need to simultaneously fetch references from the HailingUser service based on time locality.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;
  &lt;p&gt;PO: Um… I guess so?&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Or how about your last iteration planning meeting, where you discussed the intricacies of a specific story?&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;PO: In this story, we’re going to add a coupon box to the checkout flow.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;
  &lt;p&gt;You: [Thinking out loud] Hm… would that mean we add a &lt;code class=&quot;highlighter-rouge&quot;&gt;/coupon&lt;/code&gt; route to the checkout API?&lt;/p&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;
  &lt;p&gt;Teammate: Wait - I think we call them &lt;code class=&quot;highlighter-rouge&quot;&gt;Discounts&lt;/code&gt; in the backend. And the checkout flow is technically part of the &lt;code class=&quot;highlighter-rouge&quot;&gt;RideCommerce&lt;/code&gt; service.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;
  &lt;p&gt;You: Right - I mean let’s call the route &lt;code class=&quot;highlighter-rouge&quot;&gt;/coupon&lt;/code&gt; but it’ll create a &lt;code class=&quot;highlighter-rouge&quot;&gt;Discount&lt;/code&gt; object. And in this story,    let’s just remember that the checkout API really refers to the &lt;code class=&quot;highlighter-rouge&quot;&gt;RideCommerce&lt;/code&gt; service.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;
  &lt;p&gt;PO: I’ll add a note to the story.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;The implementing engineer, of course, doesn’t read the note in the story (who has time to, anyways?). In the course of implementation, he gets tripped up in semantics and spends the better part of a half day re-implementing the &lt;code class=&quot;highlighter-rouge&quot;&gt;Checkout&lt;/code&gt; flow as an entirely new service, before realizing his mistake in code review and backing out his changes.&lt;/p&gt;

&lt;p&gt;Months later, a new colleague is tasked to fix the link in the checkout flow, but files an incomplete fix because she was not aware of the fact that &lt;code class=&quot;highlighter-rouge&quot;&gt;Coupons&lt;/code&gt; actually had mappings back to &lt;code class=&quot;highlighter-rouge&quot;&gt;Discounts&lt;/code&gt;. The bug makes its way to production, where it subtly lies dormant until a most inopportune time…&lt;/p&gt;

&lt;h3 id=&quot;a-better-domain-driven-way&quot;&gt;A better, Domain-Driven way&lt;/h3&gt;

&lt;p&gt;In Eric Evans’ book &lt;a href=&quot;http://www.amazon.com/Domain-Driven-Design-Tackling-Complexity-Software/dp/0321125215&quot;&gt;&lt;strong&gt;Domain-Driven Design&lt;/strong&gt;&lt;/a&gt;, he describes the concept of a &lt;a href=&quot;http://martinfowler.com/bliki/UbiquitousLanguage.html&quot;&gt;Ubiquitous Language&lt;/a&gt; - a shared, common vocabulary that the entire team shares when discussing software.&lt;/p&gt;

&lt;p&gt;When we say the “entire team”, we mean the combined team of designers, developers, the product owner and any other domain experts that might be at hand.&lt;/p&gt;

&lt;p&gt;Your product owner may be your domain expert (and typically is). However, you may have other domain experts such as:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Any team that builds reporting or analytics off of your software.&lt;/li&gt;
  &lt;li&gt;Upstream data providers&lt;/li&gt;
  &lt;li&gt;Anybody further up the reporting chain whose purview includes the software you’re building, or its effects. Think: the Director of Finance, the COO, the head of Customer Support.&lt;/li&gt;
  &lt;li&gt;The users of your software&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Side note: in XP, each team has an “onsite customer” - this is your domain expert!&lt;/p&gt;

&lt;h4 id=&quot;developing-a-ubiquitous-language-with-a-glossary&quot;&gt;Developing a Ubiquitous Language with a Glossary&lt;/h4&gt;

&lt;p&gt;Try this: keep a living document of all the terminology your team uses - along with all its definitions. This &lt;strong&gt;Glossary&lt;/strong&gt; is exactly what it sounds - a list of terms and their definitions.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;h2 id=&quot;delorean-team-glossary&quot;&gt;Delorean Team Glossary&lt;/h2&gt;

  &lt;ul&gt;
    &lt;li&gt;&lt;strong&gt;Coupon&lt;/strong&gt;: an applied discount to a BookingAmount. A coupon may take the form of a Fixed or a Percentage amount.
      &lt;ul&gt;
        &lt;li&gt;&lt;strong&gt;Fixed-type&lt;/strong&gt;: A coupon that applies a fixed amount of money - e.g. a $30 USD discount.&lt;/li&gt;
        &lt;li&gt;&lt;strong&gt;Percentage-type&lt;/strong&gt;: A coupon that applies a percentage savings off the total BookingAmount.&lt;/li&gt;
      &lt;/ul&gt;
    &lt;/li&gt;
    &lt;li&gt;&lt;strong&gt;Driver&lt;/strong&gt;: An employed driver who drives within the system, picking up passengers and driving Trips for payment.&lt;/li&gt;
    &lt;li&gt;&lt;strong&gt;Trip&lt;/strong&gt;: An itinerary of passenger pick-up and drop-off location and times.&lt;/li&gt;
    &lt;li&gt;&lt;strong&gt;Rider&lt;/strong&gt;: The passenger that books the trip and is transported by the &lt;em&gt;Driver&lt;/em&gt;.&lt;/li&gt;
    &lt;li&gt;&lt;strong&gt;Booking&lt;/strong&gt;: A reservation for a Trip, as booked by the &lt;em&gt;Rider&lt;/em&gt;.&lt;/li&gt;
    &lt;li&gt;&lt;strong&gt;BookingAmount&lt;/strong&gt;: The monetary amount of the Trip, accounting for the trip cost, surge pricing, coupons and taxes.&lt;/li&gt;
    &lt;li&gt;&lt;strong&gt;Routing Engine:&lt;/strong&gt; The software system that maps out the driving directions for a driver.&lt;/li&gt;
    &lt;li&gt;&lt;strong&gt;Payment&lt;/strong&gt;: A record of how a user paid.&lt;/li&gt;
    &lt;li&gt;&lt;strong&gt;Charge&lt;/strong&gt;: A financial transaction for a specific dollar amount, for a specific charge method to an institution.&lt;/li&gt;
    &lt;li&gt;&lt;strong&gt;Checkout&lt;/strong&gt;: A workflow in which a &lt;em&gt;Payment&lt;/em&gt; is made for a &lt;em&gt;Booking&lt;/em&gt;.&lt;/li&gt;
  &lt;/ul&gt;
&lt;/blockquote&gt;

&lt;p&gt;From now on, use only the term definitions listed here in your stories. Be explicit about how you use your language!&lt;/p&gt;

&lt;p&gt;I’ve been on many projects where the sloppy usage of a term from project inception led to the usage of that term in the code - codifying that messy, slippery term throughout the life of the project.&lt;/p&gt;

&lt;p&gt;Which leads us to our next point:&lt;/p&gt;

&lt;h4 id=&quot;refactoring-your-team-to-use-the-right-terms&quot;&gt;Refactoring your team to use the right terms&lt;/h4&gt;

&lt;p&gt;Your &lt;strong&gt;Glossary&lt;/strong&gt; is a living document. It is meant to be living - either on a continually-updated Google Doc or a wiki page. It should be visible for all to see - you should print it out and post it on the walls!&lt;/p&gt;

&lt;p&gt;Meanwhile, in a planning meeting:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;You: So when a user logs into the app and broadcasts that they’re ready to drive…&lt;/p&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;
  &lt;p&gt;PO: You mean &lt;em&gt;Driver&lt;/em&gt;. When a &lt;em&gt;Driver&lt;/em&gt; logs in.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;
  &lt;p&gt;You: Right. Good catch.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;It seems a little silly (after all, you both know only Drivers use the broadcast feature of the app), but the laser focus on using the right words means that your team is always on the same page when talking about things.&lt;/p&gt;

&lt;p&gt;Later that afternoon, your teammate taps you on the shoulder:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Teammate: I’m about to implement the Coupon story. I suggest we rename the &lt;code class=&quot;highlighter-rouge&quot;&gt;Discount&lt;/code&gt; class to &lt;code class=&quot;highlighter-rouge&quot;&gt;Coupon&lt;/code&gt;.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;
  &lt;p&gt;You: Great idea. That way, we aren’t tripped up by the naming mismatches in the future.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;
  &lt;p&gt;Teammate: I do have a question about the coupon, though. Do you think it’s &lt;em&gt;applied&lt;/em&gt; to the &lt;strong&gt;BookingAmount&lt;/strong&gt;, or is it &lt;em&gt;added&lt;/em&gt;?&lt;/p&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;
  &lt;p&gt;PO: [Overhearing conversation] You had it right. It’s &lt;em&gt;applied&lt;/em&gt;.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;You and your teammate then go and update the glossary, scribbling an addendum on the wall (or updating your wiki):&lt;/p&gt;

&lt;blockquote&gt;
  &lt;h2 id=&quot;delorean-team-glossary-1&quot;&gt;Delorean Team Glossary&lt;/h2&gt;
  &lt;ul&gt;
    &lt;li&gt;&lt;strong&gt;Coupon&lt;/strong&gt;: … Coupons may be &lt;em&gt;applied&lt;/em&gt; to BookingAmounts to discount the total cost of the booking.&lt;/li&gt;
  &lt;/ul&gt;
&lt;/blockquote&gt;

&lt;h4 id=&quot;refactoring-your-code-to-use-the-right-terms&quot;&gt;Refactoring your code to use the right terms&lt;/h4&gt;

&lt;p&gt;Your teammate and you then walk over to her desk; as a pair you proceed to refactor the existing account code. We’ll use Ruby for the sake of this example.&lt;/p&gt;

&lt;p&gt;In the beginning, the code looks like this:&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Checkout&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;initialize&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;booking_amount&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;discount&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;vi&quot;&gt;@booking_amount&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;booking_amount&lt;/span&gt;
    &lt;span class=&quot;vi&quot;&gt;@discount&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;discount&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;total&lt;/span&gt;
    &lt;span class=&quot;vi&quot;&gt;@booking_amount&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;total&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;vi&quot;&gt;@discount&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;calculate_amount_for&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;booking_amount: &lt;/span&gt;&lt;span class=&quot;n&quot;&gt;booking_amount&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Discount&lt;/span&gt;
  &lt;span class=&quot;no&quot;&gt;STRATEGY_FIXED&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'STRATEGY_FIXED'&lt;/span&gt;
  &lt;span class=&quot;no&quot;&gt;STRATEGY_PERCENTAGE&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'STRATEGY_PERCENTAGE'&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;initialize&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;amount&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;strategy&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;vi&quot;&gt;@amount&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;amount&lt;/span&gt;
    &lt;span class=&quot;vi&quot;&gt;@strategy&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;strategy&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;calculate_amount_for&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;booking_amount&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:)&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# Implementation...&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;You take a first pass and rename the &lt;code class=&quot;highlighter-rouge&quot;&gt;Discount&lt;/code&gt; class to &lt;code class=&quot;highlighter-rouge&quot;&gt;Coupon&lt;/code&gt;.&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Coupon&lt;/span&gt;
  &lt;span class=&quot;no&quot;&gt;STRATEGY_FIXED&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'STRATEGY_FIXED'&lt;/span&gt;
  &lt;span class=&quot;no&quot;&gt;STRATEGY_PERCENTAGE&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'STRATEGY_PERCENTAGE'&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;initialize&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;amount&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;strategy&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;vi&quot;&gt;@amount&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;amount&lt;/span&gt;
    &lt;span class=&quot;vi&quot;&gt;@strategy&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;strategy&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;calculate_amount_for&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;booking_amount&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:)&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# Implementation...&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Now there’s something funny here - your domain language suggests that a &lt;strong&gt;Coupon&lt;/strong&gt; is &lt;em&gt;applied to&lt;/em&gt; a &lt;strong&gt;BookingAmount&lt;/strong&gt;. You pause, because the code reads the opposite - “A Coupon calculates its amount for a BookingAmount”.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;You: How about we also refactor the &lt;code class=&quot;highlighter-rouge&quot;&gt;calculate_amount_for&lt;/code&gt; method to reflect the language a little better?&lt;/p&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;
  &lt;p&gt;Teammate: Yeah. It sounds like the action occurs the other way - the BookingAmount is responsible for applying a Coupon to itself.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;In your next refactoring pass, you move the &lt;code class=&quot;highlighter-rouge&quot;&gt;calculate_amount_for&lt;/code&gt; method into the &lt;code class=&quot;highlighter-rouge&quot;&gt;BookingAmount&lt;/code&gt;, calling it &lt;code class=&quot;highlighter-rouge&quot;&gt;applied_discount_total&lt;/code&gt;:&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;BookingAmount&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;# implementation details...&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;applied_coupon_amount&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;coupon&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:)&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;# Implementation...&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Finally, you change your &lt;code class=&quot;highlighter-rouge&quot;&gt;Checkout&lt;/code&gt; implementation to match:&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Checkout&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;initialize&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;booking_amount&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;coupon&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;vi&quot;&gt;@booking_amount&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;booking_amount&lt;/span&gt;
    &lt;span class=&quot;vi&quot;&gt;@coupon&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;coupon&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;total_amount&lt;/span&gt;
    &lt;span class=&quot;vi&quot;&gt;@booking_amount&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;price&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;vi&quot;&gt;@booking_amount&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;applied_coupon_amount&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;coupon: &lt;/span&gt;&lt;span class=&quot;vi&quot;&gt;@coupon&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;When you read the implementation in plain English, it reads:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;The checkout’s total amount is calculated by subtracting the booking amount’s applied coupon amount from the booking amount price.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Phew! Designing a strong &lt;strong&gt;Ubiquitous Language&lt;/strong&gt; was hard work! In fact, you had spent a goodly amount of time debating and clarifying with your domain experts:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Is a Coupon &lt;em&gt;applied&lt;/em&gt; to a BookingAmount, or is it &lt;em&gt;discounted from&lt;/em&gt; one?&lt;/li&gt;
  &lt;li&gt;Should we call it a Coupon &lt;em&gt;amount&lt;/em&gt;, or a Coupon &lt;em&gt;cost&lt;/em&gt;?&lt;/li&gt;
  &lt;li&gt;Is the pre-tax, pre-discount amount in the BookingAmount called a &lt;em&gt;price&lt;/em&gt;, or a &lt;em&gt;cost&lt;/em&gt;?&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Whatever you agreed on, that’s what you changed your code to reflect.&lt;/p&gt;

&lt;h4 id=&quot;continual-refinement&quot;&gt;Continual refinement&lt;/h4&gt;

&lt;p&gt;Hm. Something still feels off.&lt;/p&gt;

&lt;p&gt;You and your teammate feel your OOP spidey senses going haywire.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Teammate: Hm. I guess that worked, but that’s still not exactly as clean as we wanted it. Isn’t it kind of weird how the Checkout owns the calculation for the calculation of a discount?&lt;/p&gt;
&lt;/blockquote&gt;

&lt;blockquote&gt;
  &lt;p&gt;You: Yeah, I see where you’re coming from. That’s just not good OO design. Additionally, if we notice the language our domain experts were using, they didn’t mention that the checkout total was some subtraction of something from another thing. The Checkout’s total simply is the order amount, after application of a Coupon.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Your partner and you take one last step:&lt;/p&gt;

&lt;div class=&quot;language-ruby highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Checkout&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;initialize&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;booking_amount&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;coupon&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;vi&quot;&gt;@booking_amount&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;booking_amount&lt;/span&gt;
    &lt;span class=&quot;vi&quot;&gt;@booking_amount&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;apply!&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;coupon&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;total_amount&lt;/span&gt;
    &lt;span class=&quot;vi&quot;&gt;@booking_amount&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;amount&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;


&lt;span class=&quot;k&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;BookingAmount&lt;/span&gt;
  &lt;span class=&quot;c1&quot;&gt;# Implementation...&lt;/span&gt;

  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;apply!&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;coupon&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;vi&quot;&gt;@coupons&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;coupon&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
  
  &lt;span class=&quot;k&quot;&gt;def&lt;/span&gt; &lt;span class=&quot;nf&quot;&gt;amount&lt;/span&gt;
    &lt;span class=&quot;vi&quot;&gt;@amount&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&lt;/span&gt; &lt;span class=&quot;vi&quot;&gt;@coupons&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;sum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;ss&quot;&gt;:amount&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;You sit back and read it back, out loud:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;The checkout’s total amount is the BookingAmount after a Coupon has been applied.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;You both smile. Much better.&lt;/p&gt;

&lt;h3 id=&quot;in-closing&quot;&gt;In closing…&lt;/h3&gt;

&lt;p&gt;In this brief time we had together,&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;We discussed why names are important - especially in a complex endeavour like software development.&lt;/li&gt;
  &lt;li&gt;We covered why it’s important to arrive at a shared understanding, together as a team, using the same words and vocabulary.&lt;/li&gt;
  &lt;li&gt;We discovered how to build and integrate a &lt;strong&gt;Glossary&lt;/strong&gt; into the daily rhythm of our team&lt;/li&gt;
  &lt;li&gt;We refactored the code twice - illustrating how to get code in line with the domain language.&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;and-there-is-much-more&quot;&gt;And there is much more!&lt;/h3&gt;

&lt;p&gt;In an upcoming post, we’ll investigate how the &lt;strong&gt;Ubiquitous Language&lt;/strong&gt; applies to a core concept of Domain-Driven Design: the &lt;strong&gt;Bounded Context&lt;/strong&gt;. Why is that important? Because Bounded Contexts give us tools to organize our code - and to do further advanced things like &lt;a href=&quot;https://speakerdeck.com/andrewhao/ddd-rail-your-monorail&quot;&gt;break up monoliths into services&lt;/a&gt;.&lt;/p&gt;

&lt;script async=&quot;&quot; class=&quot;speakerdeck-embed&quot; data-id=&quot;1e6dd8983891467381036a321cd274a9&quot; data-ratio=&quot;1.77777777777778&quot; src=&quot;//speakerdeck.com/assets/embed.js&quot;&gt;&lt;/script&gt;</content><author><name></name></author><summary type="html">I want to discuss a topic near and dear to my heart, and what I believe is at the crux of effective software design. It’s not a new functional language, it’s not a fancy new framework, a how-to guide to do microservices, nor a quantum leap in the field of machine learning.</summary></entry><entry><title type="html">Knex.js and PostGIS cheat sheet</title><link href="http://localhost:4000/2016/04/08/knex-dot-js-and-bookshelf-dot-js-cheat-sheet/" rel="alternate" type="text/html" title="Knex.js and PostGIS cheat sheet" /><published>2016-04-08T12:33:00-07:00</published><updated>2016-04-08T12:33:00-07:00</updated><id>http://localhost:4000/2016/04/08/knex-dot-js-and-bookshelf-dot-js-cheat-sheet</id><content type="html" xml:base="http://localhost:4000/2016/04/08/knex-dot-js-and-bookshelf-dot-js-cheat-sheet/">&lt;p&gt;As follows are some code snippets for using &lt;a href=&quot;http://knexjs.org/&quot;&gt;Knex.js&lt;/a&gt; for executing Postgres and PostGIS queries.&lt;/p&gt;

&lt;h3 id=&quot;execute-raw-sql-in-migration&quot;&gt;Execute raw SQL in migration&lt;/h3&gt;

&lt;p&gt;I often find this useful for fancy SQL, like creating views.&lt;/p&gt;

&lt;div class=&quot;language-js highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nx&quot;&gt;exports&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;up&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;knex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;Promise&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;knex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;raw&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;`YOUR RAW SQL`&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;};&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;add-a-postgis-point-type-to-a-table-in-a-migration&quot;&gt;Add a PostGIS Point type to a table in a migration:&lt;/h3&gt;

&lt;div class=&quot;language-js highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;knex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;schema&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;table&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'events'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;table&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;nx&quot;&gt;table&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;specificType&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'point'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'geometry(point, 4326)'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;})&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;add-a-foreign-key-to-another-table&quot;&gt;Add a foreign key to another table.&lt;/h3&gt;

&lt;div class=&quot;language-js highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;knex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;schema&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;table&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'events'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;table&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;nx&quot;&gt;table&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;integer&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'device_id'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;references&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'id'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;inTable&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'devices'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;});&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;add-a-multi-column-unique-index&quot;&gt;Add a multi-column unique index&lt;/h3&gt;

&lt;div class=&quot;language-js highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;knex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;schema&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;table&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'events'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;function&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;table&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;nx&quot;&gt;table&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;unique&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;([&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'start_time'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'end_time'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'start_location'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'end_location'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'distance_miles'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]);&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;});&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;find-a-collection&quot;&gt;Find a collection&lt;/h3&gt;

&lt;div class=&quot;language-js highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nx&quot;&gt;knex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;select&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'*'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;from&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'participants'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;where&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;({&lt;/span&gt; &lt;span class=&quot;na&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'Jason'&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;})&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;andWhere&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'age'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'&amp;gt;='&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;20&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;custom-operations-in-select-clause&quot;&gt;Custom operations in SELECT clause&lt;/h3&gt;

&lt;div class=&quot;language-js highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nx&quot;&gt;knex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'trips'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;select&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;knex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;raw&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'miles * passengers as passenger_miles'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;select&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;knex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;raw&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;CONCAT('Hello, ', name) as greeting_message&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;return-postgis-data-from-a-spatial-column&quot;&gt;Return PostGIS data from a spatial column:&lt;/h3&gt;

&lt;p&gt;We use &lt;a href=&quot;https://github.com/jfgodoy/knex-postgis&quot;&gt;knex-postgis&lt;/a&gt; to gain access to PostGIS functions in Postgres. Here, we return a ‘point’ column with &lt;code class=&quot;highlighter-rouge&quot;&gt;ST_AsGeoJSON&lt;/code&gt;:&lt;/p&gt;

&lt;div class=&quot;language-js highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;kd&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;knexPostgis&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;require&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'knex-postgis'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;knex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;nx&quot;&gt;knex&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'events'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;select&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'*'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;knexPostgis&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;asGeoJSON&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'point'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;));&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;See &lt;a href=&quot;https://github.com/jfgodoy/knex-postgis&quot;&gt;knex-postgis&lt;/a&gt; documentation for a list of other PostGIS functions that are supported.&lt;/p&gt;</content><author><name></name></author><summary type="html">As follows are some code snippets for using Knex.js for executing Postgres and PostGIS queries.</summary></entry></feed>