
<!doctype html>
<!-- START OF _layouts/default.html -->
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible" >
		<meta content="width=device-width,initial-scale=1" name="viewport">
		<meta content="Andrew Hao's thoughts on software engineering, team leadership & product design." name="description">
		<meta content="The Sweet Spot" name="author">

		<title>The Sweet Spot</title>

		<!-- Styles -->
		<link href="/stylesheets/main.css" rel="stylesheet">

		<!-- Google webfonts -->
    <link href="https://fonts.googleapis.com/css?family=Cousine|Suez+One|Yellowtail|Space+Mono|Alike+Angular" rel="stylesheet">

		<!-- jQuery and plugins -->
		<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
		<script src="/js/jquery.zclip.min.js"></script>

		<!-- Syntax highlighter -->
		<link href="/stylesheets/prettify-hemisu.css" type="text/css" rel="stylesheet" />
    <script type="text/javascript" src="/js/prettify.js"></script>

    <link href="/atom.xml" rel="alternate" title="The Sweet Spot" type="application/atom+xml">
    
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-2330913-9']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>



  </head>

	<body onload="prettyPrint()">
		<div class="wrap">

			<header>
        <a href="/"><div class="title">The Sweet Spot</div></a>
				<div class="subtitle">On software, engineering leadership, and anything shiny.</div>

				<div class="navi">
					<ul>
						<li><a href="/blog/archives">Articles</a></li>
						<li><a href="/talks">Talks</a></li>
						<li><a href="/notes">Conference Notes</a></li>
						<li><a href="https://www.github.com/andrewhao">Github</a></li>
						<li><a href="https://twitter.com/andrewhao">Twitter</a></li>
					</ul>
				</div> <!-- // .navi -->
			</header>

				<!-- START OF index.html -->

	
		
		<!-- START OF _includes/article.html -->
<article>
	<header>
		<h1><a href="/2015/06/29/notes-on-performance-tuning-a-puma-server/">Notes on performance tuning a Puma server</a></h1>
		<time>29 June 2015</time>
	</header>
		<div class="content">
			<p>A couple of months ago, I was tuning a Rails app for one of our clients.<br />
This client wanted to know how performant their app would be under load.</p>

<p>To do that, you can do several different things:</p>

<ol>
  <li>Tune the thread/process balance within the VM</li>
  <li>Horizontally scale with your cloud platform.</li>
</ol>

<p>This is a discussion of the former (#1):</p>

<h2 id="set-up-the-test">1) Set up the test</h2>

<h3 id="drive-with-a-synthetic-script">Drive with a synthetic script</h3>

<p>Our application had a synthetic load driver that would run Selenium to<br />
execute various app tasks. This synthetic driver could be parallelized<br />
across many notes via Rainforest QA, Sauce Labs or Browserify.</p>

<p>In our case, I only needed to run our synthetic load script on a single<br />
node in multiple processes, which simulated enough load to anticipate<br />
another order of magnitude of traffic.</p>

<h3 id="know-how-to-inspect-the-server-under-load">Know how to inspect the server under load.</h3>

<p>Commands you will want to know:</p>

<pre><code>$ free -m # Find the total amount of free memory on your machine
$ ps uH p &lt;pid&gt; # List out process threads
$ kill -TTIN &lt;puma_master_pid&gt; # Add a puma worker
$ kill -TTOU &lt;puma_master_pid&gt; # Remove a puma worker
$ kill -USR2 &lt;puma_master_pid&gt; # Kill the puma master &amp; workers
</code></pre>

<h2 id="generating-more-load-use-external-load-testing-services-or-plain-tools">Generating more load: use external load testing services, or plain tools.</h2>

<p>Try using <a href="http://www.flood.io">Flood.io</a> or JMeter for performance load.</p>

<p>I tried looking into the <a href="https://github.com/schneems/puma_auto_tune">puma_auto_tune</a> gem, but it required a higher level of production instrumentation than I was ready to give it.</p>

<h2 id="analysis-new-relic-scalability-analysis">Analysis: New Relic scalability analysis</h2>

<p>New Relic gave us a scalability analysis scatter plot, plotting<br />
throughput against average application response time. In essence, it<br />
allows you to see spikes in response times as correlated to throughput.</p>

<h2 id="process">Process:</h2>

<p>My approach was to use the synthetic script to generate productionlike<br />
node and ramp up the # of load actors in 5m increments. Each run would<br />
test the following Puma process/thread balance:</p>

<p>Run #1: Single-process, multi threads.<br />
Run #2: Multiple processes, single threaded.<br />
Run #3: Multiple processes, multiple threads.</p>

<blockquote>
  <h3 id="aside-how-many-of-these-threadsprocesses-should-i-be-using">Aside: <em>how many</em> of these threads/processes should I be using?</h3>

  <p>Note that your numbers will be different on the execution<br />
characteristics of your app and your server environment. Tweak it for<br />
yourself. You’re designing an experiment.</p>

  <p>If you’re curious, our Rails app started out with 4 threads on 2<br />
workers. We made the # of Puma workers (both min and max) environment<br />
variables so we could tweak the variables easily without deploying.</p>
</blockquote>

<p>The strategy was then to look at the perf characteristics of each run in<br />
the scatter plot. If there were any spikes in the graph with the<br />
increase of load, then that would be noted. Even minor features like an<br />
increase in slope would be noted - at that point, the incremental cost<br />
of each request increases with overall system load.</p>

<h2 id="results">Results</h2>

<p>I don’t have the New Relic data on hand to show, now, but in our case we<br />
discovered two things:</p>

<ol>
  <li>The server easily scaled from ~10 -&gt; ~500 rpm with a virtually flat<br />
line for all runs.</li>
  <li>The app exhibited no noticeable performance differences when flipped<br />
between uniprocess-multithreaded, multiprocess-unithreaded, and<br />
multiprocess-multithreaded modes. Any performance gains were under a<br />
tolerable threshold.</li>
</ol>

<p>How do we parse these results?</p>

<ul>
  <li>We note that we didn’t really push the performance threshold on this<br />
app (it’s not meant to be a public web site and 95% of it is behind a<br />
login wall to a specialized group of users). Thus, if we pushed the<br />
concurrent connections even more, we may have seen more of a pronounced<br />
difference.</li>
  <li>The <em>absence</em> of any major red flags was itself a validation. The<br />
question we wanted answered coming into this experiment was “how close<br />
are we to maxing out our single-node EC2 configuration such that we will<br />
have to begin configuring horizontal scaling?”? The answer was: we can<br />
safely scale further out in the near-term future, and cross the bridge<br />
of horizontal scaling/bursting when we get there.</li>
  <li>We did not have enough statistically significant differences in<br />
performance for #threads/#processes in Puma. However, if we wanted to<br />
truly find the optimal performance in our app, we would have turned to<br />
tools like <a href="https://github.com/schneems/puma_auto_tune">puma_auto_tune</a> to answer those questions.</li>
</ul>

<p>Let me know in the comments if you have any questions!</p>

			
			
		</div>
	<footer>
		


		



  
		
			Tagged under
		
    <a class='category' href='/category/performance-tuning/'>performance tuning</a>, <a class='category' href='/category/puma/'>puma</a>, <a class='category' href='/category/rails/'>rails</a>
	


	
	
	</footer>
	
</article>
<!-- END OF _includes/article.html -->

	
		
		<!-- START OF _includes/article.html -->
<article>
	<header>
		<h1><a href="/2015/06/01/toolbox-learning-swift-and-viper/">Toolbox: learning Swift and VIPER</a></h1>
		<time>01 June 2015</time>
	</header>
		<div class="content">
			<p>The following are some notes I’m compiling as I’m beginning a journey<br />
down the rabbit hole, writing an app in Swift utilizing the <a href="http://www.objc.io/issue-13/viper.html">VIPER app development methodology</a></p>

<ul>
  <li>
    <p>I had trouble importing nested source code into XCode before realizing that I<br />
needed to import the folder with corresponding Groups. This is done by<br />
clicking the checkbox “Create Groups for any Added Folders”</p>

    <p><em>Reference</em>: https://developer.apple.com/library/ios/technotes/iOSStaticLibraries/Articles/configuration.html</p>

    <p>Without doing this, the compiler was not able to build the project.</p>

    <ul>
      <li>Since there is no way to do method swizzling in Swift, there are no real easy ways to do mocking/stubbing the way we used to do so in Ruby. Instead, this is forcing me to rely on plain old Swift structs. There are some simple ways to stub, but it ends up looking kind of awkward and very wiring-intensive like this:</li>
    </ul>
  </li>
</ul>

<figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
</pre></td><td class="code"><pre><code class=""><span class="line">class NewRidePresenterSpec: QuickSpec {
</span><span class="line">  override func spec() {
</span><span class="line">    describe("#startRecordingGpsTrack") {
</span><span class="line">      class MockInteractor: NewRideInteractor {
</span><span class="line">        var wasCalled: Bool = false
</span><span class="line">
</span><span class="line">        @objc private override func startRecordingGpsTrack() {
</span><span class="line">          wasCalled = true
</span><span class="line">        }
</span><span class="line">      }
</span><span class="line">
</span><span class="line">      var subject = NewRidePresenter()
</span><span class="line">
</span><span class="line">      it("tells the interactor to start recording") {
</span><span class="line">        let mockInteractor = MockInteractor()
</span><span class="line">        subject.interactor = mockInteractor
</span><span class="line">        subject.startRecordingGpsTrack()
</span><span class="line">
</span><span class="line">        expect(mockInteractor.wasCalled).to(beTrue())
</span><span class="line">      }
</span><span class="line">    }
</span><span class="line">  }
</span><span class="line">}</span></code></pre></td></tr></table></div></figure>

<ul>
  <li>Using the <a href="https://github.com/teambox/viper-module-generator"><code>vipergen</code></a> and <a href="https://github.com/team-supercharge/boa"><code>boa</code></a> scaffolding generators helped me understand the concepts behind the view.</li>
  <li>Tip: Build a VIPER module, but don’t build it all at once. Just focus on the Presenter-Interactor-Wireframe component, or the DataStore-Entity-Interactor component. This will keep your head from exploding.</li>
  <li>Dude. I miss vim. <a href="http://alcatraz.io/">Alcatraz</a> + xvim helped a little…</li>
  <li>xcodebuild + <a href="https://github.com/supermarin/xcpretty">xcpretty</a> + Guard-shell == some sort of CI feedback loop.</li>
  <li>Manually creating mocks in Swift = kind of painful. If you override (subclass) a NSObject in Swift, <a href="http://stackoverflow.com/a/30530308/993929">you must provide it with the <code>@objc</code> pragma, otherwise it throws a segfault error</a></li>
  <li>You must contact CircleCI manually if you want to activate an iOS build (it’s still in beta). What are some other good CI tools to use with iOS?</li>
</ul>

			
			
		</div>
	<footer>
		


		



  
		
			Tagged under
		
    <a class='category' href='/category/ios/'>ios</a>, <a class='category' href='/category/swift/'>swift</a>, <a class='category' href='/category/viper/'>viper</a>
	


	
	
	</footer>
	
</article>
<!-- END OF _includes/article.html -->

	
		
		<!-- START OF _includes/article.html -->
<article>
	<header>
		<h1><a href="/2015/04/30/building-gpx-stats-through-frp-principles-on-bacon-dot-js/">Building GPX stats through FRP principles with Bacon.js</a></h1>
		<time>30 April 2015</time>
	</header>
		<div class="content">
			<p>With my current fascination with <a href="http://github.com/andrewhao/stressfactor">tracking workouts and location-based-activities</a>, I have been interested in how I might be able to rewrite some of my stats logic with FRP principles.</p>

<h3 id="what-is-frp">What is FRP?</h3>

<p>FRP, or Functional Reactive Programming, is often defined as “functional programming over values that change over time”. It uses functional composition for streams of data that may appear in an infinite stream of data for some far indeterminate future - these types of use cases are served well by FRP which <a href="http://en.wikipedia.org/wiki/Functional_reactive_programming">“(simplifies) these problems by explicitly modeling time”</a>.</p>

<h3 id="gps---your-location-varied-over-time">GPS - your location, varied over time.</h3>

<p>A great application of this would be a workout. Let’s say I wanted to build an app that received realtime updates on a person’s position. Say the app was a Node server that received this JSON blob from a web API as a location update:</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="json"><span class="line"><span class="p">{</span> <span class="err">&#39;lat&#39;:</span> <span class="err">29.192414,</span>
</span><span class="line">  <span class="err">&#39;lon&#39;:</span> <span class="err">148.113241,</span>
</span><span class="line">  <span class="err">&#39;ele&#39;:</span> <span class="err">122.1,</span>
</span><span class="line">  <span class="err">&#39;time&#39;:</span> <span class="err">&#39;2015-04-18T13:54:56Z&#39;</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>Say that some time later, the API receives this JSON blob:</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="json"><span class="line"><span class="p">{</span> <span class="err">&#39;lat&#39;:</span> <span class="err">29.192424,</span>
</span><span class="line">  <span class="err">&#39;lon&#39;:</span> <span class="err">148.113251,</span>
</span><span class="line">  <span class="err">&#39;ele&#39;:</span> <span class="err">123.1,</span>
</span><span class="line">  <span class="err">&#39;time&#39;:</span> <span class="err">&#39;2015-04-18T13:55:26Z&#39;</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

<p>So we have these data points, that the user has moved <code>+0.00001</code> latitude points and <code>+0.00001</code> longitude points, climbing a total of <code>+1.0</code> meters, over a period of <code>30</code> seconds.</p>

<h4 id="exercise-get-my-instantaneous-velocity">Exercise: Get my instantaneous velocity</h4>

<p>If we performed this imperatively, we would write it something like this:</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="javascript"><span class="line"><span class="kd">var</span> <span class="nx">locations</span> <span class="o">=</span> <span class="p">[{</span> <span class="cm">/*json*/</span> <span class="p">},</span> <span class="p">{</span> <span class="cm">/*json*/</span> <span class="p">}</span> <span class="cm">/*, ...*/</span><span class="p">];</span>
</span><span class="line"><span class="kd">var</span> <span class="nx">last</span> <span class="o">=</span> <span class="nx">locations</span><span class="p">[</span><span class="nx">locations</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
</span><span class="line"><span class="kd">var</span> <span class="nx">secondToLast</span> <span class="o">=</span> <span class="nx">locations</span><span class="p">[</span><span class="nx">locations</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">2</span><span class="p">];</span>
</span><span class="line"><span class="kd">var</span> <span class="nx">timeDelta</span> <span class="o">=</span> <span class="nx">last</span><span class="p">.</span><span class="nx">time</span> <span class="o">-</span> <span class="nx">secondToLast</span><span class="p">.</span><span class="nx">time</span><span class="p">;</span>
</span><span class="line"><span class="kd">var</span> <span class="nx">distanceDelta</span> <span class="o">=</span> <span class="nx">getDistance</span><span class="p">(</span><span class="nx">last</span><span class="p">.</span><span class="nx">lon</span><span class="p">,</span> <span class="nx">last</span><span class="p">.</span><span class="nx">lat</span><span class="p">,</span> <span class="nx">secondToLast</span><span class="p">.</span><span class="nx">lon</span><span class="p">,</span> <span class="nx">secondToLast</span><span class="p">.</span><span class="nx">lat</span><span class="p">);</span>
</span><span class="line"><span class="kd">var</span> <span class="nx">velocity</span> <span class="o">=</span> <span class="nx">distanceDelta</span> <span class="o">/</span> <span class="nx">timeDelta</span><span class="p">;</span>
</span><span class="line"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">velocity</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>

<p>With FRP, it might look more like this:</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="javascript"><span class="line"><span class="kd">var</span> <span class="nx">locationStream</span> <span class="o">=</span> <span class="p">[{</span> <span class="cm">/*json*/</span> <span class="p">},</span> <span class="p">{</span> <span class="cm">/*json*/</span> <span class="p">}</span> <span class="cm">/*, ...some JSON objects that might appear in the future */</span><span class="p">];</span>
</span><span class="line"><span class="nx">locationStream</span><span class="p">.</span><span class="nx">slidingWindow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span><span class="line">              <span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">pairs</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">                <span class="kd">var</span> <span class="nx">timeDelta</span> <span class="o">=</span> <span class="nx">pairs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">time</span> <span class="o">-</span> <span class="nx">pairs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">time</span><span class="p">;</span>
</span><span class="line">                <span class="kd">var</span> <span class="nx">distanceDelta</span> <span class="o">=</span> <span class="nx">getDistance</span><span class="p">(</span><span class="nx">pairs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">lon</span><span class="p">,</span> <span class="nx">pairs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">lat</span><span class="p">,</span> <span class="nx">pairs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">lon</span><span class="p">,</span> <span class="nx">pairs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">lat</span><span class="p">);</span>
</span><span class="line">                <span class="k">return</span> <span class="nx">distanceDelta</span> <span class="o">/</span> <span class="nx">timeDelta</span>
</span><span class="line">              <span class="p">})</span>
</span><span class="line">              <span class="p">.</span><span class="nx">onValue</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">velocity</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">velocity</span><span class="p">);</span>
</span><span class="line">              <span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>

<p>There is a key difference that is not easily demonstrated here - that the former imperative example requires that all JSON arrays be materialized at once - via db query, in-memory store, etc. It doesn’t account for change in time.</p>

<p>However, the latter functional example accounts for changing values of time as they appear over the stream - as soon as a new value shows up in the stream, the velocity is changed instantly.</p>

<h3 id="some-more-location-based-experiments-rxlocation">Some more location-based experiments: rxlocation</h3>

<p>I wrote up a library to parse various facts from a changing stream of GPS events, from instantaneous velocity, average velocity, moving/stopped status, etc.</p>

<p>I investigated different reactive frameworks, mainly <a href="https://github.com/Reactive-Extensions/RxJS/">RxJS</a> and <a href="https://github.com/baconjs/bacon.js/">Bacon.js</a>. My takeaways were that RxJS does everything and the kitchen sink, but I got lost trying to reconcile Node streams with RxJS cold streams. Bacon.js just seemed to work for me, out of the box. I’m still learning, so I hope to have a better understanding of the core issues here.</p>

<p>You can check it out here: <a href="https://github.com/andrewhao/rxlocation">rxlocation</a>.</p>

			
			
		</div>
	<footer>
		


		



  
		
			Tagged under
		
    <a class='category' href='/category/functional-reactive-programming/'>functional reactive programming</a>, <a class='category' href='/category/javascript/'>javascript</a>, <a class='category' href='/category/node/'>node</a>
	


	
	
	</footer>
	
</article>
<!-- END OF _includes/article.html -->

	
		
		<!-- START OF _includes/article.html -->
<article>
	<header>
		<h1><a href="/2015/03/19/docker-rails-and-docker-compose-in-your-development-workflow/">Docker, Rails, and Docker Compose in your development workflow</a></h1>
		<time>19 March 2015</time>
	</header>
		<div class="content">
			<p>(This post <a href="http://blog.carbonfive.com/2015/03/17/docker-rails-docker-compose-together-in-your-development-workflow/">originally appeared</a> on the Carbon Five blog.)</p>

<p>We’ve been trialing the usage of Docker and <a href="https://docs.docker.com/compose/">Docker Compose</a> (previously known as <a href="http://www.fig.sh">fig</a>) on a Rails project here at Carbon Five. In the past, my personal experience with Docker had been that the promise of portable containerized apps was within reach, but the tooling and development workflow were still awkward - commands were complex, configuration and linking steps were complicated, and the overall learning curve was high.</p>

<p>My team decided to take a peek at the current landscape of Docker tools (primarily boot2docker and Docker Compose) and see how easily we could spin up a new app and integrate it into our development workflow on Mac OS X.</p>

<p>In the end, I’ve found my experience with Docker tools to be surprisingly pleasant; the tooling easily integrates with existing Rails development workflows with only a minor amount of performance overhead. Docker Compose offers a seamless way to build containers and orchestrate their dependencies, and helps lower the learning curve to build Dockerized applications. Read on to find out how we built ours.</p>

<h2 id="introduction-to-docker-compose-ne-fig">Introduction to docker-compose (née Fig).</h2>

<p>Docker Compose acts as a wrapper around Docker - it links your containers together and provides syntactic sugar around some complex container linking commands.</p>

<p>We liked Docker Compose for its ability to coordinate and spin up your entire application and dependencies with one command. In the past, frameworks like Vagrant were easy ways to generate a standard image for your development team to use and get started on. Docker Compose offers similar benefits of decoupling the app from the host environment, but also provides the container vehicle for the app to run in all environments - that is, the container you develop in will often be the same container that you deploy to production with.</p>

<p>Docker (with the orchestration tooling provided by Compose) provides us the ability to:</p>

<ul>
  <li>Upgrade versions of Ruby or Node (or whatever runtime your app requires) in production with far less infrastructure coordination than normally required.</li>
  <li>Reduce the number of moving parts in the deployment process. Instead of writing complex Puppet and Capistrano deployment scripts, our deployments will now center around moving images around and starting containers.</li>
  <li>Simplify developer onboarding by standardizing your team on the same machine images.</li>
</ul>

<p>In this example, we will run two Docker containers - a Rails container and a MySQL container - and rely on Compose to build, link, and run them.</p>

<h2 id="installing-boot2docker-docker-and-docker-compose">Installing boot2docker, Docker, and Docker Compose.</h2>

<p>Docker runs in a VirtualBox VM through an image called <code>boot2docker</code>. The reason we have to use <code>boot2docker</code> and VirtualBox is because the Mac OSX filesystem is not compatible with the type of filesystem required to support Docker. Hence, we must run our Docker containers within yet another virtual machine.</p>

<ol>
  <li>Download and install <a href="https://www.virtualbox.org/wiki/Downloads">VirtualBox</a>.</li>
  <li>Now install boot2docker and Docker Compose.</li>
</ol>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line"><span class="nv">$ </span>brew install boot2docker docker-compose
</span></code></pre></td></tr></table></div></figure>
<ol>
  <li>Initialize and start up boot2docker</li>
</ol>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line"><span class="nv">$ </span>boot2docker init
</span><span class="line"><span class="nv">$ </span>boot2docker start
</span></code></pre></td></tr></table></div></figure>

<ol>
  <li>Configure your Docker host to point to your boot2docker image.</li>
</ol>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line"><span class="nv">$ </span><span class="k">$(</span>boot2docker shellinit<span class="k">)</span>
</span></code></pre></td></tr></table></div></figure>

<p>You’ll need to run this for every terminal session that invokes the <code>docker</code> or <code>docker-compose</code> command - better export this line into your <code>.zshrc</code> or <code>.bashrc</code>.</p>

<h2 id="creating-a-dockerfile">Creating a Dockerfile</h2>

<p>Let’s start by creating a Dockerfile for this app. This specifies the base dependencies for our Rails application. We will need:</p>

<ul>
  <li>Ruby 2.2 - for our Rails instance</li>
  <li>NodeJS and NPM - for installation of Karma, jshint, and other JS dependencies.</li>
  <li>MySQL client - for ActiveRecord tasks</li>
  <li>PhantomJS - for executing JS-based tests</li>
  <li>vim - for inspecting and editing files within our container</li>
</ul>

<p>Create a <code>Dockerfile</code> from within your Rails app directory.</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">FROM ruby:2.2.0
</span><span class="line">RUN apt-get update -qq <span class="o">&amp;&amp;</span> apt-get install -y build-essential nodejs npm nodejs-legacy mysql-client vim
</span><span class="line">RUN npm install -g phantomjs
</span><span class="line">
</span><span class="line">RUN mkdir /myapp
</span><span class="line">
</span><span class="line">WORKDIR /tmp
</span><span class="line">COPY Gemfile Gemfile
</span><span class="line">COPY Gemfile.lock Gemfile.lock
</span><span class="line">RUN bundle install
</span><span class="line">
</span><span class="line">ADD . /myapp
</span><span class="line">WORKDIR /myapp
</span><span class="line">RUN <span class="nv">RAILS_ENV</span><span class="o">=</span>production bundle <span class="nb">exec </span>rake assets:precompile --trace
</span><span class="line">CMD <span class="o">[</span><span class="s2">&quot;rails&quot;</span>,<span class="s2">&quot;server&quot;</span>,<span class="s2">&quot;-b&quot;</span>,<span class="s2">&quot;0.0.0.0&quot;</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>

<p>Let’s start by breaking this up line-by-line:</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">FROM ruby:2.2.0
</span></code></pre></td></tr></table></div></figure>
<p>The <a href="https://docs.docker.com/reference/builder/#from"><code>FROM</code></a> directive specifies the <a href="https://registry.hub.docker.com/u/library/ruby/"><code>library/ruby</code> base image from Docker Hub</a>, and uses the <code>2.2.0</code> tag, which corresponds to the Ruby 2.2.0 runtime.</p>

<p>From here on, we are going to be executing commands that will build on this reference image.</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">RUN apt-get update -qq <span class="o">&amp;&amp;</span> apt-get install -y build-essential nodejs npm nodejs-legacy mysql-client vim
</span><span class="line">RUN npm install -g phantomjs
</span></code></pre></td></tr></table></div></figure>

<p>Each <a href="https://docs.docker.com/reference/builder/#run"><code>RUN</code></a> command builds up the image, installing specific application dependencies and setting up the environment. Here we install our app dependencies both from <code>apt</code> and <code>npm</code>.</p>

<h3 id="an-aside-on-how-a-docker-image-is-built">An aside on how a Docker image is built</h3>

<p>One of the core concepts in Docker is the concept of “layers”. Docker runs on operating systems that support layering filesystems such as <code>aufs</code> or <code>btrfs</code>. Changes to the filesystem can be thought of as atomic operations that can be rolled forward or backwards.</p>

<p>This means that Docker can effectively store its images as snapshots of each other, much like Git commits. This also has implications as to how we can build up and cache copies of the container as we go along.</p>

<p>The Dockerfile can be thought of as a series of rolling incremental changes to a base image - each command builds on top of the line before. This allows Docker to quickly rebuild changes to the reference image by understanding which lines have changed - and not rebuild the image from scratch each time.</p>

<p>Keep these concepts in mind as we talk about speeding up your Docker build in the following section.</p>

<h3 id="fast-docker-builds-by-caching-your-gemfiles">Fast Docker builds by caching your Gemfiles</h3>

<p>The following steps install the required Ruby gems for Bundler, within your app container:</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">WORKDIR /tmp
</span><span class="line">COPY Gemfile Gemfile
</span><span class="line">COPY Gemfile.lock Gemfile.lock
</span><span class="line">RUN bundle install
</span></code></pre></td></tr></table></div></figure>

<p>Note how we sneak the gems into <code>/tmp</code>, then run the <code>bundle install</code> which downloads and installs gems into Bundler’s <code>vendor/bundle</code> directory. This is a cache hack - whereas in the past we would have kept the <code>Gemfile</code>s in with the rest of the application directory in <code>/myapp</code>.</p>

<p>Keeping Gemfiles inline with the app would have meant that the entire <code>bundle install</code> command would have been re-run on each <code>docker-compose build</code> – without any caching – due to the constant change in the code in the <code>/myapp</code> directory.</p>

<p>By separating out the Gemfiles into their own directory, we logically separate the Gemfiles, which are far less likely to change, from the app code, which are far more likely to change. This reduces the number of times we have to wait for a clean <code>bundle install</code> to complete.</p>

<p>HT: <a href="http://ilikestuffblog.com/2014/01/06/how-to-skip-bundle-install-when-deploying-a-rails-app-to-docker/">Brian Morearty: “How to skip bundle install when deploying a Rails app to Docker”</a></p>

<h3 id="adding-the-app">Adding the app</h3>

<p>Finally, we finish our Dockerfile by adding our current app code to the working directory.</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">ADD . /myapp
</span><span class="line">WORKDIR /myapp
</span><span class="line">RUN <span class="nv">RAILS_ENV</span><span class="o">=</span>production bundle <span class="nb">exec </span>rake assets:precompile --trace
</span><span class="line">CMD <span class="o">[</span><span class="s2">&quot;rails&quot;</span>,<span class="s2">&quot;server&quot;</span>,<span class="s2">&quot;-b&quot;</span>,<span class="s2">&quot;0.0.0.0&quot;</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>

<p>This links the contents of the app directory on the host to the  <code>/myapp</code> directory within the container.</p>

<p>Note that we precompile all our assets before the container boots up - this ensures that the container is preloaded and ready to run and jives with Docker tenets that a container should be the same container that runs in development, test, and production environments.</p>

<h2 id="setting-up-docker-compose">Setting up Docker Compose</h2>

<p>Now that we’ve defined a <code>Dockerfile</code> for booting our Rails app, we turn to the Compose piece that orchestrates the linking phase between the Rails app and its dependencies - in this case, the DB.</p>

<p>A <code>docker-compose.yml</code> file automatically configures our application ecosystem. Here, it defines our Rails container and its db container:</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
</pre></td><td class="code"><pre><code class="yaml"><span class="line"><span class="l-Scalar-Plain">web</span><span class="p-Indicator">:</span>
</span><span class="line">  <span class="l-Scalar-Plain">build</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">.</span>
</span><span class="line">  <span class="l-Scalar-Plain">volumes</span><span class="p-Indicator">:</span>
</span><span class="line">    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">.:/myapp</span>
</span><span class="line">  <span class="l-Scalar-Plain">ports</span><span class="p-Indicator">:</span>
</span><span class="line">    <span class="p-Indicator">-</span> <span class="s">&quot;3000:3000&quot;</span>
</span><span class="line">  <span class="l-Scalar-Plain">links</span><span class="p-Indicator">:</span>
</span><span class="line">    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">db</span>
</span><span class="line">  <span class="l-Scalar-Plain">env_file</span><span class="p-Indicator">:</span>
</span><span class="line">    <span class="p-Indicator">-</span> <span class="s">&#39;.env.web&#39;</span>
</span><span class="line"><span class="l-Scalar-Plain">db</span><span class="p-Indicator">:</span>
</span><span class="line">  <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">library/mysql:5.6.22</span>
</span><span class="line">  <span class="l-Scalar-Plain">ports</span><span class="p-Indicator">:</span>
</span><span class="line">    <span class="p-Indicator">-</span> <span class="s">&quot;13306:3306&quot;</span>
</span><span class="line">  <span class="l-Scalar-Plain">env_file</span><span class="p-Indicator">:</span>
</span><span class="line">    <span class="p-Indicator">-</span> <span class="s">&#39;.env.db&#39;</span>
</span></code></pre></td></tr></table></div></figure>

<p>A simple:</p>

<pre><code>$ docker-compose up
</code></pre>

<p>will spin up both the <code>web</code> and <code>db</code> instances.</p>

<p>One of the most powerful tools of using Docker Compose is the ability to abstract away the configuration of your server, no matter whether it is running as a development container on your computer, a test container on CI, or on your production Docker host.</p>

<p>The directive:</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="yaml"><span class="line"><span class="l-Scalar-Plain">links</span><span class="p-Indicator">:</span>
</span><span class="line">  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">db</span>
</span></code></pre></td></tr></table></div></figure>

<p>will add an entry for <code>db</code> into the Rails’ container’s <code>/etc/hosts</code>, linking the hostname to the correct container. This allows us to write our database.yml like so:</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="yaml"><span class="line"><span class="c1"># config/database.yml</span>
</span><span class="line"><span class="l-Scalar-Plain">development</span><span class="p-Indicator">:</span> <span class="nl">&amp;default</span>
</span><span class="line">  <span class="l-Scalar-Plain">host</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">db</span>
</span></code></pre></td></tr></table></div></figure>

<p>Another important thing to note is the <code>volumes</code> configuration:</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="yaml"><span class="line"><span class="c1"># docker-compose.yml</span>
</span><span class="line"><span class="l-Scalar-Plain">volumes</span><span class="p-Indicator">:</span>
</span><span class="line">  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">.:/myapp</span>
</span></code></pre></td></tr></table></div></figure>

<p>This mounts the current directory <code>.</code> on the host Mac to the <code>/myapp</code> directory in the container. This allows us to make live code changes on the host filesystem and see code changes reflected in the container.</p>

<p>Also note that we make use of Compose’s <code>env_file</code> directive, which allows us to specify environment variables to inject into the container at runtime:</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="yaml"><span class="line"><span class="l-Scalar-Plain">env_file</span><span class="p-Indicator">:</span>
</span><span class="line">  <span class="p-Indicator">-</span> <span class="s">&#39;.env.web&#39;</span>
</span></code></pre></td></tr></table></div></figure>

<p>A peek into <code>.env.web</code> shows:</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="yaml"><span class="line"><span class="l-Scalar-Plain">PORT=3000</span>
</span><span class="line"><span class="l-Scalar-Plain">PUMA_WORKERS=1</span>
</span><span class="line"><span class="l-Scalar-Plain">MIN_THREADS=4</span>
</span><span class="line"><span class="l-Scalar-Plain">MAX_THREADS=16</span>
</span><span class="line"><span class="l-Scalar-Plain">SECRET_KEY_BASE=&lt;Rails secret key&gt;</span>
</span><span class="line"><span class="l-Scalar-Plain">AWS_REGION=us-west-2</span>
</span><span class="line"><span class="l-Scalar-Plain"># ...</span>
</span></code></pre></td></tr></table></div></figure>

<p>Note that the <code>env_file</code> is powerful in that it allows us to swap out environment configurations when you deploy and run your containers. Perhaps your container needs separate configurations on dev than when on CI, or when deployed to staging or on production.</p>

<h2 id="creating-containers-and-booting-them-up">Creating containers and booting them up.</h2>

<p>Now it’s time to assemble the container. From within the Rails app, run:</p>

<pre><code>$ docker-compose build
</code></pre>

<p>This downloads and builds the containers that your web app and your db will live in, linking them up. You will need to re-run the <code>docker-compose build</code> command every time you change the <code>Dockerfile</code> or <code>Gemfile</code>.</p>

<h2 id="running-your-app-in-containers">Running your app in containers</h2>

<p>You can bring up your Rails server and associated containers by running:</p>

<pre><code>$ docker-compose up
</code></pre>

<p>This is a combination of build, link, and start-services command for<br />
each container. You should see output that indicates that both our <code>web</code> and <code>db</code> containers, as configured in the <code>docker-compose.yml</code> file, are booting up.</p>

<h2 id="development-workflow">Development workflow</h2>

<p>I was pleasantly surprised to discover that developing with Docker added very little overhead to the development process. In fact, most commands that you would run for Rails simply needed to be prepended with a <code>docker-compose run web</code>.</p>

<table>
  <thead>
    <tr>
      <th>When you want to run:</th>
      <th>With Docker Compose, you would run:</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>bundle install</code></td>
      <td><code>docker-compose run web bundle install</code></td>
    </tr>
    <tr>
      <td><code>rails s</code></td>
      <td><code>docker-compose run web rails s</code></td>
    </tr>
    <tr>
      <td><code>rspec spec/path/to/spec.rb</code></td>
      <td><code>docker-compose run web rspec spec/path/to/spec.rb</code></td>
    </tr>
    <tr>
      <td><code>RAILS_ENV=test rake db:create</code></td>
      <td><code>docker-compose run -e RAILS_ENV=test web rake db:create</code></td>
    </tr>
    <tr>
      <td><code>tail -f log/development.log</code></td>
      <td><code>docker-compose run web tail -f log/development.log</code></td>
    </tr>
  </tbody>
</table>

<h2 id="protips">Protips</h2>

<p>Here are some nice development tricks I found useful when working with Docker:</p>

<ul>
  <li>Add a <code>dockerhost</code> entry to your <code>/etc/hosts</code> file so you can visit <code>dockerhost</code> from your browser.</li>
</ul>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line"><span class="nv">$ </span>boot2docker ip
</span><span class="line">192.168.59.104
</span></code></pre></td></tr></table></div></figure>

<p>Then add the IP to your <code>/etc/hosts</code></p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">192.168.59.104  dockerhost
</span></code></pre></td></tr></table></div></figure>

<p>Now you can pull up your app from <code>dockerhost:3000</code>:</p>

<p><img src="http://i.imgur.com/5eqNJqN.png" alt="Screenshot of your URL bar" /></p>

<ul>
  <li>
    <p>Debugging containers with <code>docker exec</code></p>

    <p>Sometimes you need to get inside a container to see what’s <em>really</em> happening. Perhaps you need to test whether a port is truly open, or verify that a process is truly running. This can be accomplished by grabbing the container ID with a <code>docker ps</code>, then passing that ID into the <code>docker exec</code> command:</p>
  </li>
</ul>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line"><span class="nv">$ </span>docker ps
</span><span class="line">CONTAINER ID        IMAGE
</span><span class="line">301fa6331388        myrailsapp_web:latest
</span><span class="line"><span class="nv">$ </span>docker <span class="nb">exec</span> -it 301fa6331388 /bin/bash
</span><span class="line">root@301fa6331388:/myapp#
</span></code></pre></td></tr></table></div></figure>

<ul>
  <li>Showing environment variables in a container with <code>docker-compose run web env</code></li>
</ul>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line"><span class="nv">$ </span>docker-compose run web env
</span><span class="line"><span class="nv">AWS_SECRET_KEY</span><span class="o">=</span>
</span><span class="line"><span class="nv">MAX_THREADS</span><span class="o">=</span>16
</span><span class="line"><span class="nv">MIN_THREADS</span><span class="o">=</span>4
</span><span class="line"><span class="nv">AWS_REGION</span><span class="o">=</span>us-west-2
</span><span class="line"><span class="nv">BUNDLE_APP_CONFIG</span><span class="o">=</span>/usr/local/bundle
</span><span class="line"><span class="nv">HOME</span><span class="o">=</span>/root
</span><span class="line"><span class="c">#...</span>
</span></code></pre></td></tr></table></div></figure>

<ul>
  <li>
    <p>Running an interactive debugger (like <a href="http://pryrepl.org/">pry</a>) in your Docker container</p>

    <p>It takes a little extra work to get Docker to allow interactive terminal debugging with tools like <code>byebug</code> or <code>pry</code>. Should you desire to start your web server with debugging capabilities, you will need to use the <code>--service-ports</code> flag with the <code>run</code> command.</p>
  </li>
</ul>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line"><span class="nv">$ </span>docker-compose run --service-ports web
</span></code></pre></td></tr></table></div></figure>

<p>This works due to two internal implementations of <code>docker-compose run</code>:</p>

<ul>
  <li><code>docker-compose run</code> creates a TTY session for your app to connect to, allowing interactive debugging. The default <code>docker-compose up</code> command does not create a TTY session.</li>
  <li>The <code>run</code> command does not map ports to the Docker host by default. The <code>--service-ports</code> directive maps the container’s ports to the host’s ports, allowing you to visit the container from your web browser.</li>
</ul>

<ol>
  <li>Use <code>slim</code> images when possible on production</li>
</ol>

<p>Oftentimes, your base image will come supplied with a <code>-slim</code> variant on Docker Hub. This usually means that the image maintainer has supplied a trimmed-down version of the container for you to use with source code and build-time files stripped and removed. You can oftentimes shave a couple hundred megabytes off your resulting image – we did when we switched our <code>ruby</code> image from <code>2.2.1</code> to <code>2.2.1-slim</code>. This results in faster deployment times due to less network I/O from the registry to the deployment target.</p>

<h2 id="gotchas">Gotchas</h2>

<ul>
  <li>
    <p>Remember that your app runs in containers - so every time you do a <code>docker-compose run</code>, remember that Compose is spinning up entirely new containers for your code <strong>but only if the containers are not up already, in which case they are linked to that (running) container</strong>.</p>

    <p>This means that it’s possible that you’ve spun up multiple instances of your app without thinking about it - for example, you may have a <code>web</code> and <code>db</code> container already up from a <code>docker-compose up</code> command, and then in a separate terminal window you run a <code>docker-compose run web rails c</code>. That spins up <em>another</em> <code>web</code> container to execute the command, but then links that container with the pre-launched <code>db</code> container.</p>
  </li>
  <li>
    <p>There is a small but noticeable performance penalty running through both the VirtualBox VM and docker. I’ve generally noticed waiting a few extra seconds when starting a Rails environment. My overall experience has been that the penalty has not been large enough to be painful.</p>
  </li>
</ul>

<h2 id="try-it-out">Try it out</h2>

<p>Give this a shot and let me know how Docker has been working for you. What have your experiences been? What are ways in which you’ve been able to get your Docker workflow smoother? Share in the comments below.</p>

<h3 id="coming-up-integration-with-ci-and-deployment">Coming up: integration with CI and deployment.</h3>

<p>In upcoming blog posts, we will investigate how to use the power of Docker Compose to test and build your containers in a CI-powered workflow, push to Docker registries, and deploy to production. Stay tuned!</p>

			
			
		</div>
	<footer>
		


		



  
		
			Tagged under
		
    <a class='category' href='/category/docker/'>docker</a>, <a class='category' href='/category/rails/'>rails</a>
	


	
	
	</footer>
	
</article>
<!-- END OF _includes/article.html -->

	
		
		<!-- START OF _includes/article.html -->
<article>
	<header>
		<h1><a href="/2014/11/29/explorations-in-logic-programming/">Explorations in logic programming</a></h1>
		<time>29 November 2014</time>
	</header>
		<div class="content">
			<p>Out of <a href="https://github.com/andrewhao/storybook">Storybook</a>, a side project I’ve been doing for a friend, I had the opportunity to model the problem domain as a constraint satisfaction problem (CSP). It goes:</p>

<blockquote>
  <p>A set of students are assigned a book a week. Write plan generator to create a set of student-book assignments for that week, given the following constraints:</p>

  <ul>
    <li>All students must receive a book.</li>
    <li>Each book may only be assigned to one student at a time.</li>
    <li>A student may not be assigned a book s/he has received before.</li>
  </ul>
</blockquote>

<p>Being that this was a Rails app, I put <a href="https://github.com/andrewhao/storybook">Amb</a>, a Ruby-based CSP solver, to use. Amb is derived off <a href="">Jim Weirich’s original source code</a>, implementing a simple backtracking algorithm. (More <a href="http://community.schemewiki.org/?amb">interesting reading on the original idea</a> behind the <code>amb</code> operator, proposed in a <a href="http://www-formal.stanford.edu/jmc/basis1.pdf">paper</a> by LISP founder John McCarthy in 1963.)</p>

<p>Not having written any CSP logic since my university days, I tried to come up with a naive solution. It goes something like this:</p>

<figure class="code"><figcaption><span>assignment_problem_1.rb</span><a href="https://github.com/andrewhao/storybook/blob/8bb03101d46472e36ee400b79c30d941d3a4bd39/lib/assignment_problem.rb">link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="k">class</span> <span class="nc">AssignmentProblem</span>
</span><span class="line">  <span class="k">def</span> <span class="nf">solve</span>
</span><span class="line">    <span class="c1"># Generates the cross product of sids and bids.</span>
</span><span class="line">    <span class="n">spaces</span> <span class="o">=</span> <span class="n">student_ids</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">bag_ids</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">    <span class="c1"># Now generate combinations of those uniques</span>
</span><span class="line">    <span class="n">full_solution_space</span> <span class="o">=</span> <span class="n">spaces</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="n">student_ids</span><span class="o">.</span><span class="n">count</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span>
</span><span class="line">
</span><span class="line">    <span class="c1"># Assign those to the CSP</span>
</span><span class="line">    <span class="n">plan</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="o">*</span><span class="n">full_solution_space</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">    <span class="n">solver</span><span class="o">.</span><span class="n">assert</span> <span class="n">all_students_have_bags</span><span class="p">(</span><span class="n">plan</span><span class="p">)</span>
</span><span class="line">    <span class="n">solver</span><span class="o">.</span><span class="n">assert</span> <span class="n">assigned_bags_are_unique</span><span class="p">(</span><span class="n">plan</span><span class="p">)</span>
</span><span class="line">    <span class="n">solver</span><span class="o">.</span><span class="n">assert</span> <span class="n">assigned_bags_without_student_repeats</span><span class="p">(</span><span class="n">plan</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">    <span class="n">plan</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Well this would work for 2 students and 2 bags, 3 and 3, 4 and 4, but would blow up and overflow the stack when we got to 5 students and 5 bags. Why? I was forcing Ruby to generate the full solution space before starting the CSP search problem:</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="n">student_ids</span> <span class="o">=</span> <span class="o">[</span><span class="ss">:s1</span><span class="p">,</span> <span class="ss">:s2</span><span class="o">]</span>
</span><span class="line"><span class="n">bag_ids</span> <span class="o">=</span> <span class="o">[</span><span class="ss">:b1</span><span class="p">,</span> <span class="ss">:b2</span><span class="o">]</span>
</span><span class="line"><span class="c1"># Modeled as: the complete solution space of assignments</span>
</span><span class="line"><span class="n">spaces</span> <span class="o">=</span> <span class="n">student_ids</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">bag_ids</span><span class="p">)</span>
</span><span class="line"><span class="c1"># =&gt; [[:s1, :b1], [:s1, :b2], [:s2, :b1], [:s2, :b2]]</span>
</span></code></pre></td></tr></table></div></figure>

<p>Then I was taking that cross product and brute-force generating all possible permutations internal to that:</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="n">spaces</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="n">student_ids</span><span class="o">.</span><span class="n">count</span><span class="p">)</span><span class="o">.</span><span class="n">to_a</span>
</span><span class="line"><span class="c1"># =&gt; [[[:s1, :b1], [:s1, :b2]], [[:s1, :b1], [:s2, :b1]],</span>
</span><span class="line"><span class="c1">#     [[:s1, :b1], [:s2, :b2]], [[:s1, :b2], [:s1, :b1]],</span>
</span><span class="line"><span class="c1">#     [[:s1, :b2], [:s2, :b1]], [[:s1, :b2], [:s2, :b2]],</span>
</span><span class="line"><span class="c1">#     [[:s2, :b1], [:s1, :b1]], [[:s2, :b1], [:s1, :b2]],</span>
</span><span class="line"><span class="c1">#     [[:s2, :b1], [:s2, :b2]], [[:s2, :b2], [:s1, :b1]],</span>
</span><span class="line"><span class="c1">#     [[:s2, :b2], [:s1, :b2]], [[:s2, :b2], [:s2, :b1]]]</span>
</span></code></pre></td></tr></table></div></figure>

<p>The most obvious thing that stood out to me like a sore thumb was how I wasn’t simply trusting the constraint-based nature of the problem and expressing the problem in terms of the constraints, instead of attempting to imperatively generate the solution. Usage of <code>Enumerable#permutation</code> resulted in an <em>O(n!)</em> algorithm, which is unacceptable. Back to the drawing board:</p>

<figure class="code"><figcaption><span>assignment_problem_2.rb</span><a href="https://github.com/andrewhao/storybook/blob/e2dd94add2b5949d87968ab650a31b4bdfb9e8a2/lib/csp/assignment_problem.rb">link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="k">class</span> <span class="nc">AssignmentProblem</span>
</span><span class="line">  <span class="c1"># Generates tuples of student =&gt; bag assignments</span>
</span><span class="line">  <span class="k">def</span> <span class="nf">solve</span>
</span><span class="line">    <span class="n">student_ids</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">sid</span><span class="o">|</span>
</span><span class="line">      <span class="n">bid</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">choose</span><span class="p">(</span><span class="o">*</span><span class="n">bag_ids</span><span class="p">)</span>
</span><span class="line">      <span class="n">partial_plan</span><span class="o">[</span><span class="n">sid</span><span class="o">]</span> <span class="o">=</span>  <span class="n">bid</span>
</span><span class="line">      <span class="n">solver</span><span class="o">.</span><span class="n">assert</span> <span class="n">assigned_bags_are_unique</span><span class="p">(</span><span class="n">partial_plan</span><span class="p">)</span>
</span><span class="line">      <span class="n">solver</span><span class="o">.</span><span class="n">assert</span> <span class="n">assigned_bags_without_student_repeats</span><span class="p">(</span><span class="n">partial_plan</span><span class="p">)</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">
</span><span class="line">    <span class="n">partial_plan</span><span class="o">.</span><span class="n">to_a</span>
</span><span class="line">  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Note the main difference here is how I’ve re-tooled the solver to assign variables one at a time (in L5) and check constraints after each assignment. This simplifies the domain of the problem as a graph search and helps us more easily reason about this program.</p>

<h3 id="further-explorations">Further explorations</h3>

<p>Follow my <a href="https://www.github.com/andrewhao/csp-solvers/">csp-solvers</a> project, where I attempt to rewrite this in Prolog and Clojure in an attempt to see how language affects how we reason about problems like these. It’s gonna be fun.</p>

<h3 id="further-reading">Further reading</h3>
<ul>
  <li><a href="http://www.amazon.com/Artificial-Intelligence-Modern-Approach-3rd/dp/0136042597/ref=sr_1_1?ie=UTF8&amp;qid=1417214576&amp;sr=8-1&amp;keywords=9780136042594">Artificial Intelligence: A Modern Approach (3rd Edition)</a></li>
  <li>http://aima.cs.berkeley.edu/2nd-ed/newchap05.pdf</li>
  <li><a href="https://www.ruby-forum.com/topic/57768">Ruby Forum – Using Amb</a></li>
  <li><a href="http://community.schemewiki.org/?amb">SchemeWiki: amb</a></li>
</ul>

			
			
		</div>
	<footer>
		


		




	
	
	</footer>
	
</article>
<!-- END OF _includes/article.html -->

	
	
<div class="pagination">
	
		<a class="older" href="/posts/4">Older</a>
	
	
	<span class="total">3 of 20</span>
	
	
		<a class="newer" href="/posts/2">Newer</a>
	
</div>
<!-- END OF index.html -->


			<footer>
				Copyright &copy; 2018

	Andrew Hao


				

<script type="text/javascript">
      var disqus_shortname = 'g9labs';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





			</footer>

		</div> <!-- // .wrap -->
  </body>

	<script>
		$(document).ready(function() {
			// Make images center
			$('p:has(img)').css('text-align', 'center');

			// Add the image's title attribute as a caption
			$('p:has(img)').append(function () {
				return '<div class="caption">' + ($('img', this).attr('title') || "") + '</div>';
			});

			// Prettify code
			$('code').addClass('prettyprint');
			$('pre code').addClass('linenums');

			// Copy to clipboard with button
			$('pre:has(code)').prepend(function(){
				return '<div class="clip-btn">copy to clipboard</div>';
      });

			$('.clip-btn').zclip({
				path:'/js/ZeroClipboard.swf',
				copy: $(this).next('code').text(),
				afterCopy: function(){
					$(this).replaceWith('<div class="clip-btn">copied!');
					}
			});
		});
	</script>
</html>
<!-- END OF _layouts/default.html -->
