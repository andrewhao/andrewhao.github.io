
<!doctype html>
<!-- START OF _layouts/default.html -->
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible" >
		<meta content="width=device-width,initial-scale=1" name="viewport">
		<meta content="Andrew Hao's thoughts on software engineering, team leadership & product design." name="description">
		<meta content="The Sweet Spot" name="author">

		<title>The Sweet Spot</title>

		<!-- Styles -->
		<link href="/stylesheets/main.css" rel="stylesheet">

		<!-- Google webfonts -->
    <link href="https://fonts.googleapis.com/css?family=Cousine|Suez+One|Yellowtail|Space+Mono|Alike+Angular" rel="stylesheet">

		<!-- jQuery and plugins -->
		<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
		<script src="/js/jquery.zclip.min.js"></script>

		<!-- Syntax highlighter -->
		<link href="/stylesheets/prettify-hemisu.css" type="text/css" rel="stylesheet" />
    <script type="text/javascript" src="/js/prettify.js"></script>

    <link href="/atom.xml" rel="alternate" title="The Sweet Spot" type="application/atom+xml">
    
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-2330913-9']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>



  </head>

	<body onload="prettyPrint()">
		<div class="wrap">

			<header>
        <a href="/"><div class="title">The Sweet Spot</div></a>
				<div class="subtitle">On software, engineering leadership, and anything shiny.</div>

				<div class="navi">
					<ul>
						<li><a href="/blog/archives">Articles</a></li>
						<li><a href="/talks">Talks</a></li>
						<li><a href="/notes">Conference Notes</a></li>
						<li><a href="https://www.github.com/andrewhao">Github</a></li>
						<li><a href="https://twitter.com/andrewhao">Twitter</a></li>
					</ul>
				</div> <!-- // .navi -->
			</header>

				<!-- START OF index.html -->

	
		
		<!-- START OF _includes/article.html -->
<article>
	<header>
		<h1><a href="/2016/04/18/the-joy-of-naming-with-the-powers-of-domain-driven-design/">Domain-Driven Design & The Joy of Naming</a></h1>
		<time>18 April 2016</time>
	</header>
		<div class="content">
			<p>I want to discuss a topic near and dear to my heart, and what I believe is at the crux of effective software design. It’s not a new functional language, it’s not a fancy new framework, a how-to guide to do microservices, nor a quantum leap in the field of machine learning.</p>

<p>It’s much simpler.</p>

<p>It’s about names.</p>

<p><img src="http://3.bp.blogspot.com/_rL73HKlqbH0/TKhVHMbs2oI/AAAAAAAABEc/DiPbblM0R44/s1600/sistine-chapel-michelangelo-paintings-6.jpg" alt="In the beginning..." /></p>

<p><em>Names define us</em>. They define concepts. They imbue a concept with shared understanding. They’re language concepts, but more than that, they’re units of meaning.</p>

<p>Software development is a fundamentally human endeavour. No amount of technical computing breakthroughs will change the fact that software development is still the arduous task of getting a team together full of humans from a kaleidescope of different cultural, linguistic backgrounds - then throwing them together to build an arbitrarily complex product in a rapidly-shifting competitive landscape.</p>

<p>Not only that, the thing to build is chock-full of systems that interact with other systems of unbounded complexity. Additionally, once your software system is out in the wild, you need to make sure that it was the right thing to build. Is the product you built correctly tuned to your market? Is it generating sufficient revenue?</p>

<p>The landscape is littered with software projects that began ambitiously, but got lost in a towering mess of fragile code. It’s no wonder that developing reliable, successful software is more art than science.</p>

<h3 id="crossing-our-linguistic-wires">Crossing our linguistic wires</h3>

<p>Let’s rewind back to a scene from a typical day in the life of your software development team. Think back to the last time you discussed a story with your product owner, how did it unfold?</p>

<p>Let’s imagine a scene at Delorean, the Uber for time travel, where you work. Your team is responsible for writing software systems that calculate the payment processing for your users who are hailing rides from your company’s time-traveling ridesharing service.</p>

<blockquote>
  <p>PO: Our next big project is to update our driver app to show rider locations on the timeline map.</p>
</blockquote>

<blockquote>
  <p>You: And when do these riders show up on the timeline map?</p>
</blockquote>

<blockquote>
  <p>PO: When the driver turns on the app and signals that she’s driving.</p>
</blockquote>

<blockquote>
  <p>You: OK, so that means when the app boots up and the DriverStatus service receives a POST we’ll need to simultaneously fetch references from the HailingUser service based on time locality.</p>
</blockquote>

<blockquote>
  <p>PO: Um… I guess so?</p>
</blockquote>

<p>Or how about your last iteration planning meeting, where you discussed the intricacies of a specific story?</p>

<blockquote>
  <p>PO: In this story, we’re going to add a coupon box to the checkout flow.</p>
</blockquote>

<blockquote>
  <p>You: [Thinking out loud] Hm… would that mean we add a <code>/coupon</code> route to the checkout API?</p>
</blockquote>

<blockquote>
  <p>Teammate: Wait - I think we call them <code>Discounts</code> in the backend. And the checkout flow is technically part of the <code>RideCommerce</code> service.</p>
</blockquote>

<blockquote>
  <p>You: Right - I mean let’s call the route <code>/coupon</code> but it’ll create a <code>Discount</code> object. And in this story,    let’s just remember that the checkout API really refers to the <code>RideCommerce</code> service.</p>
</blockquote>

<blockquote>
  <p>PO: I’ll add a note to the story.</p>
</blockquote>

<p>The implementing engineer, of course, doesn’t read the note in the story (who has time to, anyways?). In the course of implementation, he gets tripped up in semantics and spends the better part of a half day re-implementing the <code>Checkout</code> flow as an entirely new service, before realizing his mistake in code review and backing out his changes.</p>

<p>Months later, a new colleague is tasked to fix the link in the checkout flow, but files an incomplete fix because she was not aware of the fact that <code>Coupons</code> actually had mappings back to <code>Discounts</code>. The bug makes its way to production, where it subtly lies dormant until a most inopportune time…</p>

<h3 id="a-better-domain-driven-way">A better, Domain-Driven way</h3>

<p>In Eric Evans’ book <a href="http://www.amazon.com/Domain-Driven-Design-Tackling-Complexity-Software/dp/0321125215"><strong>Domain-Driven Design</strong></a>, he describes the concept of a <a href="http://martinfowler.com/bliki/UbiquitousLanguage.html">Ubiquitous Language</a> - a shared, common vocabulary that the entire team shares when discussing software.</p>

<p>When we say the “entire team”, we mean the combined team of designers, developers, the product owner and any other domain experts that might be at hand.</p>

<p>Your product owner may be your domain expert (and typically is). However, you may have other domain experts such as:</p>

<ul>
  <li>Any team that builds reporting or analytics off of your software.</li>
  <li>Upstream data providers</li>
  <li>Anybody further up the reporting chain whose purview includes the software you’re building, or its effects. Think: the Director of Finance, the COO, the head of Customer Support.</li>
  <li>The users of your software</li>
</ul>

<p>Side note: in XP, each team has an “onsite customer” - this is your domain expert!</p>

<h4 id="developing-a-ubiquitous-language-with-a-glossary">Developing a Ubiquitous Language with a Glossary</h4>

<p>Try this: keep a living document of all the terminology your team uses - along with all its definitions. This <strong>Glossary</strong> is exactly what it sounds - a list of terms and their definitions.</p>

<blockquote>
  <h2 id="delorean-team-glossary">Delorean Team Glossary</h2>

  <ul>
    <li><strong>Coupon</strong>: an applied discount to a BookingAmount. A coupon may take the form of a Fixed or a Percentage amount.
      <ul>
        <li><strong>Fixed-type</strong>: A coupon that applies a fixed amount of money - e.g. a $30 USD discount.</li>
        <li><strong>Percentage-type</strong>: A coupon that applies a percentage savings off the total BookingAmount.</li>
      </ul>
    </li>
    <li><strong>Driver</strong>: An employed driver who drives within the system, picking up passengers and driving Trips for payment.</li>
    <li><strong>Trip</strong>: An itinerary of passenger pick-up and drop-off location and times.</li>
    <li><strong>Rider</strong>: The passenger that books the trip and is transported by the <em>Driver</em>.</li>
    <li><strong>Booking</strong>: A reservation for a Trip, as booked by the <em>Rider</em>.</li>
    <li><strong>BookingAmount</strong>: The monetary amount of the Trip, accounting for the trip cost, surge pricing, coupons and taxes.</li>
    <li><strong>Routing Engine:</strong> The software system that maps out the driving directions for a driver.</li>
    <li><strong>Payment</strong>: A record of how a user paid.</li>
    <li><strong>Charge</strong>: A financial transaction for a specific dollar amount, for a specific charge method to an institution.</li>
    <li><strong>Checkout</strong>: A workflow in which a <em>Payment</em> is made for a <em>Booking</em>.</li>
  </ul>
</blockquote>

<p>From now on, use only the term definitions listed here in your stories. Be explicit about how you use your language!</p>

<p>I’ve been on many projects where the sloppy usage of a term from project inception led to the usage of that term in the code - codifying that messy, slippery term throughout the life of the project.</p>

<p>Which leads us to our next point:</p>

<h4 id="refactoring-your-team-to-use-the-right-terms">Refactoring your team to use the right terms</h4>

<p>Your <strong>Glossary</strong> is a living document. It is meant to be living - either on a continually-updated Google Doc or a wiki page. It should be visible for all to see - you should print it out and post it on the walls!</p>

<p>Meanwhile, in a planning meeting:</p>

<blockquote>
  <p>You: So when a user logs into the app and broadcasts that they’re ready to drive…</p>
</blockquote>

<blockquote>
  <p>PO: You mean <em>Driver</em>. When a <em>Driver</em> logs in.</p>
</blockquote>

<blockquote>
  <p>You: Right. Good catch.</p>
</blockquote>

<p>It seems a little silly (after all, you both know only Drivers use the broadcast feature of the app), but the laser focus on using the right words means that your team is always on the same page when talking about things.</p>

<p>Later that afternoon, your teammate taps you on the shoulder:</p>

<blockquote>
  <p>Teammate: I’m about to implement the Coupon story. I suggest we rename the <code>Discount</code> class to <code>Coupon</code>.</p>
</blockquote>

<blockquote>
  <p>You: Great idea. That way, we aren’t tripped up by the naming mismatches in the future.</p>
</blockquote>

<blockquote>
  <p>Teammate: I do have a question about the coupon, though. Do you think it’s <em>applied</em> to the <strong>BookingAmount</strong>, or is it <em>added</em>?</p>
</blockquote>

<blockquote>
  <p>PO: [Overhearing conversation] You had it right. It’s <em>applied</em>.</p>
</blockquote>

<p>You and your teammate then go and update the glossary, scribbling an addendum on the wall (or updating your wiki):</p>

<blockquote>
  <h2 id="delorean-team-glossary-1">Delorean Team Glossary</h2>
  <ul>
    <li><strong>Coupon</strong>: … Coupons may be <em>applied</em> to BookingAmounts to discount the total cost of the booking.</li>
  </ul>
</blockquote>

<h4 id="refactoring-your-code-to-use-the-right-terms">Refactoring your code to use the right terms</h4>

<p>Your teammate and you then walk over to her desk; as a pair you proceed to refactor the existing account code. We’ll use Ruby for the sake of this example.</p>

<p>In the beginning, the code looks like this:</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="k">class</span> <span class="nc">Checkout</span>
</span><span class="line">  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">booking_amount</span><span class="p">,</span> <span class="n">discount</span><span class="p">)</span>
</span><span class="line">    <span class="vi">@booking_amount</span> <span class="o">=</span> <span class="n">booking_amount</span>
</span><span class="line">    <span class="vi">@discount</span> <span class="o">=</span> <span class="n">discount</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">total</span>
</span><span class="line">    <span class="vi">@booking_amount</span><span class="o">.</span><span class="n">total</span> <span class="o">-</span> <span class="vi">@discount</span><span class="o">.</span><span class="n">calculate_amount_for</span><span class="p">(</span><span class="ss">booking_amount</span><span class="p">:</span> <span class="n">booking_amount</span><span class="p">)</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">Discount</span>
</span><span class="line">  <span class="no">STRATEGY_FIXED</span> <span class="o">=</span> <span class="s1">&#39;STRATEGY_FIXED&#39;</span>
</span><span class="line">  <span class="no">STRATEGY_PERCENTAGE</span> <span class="o">=</span> <span class="s1">&#39;STRATEGY_PERCENTAGE&#39;</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="n">strategy</span><span class="p">)</span>
</span><span class="line">    <span class="vi">@amount</span> <span class="o">=</span> <span class="n">amount</span>
</span><span class="line">    <span class="vi">@strategy</span> <span class="o">=</span> <span class="n">strategy</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">calculate_amount_for</span><span class="p">(</span><span class="ss">booking_amount</span><span class="p">:)</span>
</span><span class="line">    <span class="c1"># Implementation...</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>You take a first pass and rename the <code>Discount</code> class to <code>Coupon</code>.</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="k">class</span> <span class="nc">Coupon</span>
</span><span class="line">  <span class="no">STRATEGY_FIXED</span> <span class="o">=</span> <span class="s1">&#39;STRATEGY_FIXED&#39;</span>
</span><span class="line">  <span class="no">STRATEGY_PERCENTAGE</span> <span class="o">=</span> <span class="s1">&#39;STRATEGY_PERCENTAGE&#39;</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="n">strategy</span><span class="p">)</span>
</span><span class="line">    <span class="vi">@amount</span> <span class="o">=</span> <span class="n">amount</span>
</span><span class="line">    <span class="vi">@strategy</span> <span class="o">=</span> <span class="n">strategy</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">calculate_amount_for</span><span class="p">(</span><span class="ss">booking_amount</span><span class="p">:)</span>
</span><span class="line">    <span class="c1"># Implementation...</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Now there’s something funny here - your domain language suggests that a <strong>Coupon</strong> is <em>applied to</em> a <strong>BookingAmount</strong>. You pause, because the code reads the opposite - “A Coupon calculates its amount for a BookingAmount”.</p>

<blockquote>
  <p>You: How about we also refactor the <code>calculate_amount_for</code> method to reflect the language a little better?</p>
</blockquote>

<blockquote>
  <p>Teammate: Yeah. It sounds like the action occurs the other way - the BookingAmount is responsible for applying a Coupon to itself.</p>
</blockquote>

<p>In your next refactoring pass, you move the <code>calculate_amount_for</code> method into the <code>BookingAmount</code>, calling it <code>applied_discount_total</code>:</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="k">class</span> <span class="nc">BookingAmount</span>
</span><span class="line">  <span class="c1"># implementation details...</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">applied_coupon_amount</span><span class="p">(</span><span class="ss">coupon</span><span class="p">:)</span>
</span><span class="line">    <span class="c1"># Implementation...</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>Finally, you change your <code>Checkout</code> implementation to match:</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="k">class</span> <span class="nc">Checkout</span>
</span><span class="line">  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">booking_amount</span><span class="p">,</span> <span class="n">coupon</span><span class="p">)</span>
</span><span class="line">    <span class="vi">@booking_amount</span> <span class="o">=</span> <span class="n">booking_amount</span>
</span><span class="line">    <span class="vi">@coupon</span> <span class="o">=</span> <span class="n">coupon</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">total_amount</span>
</span><span class="line">    <span class="vi">@booking_amount</span><span class="o">.</span><span class="n">price</span> <span class="o">-</span> <span class="vi">@booking_amount</span><span class="o">.</span><span class="n">applied_coupon_amount</span><span class="p">(</span><span class="ss">coupon</span><span class="p">:</span> <span class="vi">@coupon</span><span class="p">)</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>When you read the implementation in plain English, it reads:</p>

<blockquote>
  <p>The checkout’s total amount is calculated by subtracting the booking amount’s applied coupon amount from the booking amount price.</p>
</blockquote>

<p>Phew! Designing a strong <strong>Ubiquitous Language</strong> was hard work! In fact, you had spent a goodly amount of time debating and clarifying with your domain experts:</p>

<ul>
  <li>Is a Coupon <em>applied</em> to a BookingAmount, or is it <em>discounted from</em> one?</li>
  <li>Should we call it a Coupon <em>amount</em>, or a Coupon <em>cost</em>?</li>
  <li>Is the pre-tax, pre-discount amount in the BookingAmount called a <em>price</em>, or a <em>cost</em>?</li>
</ul>

<p>Whatever you agreed on, that’s what you changed your code to reflect.</p>

<h4 id="continual-refinement">Continual refinement</h4>

<p>Hm. Something still feels off.</p>

<p>You and your teammate feel your OOP spidey senses going haywire.</p>

<blockquote>
  <p>Teammate: Hm. I guess that worked, but that’s still not exactly as clean as we wanted it. Isn’t it kind of weird how the Checkout owns the calculation for the calculation of a discount?</p>
</blockquote>

<blockquote>
  <p>You: Yeah, I see where you’re coming from. That’s just not good OO design. Additionally, if we notice the language our domain experts were using, they didn’t mention that the checkout total was some subtraction of something from another thing. The Checkout’s total simply is the order amount, after application of a Coupon.</p>
</blockquote>

<p>Your partner and you take one last step:</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="k">class</span> <span class="nc">Checkout</span>
</span><span class="line">  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">booking_amount</span><span class="p">,</span> <span class="n">coupon</span><span class="p">)</span>
</span><span class="line">    <span class="vi">@booking_amount</span> <span class="o">=</span> <span class="n">booking_amount</span>
</span><span class="line">    <span class="vi">@booking_amount</span><span class="o">.</span><span class="n">apply!</span><span class="p">(</span><span class="n">coupon</span><span class="p">)</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">total_amount</span>
</span><span class="line">    <span class="vi">@booking_amount</span><span class="o">.</span><span class="n">amount</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">BookingAmount</span>
</span><span class="line">  <span class="c1"># Implementation...</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">apply!</span><span class="p">(</span><span class="n">coupon</span><span class="p">)</span>
</span><span class="line">    <span class="vi">@coupons</span> <span class="o">+=</span> <span class="n">coupon</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">amount</span>
</span><span class="line">    <span class="vi">@amount</span> <span class="o">-</span> <span class="vi">@coupons</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:amount</span><span class="p">)</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>

<p>You sit back and read it back, out loud:</p>

<blockquote>
  <p>The checkout’s total amount is the BookingAmount after a Coupon has been applied.</p>
</blockquote>

<p>You both smile. Much better.</p>

<h3 id="in-closing">In closing…</h3>

<p>In this brief time we had together,</p>

<ul>
  <li>We discussed why names are important - especially in a complex endeavour like software development.</li>
  <li>We covered why it’s important to arrive at a shared understanding, together as a team, using the same words and vocabulary.</li>
  <li>We discovered how to build and integrate a <strong>Glossary</strong> into the daily rhythm of our team</li>
  <li>We refactored the code twice - illustrating how to get code in line with the domain language.</li>
</ul>

<h3 id="and-there-is-much-more">And there is much more!</h3>

<p>In an upcoming post, we’ll investigate how the <strong>Ubiquitous Language</strong> applies to a core concept of Domain-Driven Design: the <strong>Bounded Context</strong>. Why is that important? Because Bounded Contexts give us tools to organize our code - and to do further advanced things like <a href="https://speakerdeck.com/andrewhao/ddd-rail-your-monorail">break up monoliths into services</a>.</p>

<script async="" class="speakerdeck-embed" data-id="1e6dd8983891467381036a321cd274a9" data-ratio="1.77777777777778" src="//speakerdeck.com/assets/embed.js"></script>


			
			
		</div>
	<footer>
		


		



  
		
			Tagged under
		
    <a class='category' href='/category/architecture/'>architecture</a>, <a class='category' href='/category/ddd/'>ddd</a>, <a class='category' href='/category/domain-driven-design/'>domain-driven design</a>
	


	
	
	</footer>
	
</article>
<!-- END OF _includes/article.html -->

	
		
		<!-- START OF _includes/article.html -->
<article>
	<header>
		<h1><a href="/2016/04/08/knex-dot-js-and-bookshelf-dot-js-cheat-sheet/">Knex.js and PostGIS cheat sheet</a></h1>
		<time>08 April 2016</time>
	</header>
		<div class="content">
			<p>As follows are some code snippets for using <a href="http://knexjs.org/">Knex.js</a> for executing Postgres and PostGIS queries.</p>

<h3 id="execute-raw-sql-in-migration">Execute raw SQL in migration</h3>

<p>I often find this useful for fancy SQL, like creating views.</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="js"><span class="line"><span class="nx">exports</span><span class="p">.</span><span class="nx">up</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">knex</span><span class="p">,</span> <span class="nx">Promise</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">  <span class="k">return</span> <span class="nx">knex</span><span class="p">.</span><span class="nx">raw</span><span class="p">(</span><span class="err">`</span><span class="nx">YOUR</span> <span class="nx">RAW</span> <span class="nx">SQL</span><span class="err">`</span><span class="p">);</span>
</span><span class="line"><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>

<h3 id="add-a-postgis-point-type-to-a-table-in-a-migration">Add a PostGIS Point type to a table in a migration:</h3>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="js"><span class="line"><span class="k">return</span> <span class="nx">knex</span><span class="p">.</span><span class="nx">schema</span><span class="p">.</span><span class="nx">table</span><span class="p">(</span><span class="s1">&#39;events&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">table</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">  <span class="nx">table</span><span class="p">.</span><span class="nx">specificType</span><span class="p">(</span><span class="s1">&#39;point&#39;</span><span class="p">,</span> <span class="s1">&#39;geometry(point, 4326)&#39;</span><span class="p">);</span>
</span><span class="line"><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>

<h3 id="add-a-foreign-key-to-another-table">Add a foreign key to another table.</h3>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="js"><span class="line"><span class="k">return</span> <span class="nx">knex</span><span class="p">.</span><span class="nx">schema</span><span class="p">.</span><span class="nx">table</span><span class="p">(</span><span class="s1">&#39;events&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">table</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">	<span class="nx">table</span><span class="p">.</span><span class="nx">integer</span><span class="p">(</span><span class="s1">&#39;device_id&#39;</span><span class="p">).</span><span class="nx">references</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">).</span><span class="nx">inTable</span><span class="p">(</span><span class="s1">&#39;devices&#39;</span><span class="p">);</span>
</span><span class="line"><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>

<h3 id="add-a-multi-column-unique-index">Add a multi-column unique index</h3>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="js"><span class="line"><span class="k">return</span> <span class="nx">knex</span><span class="p">.</span><span class="nx">schema</span><span class="p">.</span><span class="nx">table</span><span class="p">(</span><span class="s1">&#39;events&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">table</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">  <span class="nx">table</span><span class="p">.</span><span class="nx">unique</span><span class="p">([</span><span class="s1">&#39;start_time&#39;</span><span class="p">,</span> <span class="s1">&#39;end_time&#39;</span><span class="p">,</span> <span class="s1">&#39;start_location&#39;</span><span class="p">,</span> <span class="s1">&#39;end_location&#39;</span><span class="p">,</span> <span class="s1">&#39;distance_miles&#39;</span><span class="p">]);</span>
</span><span class="line"><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>

<h3 id="find-a-collection">Find a collection</h3>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="js"><span class="line"><span class="nx">knex</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">)</span>
</span><span class="line"><span class="p">.</span><span class="nx">from</span><span class="p">(</span><span class="s1">&#39;participants&#39;</span><span class="p">)</span>
</span><span class="line"><span class="p">.</span><span class="nx">where</span><span class="p">({</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Jason&#39;</span> <span class="p">})</span>
</span><span class="line"><span class="p">.</span><span class="nx">andWhere</span><span class="p">(</span><span class="s1">&#39;age&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;=&#39;</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>

<h3 id="custom-operations-in-select-clause">Custom operations in SELECT clause</h3>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="js"><span class="line"><span class="nx">knex</span><span class="p">(</span><span class="s1">&#39;trips&#39;</span><span class="p">)</span>
</span><span class="line"><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="nx">knex</span><span class="p">.</span><span class="nx">raw</span><span class="p">(</span><span class="s1">&#39;miles * passengers as passenger_miles&#39;</span><span class="p">))</span>
</span><span class="line"><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="nx">knex</span><span class="p">.</span><span class="nx">raw</span><span class="p">(</span><span class="s2">&quot;CONCAT(&#39;Hello, &#39;, name) as greeting_message&quot;</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>

<h3 id="return-postgis-data-from-a-spatial-column">Return PostGIS data from a spatial column:</h3>

<p>We use <a href="https://github.com/jfgodoy/knex-postgis">knex-postgis</a> to gain access to PostGIS functions in Postgres. Here, we return a ‘point’ column with <code>ST_AsGeoJSON</code>:</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="js"><span class="line"><span class="kr">const</span> <span class="nx">knexPostgis</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;knex-postgis&#39;</span><span class="p">)(</span><span class="nx">knex</span><span class="p">);</span>
</span><span class="line"><span class="nx">knex</span><span class="p">(</span><span class="s1">&#39;events&#39;</span><span class="p">).</span><span class="nx">select</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="nx">knexPostgis</span><span class="p">.</span><span class="nx">asGeoJSON</span><span class="p">(</span><span class="s1">&#39;point&#39;</span><span class="p">));</span>
</span></code></pre></td></tr></table></div></figure>

<p>See <a href="https://github.com/jfgodoy/knex-postgis">knex-postgis</a> documentation for a list of other PostGIS functions that are supported.</p>

			
			
		</div>
	<footer>
		


		



  
		
			Tagged under
		
    <a class='category' href='/category/javascript/'>javascript</a>, <a class='category' href='/category/knex-dot-js/'>knex.js</a>, <a class='category' href='/category/postgis/'>postgis</a>
	


	
	
	</footer>
	
</article>
<!-- END OF _includes/article.html -->

	
		
		<!-- START OF _includes/article.html -->
<article>
	<header>
		<h1><a href="/2016/03/21/lossless-rate-limiting-with-rxjs/">Lossless rate limiting with RxJS</a></h1>
		<time>21 March 2016</time>
	</header>
		<div class="content">
			<p>Much of RxJS involves working with <a href="http://reactivex.io/documentation/operators/backpressure.html">backpressure</a> - how to reconcile streams that emit/process data at different rates, without overloading the system. Much of that model is built with lossy handling in mind - it makes sense that when your system is under duress, that you design your streams to degrade gracefully (e.g. drop certain events, or rate limit them by chunking into windows, etc).</p>

<p>However, there are times when it is appropriate to have a lossless approach to backpressure - e.g., to store every chunk of data that comes through a stream in memory, and not drop things. These use cases may come about when:</p>

<ul>
  <li>You have a short-lived, or bounded set of data you know will come over the pipe. You understand the bounds of the data that will ever come over the pipe.</li>
  <li>You have a processing script you want to run, which is not part of a large system.</li>
  <li>You have a honkin’ large system that can handle the load.</li>
</ul>

<p>In my case, I had a script that called the Google Geocoding API for a set of GPS coordinates. Now for a set of several hundred coordinates, I would end up calling the API several hundred times all at once with this naive implementation:</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="javascript"><span class="line"><span class="c1">// address$: [ &quot;1234 Widget Way, Promiseland, WV&quot; ] -- [...] -- [...]</span>
</span><span class="line"><span class="kr">const</span> <span class="nx">geocoded$</span> <span class="o">=</span> <span class="nx">addresses$</span>
</span><span class="line"><span class="p">.</span><span class="nx">flatMap</span><span class="p">(</span><span class="nx">address</span> <span class="o">=&gt;</span> <span class="nx">Rx</span><span class="p">.</span><span class="nx">Observable</span><span class="p">.</span><span class="nx">fromPromise</span><span class="p">(</span><span class="nx">callGoogleGeocodingService</span><span class="p">(</span><span class="nx">address</span><span class="p">)))</span>
</span><span class="line"><span class="c1">// geocoded$: [ { latitude: 89.99, longitude: 90.00, ... } ] -- [...] -- [...]</span>
</span></code></pre></td></tr></table></div></figure>

<p>I searched all over for a lossless throttling mechanism, but all I could find was references to RxJS’s lossy <a href="">throttle</a> behavior.</p>

<p>Other frameworks, like <a href="https://github.com/baconjs/bacon.js/#observable-bufferingthrottle">Bacon.js’s bufferingThrottle()</a> and <a href="http://highlandjs.org/#ratelimit">Highland.js ratelimit()</a> seemed attractive. Where was RxJS’s equivalent?</p>

<p>Thanks to a <a href="http://stackoverflow.com/questions/34955842/rate-limiting-http-calls-made-by-rxjs">helpful StackOverflow post</a>, I found the answer: the use of <a href="https://github.com/Reactive-Extensions/RxJS/blob/master/doc/api/core/operators/concatmap.md">concatMap()</a> and <a href="https://github.com/Reactive-Extensions/RxJS/blob/master/doc/api/core/operators/delay.md">delay()</a> forces the incoming stream to execute serially over artificial time delayed streams.</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="javascript"><span class="line"><span class="kr">const</span> <span class="nx">geocoded$</span> <span class="o">=</span> <span class="nx">addresses$</span>
</span><span class="line"><span class="p">.</span><span class="nx">concatMap</span><span class="p">(</span><span class="nx">address</span> <span class="o">=&gt;</span> <span class="nx">Rx</span><span class="p">.</span><span class="nx">Observable</span><span class="p">.</span><span class="nx">just</span><span class="p">(</span><span class="nx">address</span><span class="p">).</span><span class="nx">delay</span><span class="p">(</span><span class="nx">TIME_INTERVAL</span><span class="p">))</span>
</span><span class="line"><span class="p">.</span><span class="nx">flatMap</span><span class="p">(</span><span class="nx">address</span> <span class="o">=&gt;</span> <span class="nx">Rx</span><span class="p">.</span><span class="nx">Observable</span><span class="p">.</span><span class="nx">fromPromise</span><span class="p">(</span><span class="nx">callGoogleGeocodingService</span><span class="p">(</span><span class="nx">address</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>

<p>Thanks to:</p>

<ul>
  <li>http://stackoverflow.com/questions/34955842/rate-limiting-http-calls-made-by-rxjs</li>
  <li>http://stackoverflow.com/questions/30876361/rxjs-rate-limit-requests-per-second-and-concurrency?rq=1</li>
</ul>

			
			
		</div>
	<footer>
		


		



  
		
			Tagged under
		
    <a class='category' href='/category/frp/'>frp</a>, <a class='category' href='/category/rate-limiting/'>rate limiting</a>, <a class='category' href='/category/reactive-programming/'>reactive programming</a>, <a class='category' href='/category/rxjs/'>rxjs</a>
	


	
	
	</footer>
	
</article>
<!-- END OF _includes/article.html -->

	
		
		<!-- START OF _includes/article.html -->
<article>
	<header>
		<h1><a href="/2016/02/17/partitioning-rxjs-streams-adventures-in-nested-observables-with-groupby-and-flatmap/">Partitioning RxJS streams: adventures in nested Observables with groupBy() and flatMap()</a></h1>
		<time>17 February 2016</time>
	</header>
		<div class="content">
			<p>One of the confusing aspects about working with streams is diving into Rx operators that take a stream and fan out into multiple streams.</p>

<p>Is your head exploding yet?</p>

<h2 id="the-problem">The problem:</h2>

<p>Let’s dive into a problem I ran into while working on a personal project:</p>

<p>The task at hand is to take a list of GPS moving point data and partition the group data into multiple clusters of points, count up each group, then return the aggregate stats. As a cyclist is moving, I want to know how often they are moving at that specific velocity (speed).</p>

<p>Our weapon of choice is the <a href="http://reactivex.io/documentation/operators/groupby.html">RxJS groupBy() function</a>, which groups like stream values based on a key value you define.</p>

<p><a href="http://reactivex.io/documentation/operators/groupby.html"><img src="http://reactivex.io/documentation/operators/images/groupBy.c.png" alt="Image of groupBy() at work, with marbles." /></a></p>

<p>OK. Easy enough. So my implementation looked something like this:</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="js"><span class="line"><span class="nx">gpsPointStream</span>
</span><span class="line"><span class="p">.</span><span class="nx">groupBy</span><span class="p">((</span><span class="nx">point</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">point</span><span class="p">.</span><span class="nx">velocity</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>

<p>The supplied <code>(point) =&gt; point.velocity</code> function determines the <code>key</code> value for the supplied event, which then 1) creates a new Observable sequence for that specific <code>key</code> value, if it doesn’t exist, or 2) assigns your event to an existing Observable sequence.</p>

<p>Let’s illustrate:</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="js"><span class="line"><span class="nx">src</span><span class="o">:</span>     <span class="o">--</span> <span class="p">{</span> <span class="nx">velocity</span><span class="o">:</span> <span class="mi">0</span> <span class="p">}</span> <span class="o">----------</span> <span class="p">{</span> <span class="nx">velocity</span><span class="o">:</span> <span class="mf">0.1</span> <span class="p">}</span> <span class="o">-----------------------------------</span> <span class="p">{</span> <span class="nx">velocity</span><span class="o">:</span> <span class="mi">0</span> <span class="p">}</span> <span class="o">--&gt;</span>
</span><span class="line"><span class="nx">groupBy</span><span class="o">:</span> <span class="o">--</span> <span class="p">[{</span> <span class="nx">Observable</span> <span class="nx">key</span><span class="o">:</span> <span class="mi">0</span> <span class="p">}]</span> <span class="o">--</span> <span class="p">[</span> <span class="p">{</span> <span class="nx">Observable</span> <span class="nx">key</span><span class="o">:</span> <span class="mi">0</span> <span class="p">},</span> <span class="p">{</span> <span class="nx">Observable</span> <span class="nx">key</span><span class="o">:</span> <span class="mf">0.1</span> <span class="p">}</span> <span class="p">]</span> <span class="o">--</span> <span class="p">[</span> <span class="p">{</span> <span class="nx">Observable</span> <span class="nx">key</span><span class="o">:</span> <span class="mi">0</span> <span class="nx">count</span><span class="o">:</span> <span class="mi">2</span> <span class="p">},</span> <span class="p">{</span> <span class="nx">Observable</span> <span class="nx">key</span><span class="o">:</span> <span class="mf">0.1</span> <span class="p">}</span> <span class="p">]</span> <span class="o">--&gt;</span>
</span></code></pre></td></tr></table></div></figure>

<h2 id="never-fear-flatmap-to-the-rescue">Never fear, <code>flatMap()</code> to the rescue.</h2>

<p>So the story turns to our hero <a href="http://reactivex.io/documentation/operators/flatmap.html"><code>flatMap()</code></a>, which as it turns out is specifically tuned to deal with issues of dealing with multiple streams.</p>

<p><a href="http://reactivex.io/documentation/operators/flatmap.html"><img src="http://reactivex.io/documentation/operators/images/flatMap.c.png" alt="Marble diagram for flatMap" /></a></p>

<p><code>flatMap</code> will take a supplied function as its argument, which is the operation to apply to each argument within the supplied stream.</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="js"><span class="line"><span class="nx">gpsPointStream</span>
</span><span class="line"><span class="p">.</span><span class="nx">groupBy</span><span class="p">((</span><span class="nx">point</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">point</span><span class="p">.</span><span class="nx">velocity</span><span class="p">)</span>
</span><span class="line"><span class="p">.</span><span class="nx">flatMap</span><span class="p">((</span><span class="nx">group</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class="line">  <span class="k">return</span> <span class="nx">group</span><span class="p">.</span><span class="nx">scan</span><span class="p">((</span><span class="nx">h</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">h</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span class="line">              <span class="p">.</span><span class="nx">zip</span><span class="p">(</span><span class="nx">Observable</span><span class="p">.</span><span class="nx">just</span><span class="p">(</span><span class="nx">group</span><span class="p">.</span><span class="nx">key</span><span class="p">))</span>
</span><span class="line"><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="js"><span class="line"><span class="nx">src</span><span class="o">:</span>     <span class="o">--</span> <span class="p">{</span> <span class="nx">velocity</span><span class="o">:</span> <span class="mi">0</span> <span class="p">}</span> <span class="o">----------</span> <span class="p">{</span> <span class="nx">velocity</span><span class="o">:</span> <span class="mf">0.1</span> <span class="p">}</span> <span class="o">-----------------------------------</span> <span class="p">{</span> <span class="nx">velocity</span><span class="o">:</span> <span class="mi">0</span> <span class="p">}</span> <span class="o">----&gt;</span>
</span><span class="line"><span class="nx">groupBy</span><span class="o">:</span> <span class="o">--</span> <span class="p">[{</span> <span class="nx">Observable</span> <span class="nx">key</span><span class="o">:</span> <span class="mi">0</span> <span class="p">}]</span> <span class="o">--</span> <span class="p">[</span> <span class="p">{</span> <span class="nx">Observable</span> <span class="nx">key</span><span class="o">:</span> <span class="mi">0</span> <span class="p">},</span> <span class="p">{</span> <span class="nx">Observable</span> <span class="nx">key</span><span class="o">:</span> <span class="mf">0.1</span> <span class="p">}</span> <span class="p">]</span> <span class="o">--</span> <span class="p">[</span> <span class="p">{</span> <span class="nx">Observable</span> <span class="nx">key</span><span class="o">:</span> <span class="mi">0</span> <span class="nx">count</span><span class="o">:</span> <span class="mi">2</span> <span class="p">},</span> <span class="p">{</span> <span class="nx">Observable</span> <span class="nx">key</span><span class="o">:</span> <span class="mf">0.1</span> <span class="p">}</span> <span class="p">]</span> <span class="o">--&gt;</span>
</span><span class="line"><span class="nx">flatMap</span><span class="o">:</span> <span class="o">--</span> <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">]</span> <span class="o">-----------------</span> <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.1</span> <span class="p">]</span> <span class="o">------------------------------------------</span> <span class="p">[</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span> <span class="p">]</span> <span class="o">--&gt;</span>
</span></code></pre></td></tr></table></div></figure>

<p>What just happened here?</p>

<p>I specified a merging function for the <code>flatMap()</code> stream, which performed the <code>scan()</code> counting aggregation on my group before merging the stream back into the main stream. I threw in a <code>zip</code>, which annotated my aggregate count value with a record of the group key (velocity) that this value was computed for.</p>

<h2 id="compare-it-to-imperative">Compare it to imperative</h2>

<p>The equivalent of <code>groupBy</code>/<code>flatMap</code> in imperative programming is, quite literally, just <code>_.groupBy()</code> and <code>_.flatMap()</code>. With a few key differences. Here it is in <a href="https://lodash.com/docs#groupBy">lodash</a>:</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="js"><span class="line"><span class="kd">var</span> <span class="nx">grouped</span> <span class="o">=</span> <span class="nx">_</span><span class="p">([</span> <span class="p">{</span> <span class="nx">velocity</span><span class="o">:</span> <span class="mi">0</span> <span class="p">},</span> <span class="p">{</span> <span class="nx">velocity</span><span class="o">:</span> <span class="mf">0.1</span> <span class="p">},</span> <span class="p">{</span> <span class="nx">velocity</span><span class="o">:</span> <span class="mi">0</span> <span class="p">}</span> <span class="p">])</span>
</span><span class="line"><span class="p">.</span><span class="nx">groupBy</span><span class="p">((</span><span class="nx">point</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">point</span><span class="p">.</span><span class="nx">velocity</span><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="nx">grouped</span><span class="p">.</span><span class="nx">value</span><span class="p">()</span>
</span><span class="line"><span class="c1">// { 0: [ { velocity: 0 }, { velocity: 0 } ], 0.1: [ { velocity: 0.1 } ] }</span>
</span><span class="line">
</span><span class="line"><span class="kd">var</span> <span class="nx">flatmapped</span> <span class="o">=</span> <span class="nx">grouped</span><span class="p">.</span><span class="nx">flatMap</span><span class="p">((</span><span class="nx">v</span><span class="p">,</span> <span class="nx">k</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class="line">  <span class="k">return</span> <span class="p">[</span> <span class="p">[</span><span class="nx">v</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">k</span><span class="p">]</span> <span class="p">]</span>
</span><span class="line">  <span class="p">})</span>
</span><span class="line">
</span><span class="line"><span class="nx">flatmapped</span><span class="p">.</span><span class="nx">value</span><span class="p">()</span>
</span><span class="line"><span class="c1">// [[2, &quot;0&quot;], [1, &quot;0.1&quot;]]</span>
</span></code></pre></td></tr></table></div></figure>

<p>So in the end, the end result was the same with one crucial difference - our Observable, reactive version was able to take intermediate accounts into time and perform an intermediate calculation as data was flowing in. This allowed us to generate an intermediate count for the “0” velocity group.</p>

<h2 id="takeaways">Takeaways</h2>

<ul>
  <li>When you want to fan out a stream into groups or partitions based on a specific stream value, turn to <a href="https://github.com/Reactive-Extensions/RxJS/blob/master/doc/api/core/operators/groupby.md"><code>groupBy</code></a>.</li>
  <li>When you have a need to combine a stream-of-streams, you want to look at <a href="https://github.com/Reactive-Extensions/RxJS/blob/master/doc/api/core/operators/selectmany.md"><code>flatMap</code></a>. You may also consider looking at <a href="https://github.com/Reactive-Extensions/RxJS/blob/master/doc/api/core/operators/concatmap.md"><code>concatMap</code></a>, a close cousin of <code>flatMap</code>.</li>
  <li>Reactive programming gives you more expressive abilities to reason about time and event ordering. You just have to tilt your head a little bit.</li>
</ul>

<h2 id="further-reading">Further reading:</h2>

<ul>
  <li>http://blogs.microsoft.co.il/iblogger/2015/08/11/animations-of-rx-operators-groupby/</li>
</ul>

<p><strong>Update: 2016/03/22</strong></p>

<p>Updated typo where the <code>index</code> variable on a GroupedObservable was changed to correctly be <code>key</code>.</p>

			
			
		</div>
	<footer>
		


		



  
		
			Tagged under
		
    <a class='category' href='/category/observables/'>observables</a>, <a class='category' href='/category/rxjs/'>rxjs</a>, <a class='category' href='/category/streams/'>streams</a>
	


	
	
	</footer>
	
</article>
<!-- END OF _includes/article.html -->

	
		
		<!-- START OF _includes/article.html -->
<article>
	<header>
		<h1><a href="/2015/09/27/strange-loop-2015-reflections/">Strange Loop 2015: Notes & Reflections</a></h1>
		<time>27 September 2015</time>
	</header>
		<div class="content">
			<p>Going to Strange Loop was a huge check off my conference bucket list (lanyard?). I’d always heard about this slightly-weird, highly academic collision between academia and industry, skewing toward programming languages you haven’t heard of (or, at the very least, you’ve never used in production). I anticipated sitting at the feet of gray-haired wizards and bright-eyed hipsters with Ph.Ds.</p>

<p>The conference did not disappoint. And it was not quite what I expected-I less sat at the feet of geniuses than I did talk with them, peer-to-peer, about topics of interest. All around me people were saying “Don’t be afraid to ask questions. Don’t feel stupid - nobody knows everything.” Speakers were tweeting about how much they were learning.  It was comforting, because lots of topics I had come to see were those in which I had no. freakin. clue. about.</p>

<p>The following is culled from my notes from different sessions I attended. I will focus on brevity. I will keep it clear. Here we go:</p>

<h3 id="opening-keynote-i-see-what-you-mean---peter-alvaro">Opening Keynote: “I see what you mean” - Peter Alvaro</h3>

<iframe width="560" height="315" src="https://www.youtube.com/embed/R2Aa4PivG0g" frameborder="0" allowfullscreen=""></iframe>

<ul>
  <li>Instructions, behaviors &amp; outcomes.</li>
  <li>It “feels good” to write in C (a hardcore 1000 liner)</li>
  <li>But a declarative program (e.g. SQL) works well, but is harder to come<br />
up with.</li>
  <li>The declarative world - as described in the work done in Datalog</li>
  <li>How can we take concepts from Datalog and apply to real-world<br />
resources like network actors (distributed systems)?</li>
  <li>It becomes easier to model these systems declaratively when we<br />
explicitly capture time.</li>
  <li>Enter Dedalus: extension to Datalog where time is a modeling<br />
construct.</li>
  <li>(Show off usage of <code>@next</code> and <code>@async</code> annotations</li>
  <li>Computation is redezvous - the only thing that you know is what YOU<br />
know at that point in time.</li>
  <li>Takeaway: Abstractions leak. Model them better (e.g. with time)</li>
  <li>Inventing languages is dope.</li>
</ul>

<h3 id="have-your-causality-and-your-wall-clocks-too-jon-moore">Have your Causality and your Wall Clocks Too (Jon Moore)</h3>

<iframe width="560" height="315" src="https://www.youtube.com/embed/YqNGbvFHoKM" frameborder="0" allowfullscreen=""></iframe>

<ul>
  <li>Take concept of Lamport clocks and extend them with hybrid clocks.</li>
  <li>And extend them one further with: Distributed Monotonic Clocks</li>
  <li>These DMCs use population protocol (flocking) to each actor in the<br />
system communicate with another, updating their source of truth to<br />
eventually agree on a media time w/in the group</li>
  <li>DMC components:
    <ol>
      <li>Have a reset button by adding epoch bit</li>
      <li>Use flocking (via population protocol) to avoid resets</li>
      <li>Accomodates for some clockless nodes</li>
      <li>Explicitly reflects causality</li>
    </ol>
  </li>
</ul>

<h3 id="building-isomorphic-web-apps-with-react---elyse-gordon">Building Isomorphic Web Apps with React - Elyse Gordon</h3>

<iframe width="560" height="315" src="https://www.youtube.com/embed/QPXNb6bl7hc" frameborder="0" allowfullscreen=""></iframe>

<ul>
  <li>Vevo needed better SEO for SPAs. Old soln was to snapshot page and upload to S3.</li>
  <li>Beneficial for SEO crawlers</li>
  <li>React in frontend. Node in backend.</li>
  <li>Vevo-developed <a href="">pellet</a> project as Flux-like framework to organize<br />
files.</li>
  <li>Webpack aliases/shims</li>
  <li>Server hands off to browser, bootstraps React in client.</li>
  <li>Alternatives: Relay, Ember</li>
</ul>

<h3 id="designing-for-the-worst-case-peter-bailis-pbailis">Designing for the Worst Case: Peter Bailis (@pbailis)</h3>

<iframe width="560" height="315" src="https://www.youtube.com/embed/ZGIAypUUwoQ" frameborder="0" allowfullscreen=""></iframe>

<ul>
  <li>Designing for worst case often penalizes average case</li>
  <li>But what if designing for the worst case actually helps avg case?</li>
  <li>Examples from dstbd systems:
    <ul>
      <li>Worst case of disconnected data centers, packet loss/link loss. Fix by introducing coordination-free protocols. Boom, you’ve now made your network more scalable, performant, resistent to downtime.</li>
      <li>Worst case: hard to coordinate a distributed transaction between services. What do you do? You implement something like buffered writes out of process.
        <ul>
          <li>CRDT, RAMP, HAT, bloom</li>
          <li>Suddenly, you have fault tolerance</li>
        </ul>
      </li>
      <li>Tail latency problem in microservices: the more microservices you query, the higher the probability of hitting a slow server response.
        <ul>
          <li>Your service’s corner case is your user’s average case</li>
        </ul>
      </li>
      <li>HCI: accessibility guidelines in W3C lift standards for all. Make webpages easier to navigate. Side effect of better page performance, higher conversion.</li>
      <li>Netflix designing CC subtitles also benefits other users.</li>
      <li>Curb cuts in the real world to help ADA/mobility-assisted folks also benefit normal folks too</li>
    </ul>
  </li>
  <li>Best has pitfalls too: your notion of best may be hard to hit, or risky. You may want to optimize for “stable” solution. (Robust optimization)</li>
  <li>When to design for worst case?
    <ul>
      <li>common corner cases</li>
      <li>environmental conditions vary</li>
      <li>“normal” isn’t normal</li>
    </ul>
  </li>
  <li>worst forces a conversation
    <ul>
      <li>how do we plan for failures?</li>
      <li>what is our scale-out strategy?</li>
      <li>how do we audit failures? data breaches?</li>
    </ul>
  </li>
</ul>

<h3 id="ideology-by-gary-bernardt">Ideology by Gary Bernardt</h3>

<ul>
  <li>Rumsfeld: known knowns, known unknowns, and unknown unknowns.</li>
  <li>Ideology is the thing you know you do not know you know</li>
  <li>Conflict between typed vs dynamic programmers:
    <ul>
      <li>Typed: “I don’t need tests, I have types”</li>
      <li>Dynamic: “I write tests, so I don’t need types”</li>
    </ul>
  </li>
  <li>In reality, they are solving different places in the problem domain, but they have different beliefs about the world that are hidden in the shadows:
    <ul>
      <li>Typed: “Correctness comes solely from types”</li>
      <li>Dynamic: “Correctness comes solely from example”</li>
    </ul>
  </li>
  <li>“I need nulls” -&gt; You believe nulls are the only way to represent absence</li>
  <li>“Immutable data structures are slow” -&gt; You believe all immutable types are slow</li>
  <li>“GC is impractical” -&gt; you believe GC algorithms won’t get faster.</li>
  <li>Read CSE 341 Type systems, Dan Grossman</li>
</ul>

<h3 id="building-scalable-stateful-services-caitlin-mccaffrey">Building Scalable, Stateful Services: Caitlin McCaffrey</h3>

<iframe width="560" height="315" src="https://www.youtube.com/embed/H0i_bXKwujQ" frameborder="0" allowfullscreen=""></iframe>

<h4 id="sticky-connection-always-talk-to-the-same-machine">Sticky connection: always talk to the same machine</h4>
<p>Building sticky connections:<br />
- persistent connections (load balancing cannot rebalance server)<br />
- implement backpressure (d/c connection)</p>

<h4 id="dynamic-cluster-membership">dynamic cluster membership</h4>

<ul>
  <li>gossip protocols -&gt; availability</li>
  <li>consensus systems -&gt; consistency<br />
(everybody needs to have the same worldview.</li>
</ul>

<h4 id="work-distribution">work distribution:</h4>

<h5 id="random">random:</h5>
<ul>
  <li>write anywhere, read from all</li>
</ul>

<h5 id="consistent-hashing-on-session-id">consistent hashing: on session ID</h5>

<p>hash space -&gt; node<br />
dynamoDB, Manhattan</p>

<p>con: can have hotspots, could have uneven distribution of resources cannot move work.</p>

<h4 id="distributed-hash-table">distributed hash table</h4>
<p>statefully store hash</p>

<h4 id="real-world">Real world</h4>
<p>Scuba (Facebook)<br />
- distributed in-memory DB</p>

<p>Ringpop (Uber)<br />
- Node.js swim gossip protocol, consistent hashing</p>

<p>Orleans (MS Research)<br />
- actor model<br />
- gossip<br />
- consistent hash<br />
- distributed hashtable</p>

<h3 id="idalin-abby-bob-from-protesting-to-programming-becoming-a-tech-activist">Idalin “Abby” Bobé: From Protesting to Programming: Becoming a Tech Activist</h3>

<iframe width="560" height="315" src="https://www.youtube.com/embed/gy82S8tjJX8" frameborder="0" allowfullscreen=""></iframe>

<ul>
  <li>Tech to resist exploitation</li>
  <li>Technologists as activists</li>
  <li>Idalin Bobé -&gt; Changed name to “Abby” to get a job.</li>
  <li>Pastor Jenkins - magnifying glass vs paper</li>
  <li>Philadelphia Partnership Program:
    <ul>
      <li>1st to college</li>
      <li>work &lt;&gt; school</li>
    </ul>
  </li>
  <li>Difficult to balance.</li>
  <li>Mills MBA, CS</li>
  <li>Joined Black Girls Code
    <ul>
      <li>Apply technology in the right way</li>
    </ul>
  </li>
  <li>Ferguson happened
    <ul>
      <li>Thoughtworkers joined on the ground</li>
      <li>Hands Up United: www.handsupunited.org</li>
    </ul>
  </li>
  <li>“Do not be led by digital metrics” - even though the activists had digital tooling, the tools were being used against activists. Phone calls, chats monitored. Movement tracked.</li>
  <li>New group starting up in St. Louis called “Ray Clark, Sr.” - named after a black man who played a strong role in the founding of Silicon Valley.</li>
  <li>21st century technologists need 21st century skillsets.</li>
  <li>Dream Defenders</li>
  <li>“it is our duty to fight for our freedom/it is our duty to win/we must love and support one another/we have nothing to lose but our chains”</li>
</ul>

			
			
		</div>
	<footer>
		


		



  
		
			Tagged under
		
    <a class='category' href='/category/conference/'>conference</a>, <a class='category' href='/category/distributed-systems/'>distributed systems</a>, <a class='category' href='/category/functional-programming/'>functional programming</a>, <a class='category' href='/category/software/'>software</a>, <a class='category' href='/category/strangeloop/'>strangeloop</a>
	


	
	
	</footer>
	
</article>
<!-- END OF _includes/article.html -->

	
	
<div class="pagination">
	
		<a class="older" href="/posts/3">Older</a>
	
	
	<span class="total">2 of 20</span>
	
	
		<a class="newer" href="/index.html">Newer</a>
	
</div>
<!-- END OF index.html -->


			<footer>
				Copyright &copy; 2018

	Andrew Hao


				

<script type="text/javascript">
      var disqus_shortname = 'g9labs';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





			</footer>

		</div> <!-- // .wrap -->
  </body>

	<script>
		$(document).ready(function() {
			// Make images center
			$('p:has(img)').css('text-align', 'center');

			// Add the image's title attribute as a caption
			$('p:has(img)').append(function () {
				return '<div class="caption">' + ($('img', this).attr('title') || "") + '</div>';
			});

			// Prettify code
			$('code').addClass('prettyprint');
			$('pre code').addClass('linenums');

			// Copy to clipboard with button
			$('pre:has(code)').prepend(function(){
				return '<div class="clip-btn">copy to clipboard</div>';
      });

			$('.clip-btn').zclip({
				path:'/js/ZeroClipboard.swf',
				copy: $(this).next('code').text(),
				afterCopy: function(){
					$(this).replaceWith('<div class="clip-btn">copied!');
					}
			});
		});
	</script>
</html>
<!-- END OF _layouts/default.html -->
